<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>Elemental Catalyst v1.4</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap"
    rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #030608;
      color: #d0dce8;
      font-family: 'Rajdhani', sans-serif;
      overflow: hidden;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .screen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .screen.hidden {
      display: none !important;
    }

    canvas {
      display: block;
      cursor: crosshair;
    }

    .gtitle {
      font-family: 'Cinzel', serif;
      font-size: clamp(26px, 4vw, 52px);
      font-weight: 900;
      background: linear-gradient(135deg, #ffa366, #f4c542, #b3e5fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 5px;
    }

    .gsub {
      font-size: 10px;
      color: #2a3a50;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ‚îÄ MAIN MENU ‚îÄ‚îÄ‚îÄ */
    #menu {
      background: radial-gradient(ellipse 130% 100% at 50% 60%, #0b1624 0%, #030608 100%);
    }

    .menu-btns {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    .mbtn {
      width: 280px;
      padding: 14px 32px;
      font-family: 'Cinzel', serif;
      font-size: 14px;
      letter-spacing: 3px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      transition: all .22s;
      background: transparent;
      border: 1px solid #1e2a38;
      color: #d0dce8;
    }

    .mbtn:hover {
      transform: translateY(-2px);
    }

    .mbtn.primary {
      background: linear-gradient(135deg, #f4c542, #ff8c00);
      color: #000;
      border: none;
    }

    .mbtn.primary:hover {
      box-shadow: 0 8px 28px rgba(244, 197, 66, .4);
    }

    .mbtn.blue {
      border-color: #42a5f544;
      color: #42a5f5;
    }

    .mbtn.blue:hover {
      background: #42a5f511;
      border-color: #42a5f5;
    }

    .mbtn.purple {
      border-color: #a855f744;
      color: #a855f7;
    }

    .mbtn.purple:hover {
      background: #a855f711;
      border-color: #a855f7;
    }

    /* ‚îÄ‚îÄ‚îÄ GAME DESCRIPTION BOX ‚îÄ‚îÄ‚îÄ */
    .game-desc {
      max-width: 520px;
      margin: 14px auto 8px;
      background: rgba(8, 18, 32, 0.85);
      border: 1px solid #1a2a3a;
      border-radius: 10px;
      padding: 14px 18px;
      text-align: left;
      font: 11px/1.65 'Rajdhani', sans-serif;
      color: #7a9ab0;
      backdrop-filter: blur(6px);
    }

    .game-desc h3 {
      margin: 0 0 6px 0;
      font: bold 13px 'Share Tech Mono', monospace;
      color: #f4c542;
      letter-spacing: 1px;
    }

    .game-desc .gd-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 14px;
      margin-top: 8px;
    }

    .game-desc .gd-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 10.5px;
      line-height: 1.45;
    }

    .game-desc .gd-item .gd-icon {
      font-size: 14px;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .game-desc .gd-item b {
      color: #c0d0e0;
    }

    /* ‚îÄ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ‚îÄ */
    #lobby {
      background: radial-gradient(ellipse at 50% 60%, #0c1828 0%, #030608 100%);
    }

    .lobby-box {
      background: #070f1a;
      border: 1px solid #1a2a3a;
      border-radius: 12px;
      padding: 28px 36px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 400px;
    }

    .lobby-title {
      font-family: 'Cinzel', serif;
      font-size: 16px;
      color: #f4c542;
      letter-spacing: 2px;
    }

    .room-code {
      font-family: 'Share Tech Mono', monospace;
      font-size: 36px;
      font-weight: 700;
      letter-spacing: 10px;
      color: #4fc3f7;
      text-align: center;
      padding: 12px;
      background: #040c16;
      border-radius: 8px;
      border: 1px solid #4fc3f744;
    }

    .lbl {
      font-size: 11px;
      color: #4a6375;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .inp {
      width: 100%;
      padding: 10px 14px;
      background: #040c16;
      border: 1px solid #1a2a3a;
      border-radius: 6px;
      color: #d0dce8;
      font-family: 'Share Tech Mono', monospace;
      font-size: 22px;
      letter-spacing: 8px;
      text-transform: uppercase;
      text-align: center;
      outline: none;
    }

    .inp:focus {
      border-color: #4fc3f7;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #2a3a4a;
      margin-right: 6px;
    }

    .status-dot.waiting {
      background: #f4c542;
      box-shadow: 0 0 8px #f4c542aa;
      animation: pulse2 1.2s infinite;
    }

    .status-dot.connected {
      background: #4ade80;
      box-shadow: 0 0 8px #4ade8088;
    }

    @keyframes pulse2 {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .4;
      }
    }

    .lobby-status {
      font-size: 12px;
      font-family: 'Share Tech Mono', monospace;
      color: #4a6375;
    }

    .divider {
      border: none;
      border-top: 1px solid #1a2a3a;
    }

    /* ‚îÄ‚îÄ‚îÄ LEVEL SELECT ‚îÄ‚îÄ‚îÄ */
    #levelselect {
      background: radial-gradient(ellipse at 50% 60%, #0a1620 0%, #030608 100%);
    }

    .levels-grid {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 780px;
    }

    .lcard {
      width: 105px;
      height: 130px;
      border-radius: 10px;
      background: #080f1a;
      border: 1.5px solid #1a2a3a;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all .2s;
      position: relative;
    }

    .lcard:hover {
      transform: translateY(-3px);
    }

    .lcard.locked {
      opacity: .3;
      cursor: not-allowed;
      pointer-events: none;
    }

    .lcard.completed {
      border-color: #4ade8066;
    }

    .lcard.current {
      border-color: #f4c54266;
    }

    .lem {
      font-size: 28px;
    }

    .lname {
      font-family: 'Cinzel', serif;
      font-size: 9px;
      letter-spacing: 1px;
      text-align: center;
      padding: 0 4px;
    }

    .ldiff {
      font-size: 8px;
      color: #3a5060;
    }

    .lbadge {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 11px;
    }

    /* ‚îÄ‚îÄ‚îÄ DRAFT ‚îÄ‚îÄ‚îÄ */
    #draft {
      background: radial-gradient(ellipse 130% 100% at 50% 60%, #0b1624 0%, #030608 100%);
    }

    .plabel {
      font-family: 'Cinzel', serif;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 2px;
      min-height: 24px;
      text-align: center;
    }

    .pstep {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: #4a6375;
      letter-spacing: 2px;
      text-align: center;
    }

    .cards {
      display: flex;
      gap: 14px;
    }

    .card {
      width: 112px;
      height: 152px;
      border-radius: 11px;
      background: #080f1a;
      border: 1.5px solid #1a2a3a;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all .2s;
    }

    .card:hover {
      transform: translateY(-4px);
    }

    .card.sel {
      transform: translateY(-4px) scale(1.06);
    }

    .card.dim {
      opacity: .2;
      pointer-events: none;
    }

    .cem {
      font-size: 34px;
    }

    .cname {
      font-family: 'Cinzel', serif;
      font-size: 10px;
      letter-spacing: 2px;
    }

    .crole {
      font-size: 9px;
      color: #3a5060;
      text-align: center;
      padding: 0 6px;
    }

    .lrow {
      display: flex;
      gap: 8px;
      align-items: center;
      min-height: 26px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .ls {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px;
      border-radius: 18px;
      border: 1px solid #1e2a38;
      background: #070f19;
      font-size: 11px;
    }

    /* ‚îÄ‚îÄ‚îÄ LEVEL COMPLETE ‚îÄ‚îÄ‚îÄ */
    #levelcomplete {
      background: rgba(3, 6, 8, .96);
    }

    .lc-title {
      font-family: 'Cinzel', serif;
      font-size: clamp(30px, 5vw, 52px);
      font-weight: 900;
      color: #f4c542;
      text-shadow: 0 0 50px rgba(244, 197, 66, .5);
      letter-spacing: 4px;
    }

    .lc-stats {
      display: flex;
      gap: 24px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      color: #4a6375;
    }

    .lc-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .lc-stat b {
      font-size: 22px;
      color: #d0dce8;
    }

    .lc-boss {
      font-size: 48px;
    }

    /* ‚îÄ‚îÄ‚îÄ GAME OVER ‚îÄ‚îÄ‚îÄ */
    #win,
    #lose {
      background: rgba(3, 6, 8, .97);
    }

    .end-t {
      font-family: 'Cinzel', serif;
      font-size: clamp(36px, 6vw, 64px);
      font-weight: 900;
      letter-spacing: 6px;
    }

    .win-t {
      color: #f4c542;
      text-shadow: 0 0 55px rgba(244, 197, 66, .5);
    }

    .lose-t {
      color: #f87171;
      text-shadow: 0 0 55px rgba(248, 113, 113, .4);
    }

    /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
    .btn {
      padding: 9px 40px;
      font-family: 'Cinzel', serif;
      font-size: 12px;
      letter-spacing: 3px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: all .2s;
    }

    .btn-go {
      background: linear-gradient(135deg, #f4c542, #ff8c00);
      color: #000;
      opacity: .15;
      pointer-events: none;
    }

    .btn-go.rdy {
      opacity: 1;
      pointer-events: all;
    }

    .btn-go.rdy:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(244, 197, 66, .4);
    }

    .btn-back {
      background: transparent;
      color: #d0dce8;
      border: 1px solid #2a3a4a;
    }

    .btn-back:hover {
      border-color: #f4c542;
      color: #f4c542;
    }

    .btn-next {
      background: linear-gradient(135deg, #4ade80, #16a34a);
      color: #000;
      border: none;
      padding: 12px 44px;
      font-family: 'Cinzel', serif;
      font-size: 13px;
      letter-spacing: 3px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }

    .btn-next:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(74, 222, 128, .4);
    }

    .ctrls {
      font-family: 'Share Tech Mono', monospace;
      font-size: 8px;
      color: #1e2d3a;
      letter-spacing: 1px;
      text-align: center;
      line-height: 2;
    }

    .eff-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      font-family: 'Share Tech Mono', monospace;
      font-size: 8px;
      max-width: 680px;
      color: #3a5060;
    }

    /* ‚îÄ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ */
    #tip {
      position: fixed;
      z-index: 999;
      pointer-events: none;
      display: none;
      width: 230px;
      background: #07101c;
      border: 1px solid #1e3050;
      border-radius: 9px;
      padding: 11px 13px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, .85);
    }

    #tip.on {
      display: block;
    }

    .tn {
      font-family: 'Cinzel', serif;
      font-size: 13px;
      color: #f4c542;
      margin-bottom: 2px;
    }

    .tm {
      font-family: 'Share Tech Mono', monospace;
      font-size: 8px;
      color: #4a6375;
      margin-bottom: 5px;
    }

    .tt2 {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      margin-bottom: 5px;
    }

    .tg {
      font-family: 'Share Tech Mono', monospace;
      font-size: 8px;
      padding: 1px 5px;
      border-radius: 3px;
    }

    .ts2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px;
      margin-bottom: 5px;
    }

    .tv {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: #5a7090;
    }

    .tv b {
      color: #d0dce8;
    }

    .tdiv {
      border-top: 1px solid #1a2535;
      margin: 5px 0;
    }

    .td {
      font-size: 11px;
      color: #8090a8;
      line-height: 1.5;
      margin-bottom: 4px;
    }

    .tst {
      font-size: 10px;
      color: #a0b0c0;
      margin-bottom: 3px;
    }

    .tsy {
      font-size: 10px;
      color: #f4c542;
      background: rgba(244, 197, 66, .06);
      padding: 4px 7px;
      border-left: 2px solid #f4c542;
      border-radius: 0 3px 3px 0;
    }

    .train-picks {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    .train-el-btn {
      width: 44px;
      height: 50px;
      background: rgba(10, 18, 28, .85);
      border: 2px solid #333;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      text-align: center;
      transition: all .15s;
      padding: 4px 0 0;
    }

    .train-el-btn:hover {
      background: rgba(30, 50, 70, .7);
      transform: scale(1.08);
    }

    /* Instruction Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(5, 10, 15, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 40px;
      color: #acc2d1;
      font-family: 'Rajdhani', sans-serif;
    }

    .modal-content {
      max-width: 800px;
      width: 100%;
      background: #0f172a;
      border: 1px solid #1e293b;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-h {
      font-size: 24px;
      color: #f4c542;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-bottom: 1px solid #1e293b;
      padding-bottom: 10px;
    }

    .modal-section {
      margin-bottom: 24px;
    }

    .modal-section h3 {
      color: #4fc3f7;
      font-size: 18px;
      margin-bottom: 8px;
    }

    .modal-section p {
      font-size: 14px;
      line-height: 1.6;
    }

    .kbd {
      background: #1e293b;
      padding: 2px 6px;
      border-radius: 4px;
      color: #fff;
      font-size: 12px;
      border: 1px solid #334155;
    }

    .reaction-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 13px;
    }

    .reaction-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 8px;
      border-radius: 6px;
    }

    /* Draft Card Hover Preview */
    .card {
      position: relative;
    }

    #cardPreview {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      margin-top: 10px;
      width: 280px;
      z-index: 100;
      background: rgba(8, 15, 26, 0.96);
      border: 1px solid #1e293b;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 11px;
      color: #acc2d1;
      pointer-events: none;
      line-height: 1.5;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
    }

    #cardPreview .cp-title {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 6px;
      letter-spacing: 1px;
    }

    #cardPreview .cp-sk {
      margin-bottom: 5px;
    }

    #cardPreview .cp-sk b {
      font-size: 11px;
    }

    #cardPreview .cp-fus {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid #1e293b;
    }

    #cardPreview .cp-fus b {
      color: #c084fc;
    }
  </style>
</head>

<body>
  <!-- ‚ïê‚ïê‚ïê SCREENS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <!-- MAIN MENU -->
  <div id="menu" class="screen">
    <div class="gsub">PROTOTYPE v1.4</div>
    <div class="gtitle">ELEMENTAL CATALYST</div>
    <div class="gsub" style="color:#2a4050;letter-spacing:2px">7 ELEMENTAL BOSSES ¬∑ ONLINE CO-OP ¬∑ DRAFT-SYSTEM</div>

    <div class="game-desc">
      <h3>‚öî WIE SPIELT MAN?</h3>
      <p style="margin:0 0 4px 0">
        W√§hle im <b style="color:#f4c542">Draft-System</b> 2 Elemente und kombiniere sie zu einzigartigen Skills.
        Besiege <b style="color:#ef4444">W√§chter</b>, um den Boss freizuschalten, dann k√§mpfe gegen den
        <b style="color:#c084fc">Elementar-Boss</b> durch 3 Phasen.
      </p>
      <div class="gd-grid">
        <div class="gd-item">
          <span class="gd-icon">üé¥</span>
          <span><b>Draft:</b> W√§hle Prim√§r- & Sekund√§r-Element. Jede Kombi ergibt eine andere Fusion (R-Skill)!</span>
        </div>
        <div class="gd-item">
          <span class="gd-icon">üíÄ</span>
          <span><b>Bosskampf:</b> 3 Phasen ‚Äî der Boss wird aggressiver und nutzt ab Phase 2 Zusatz-Elemente!</span>
        </div>
        <div class="gd-item">
          <span class="gd-icon">üî•</span>
          <span><b>Elemente:</b> Feuer > Natur > Wasser > Feuer. Licht ‚Üî Dunkelheit (2√ó). Richtig w√§hlen = doppelter
            Schaden!</span>
        </div>
        <div class="gd-item">
          <span class="gd-icon">üíä</span>
          <span><b>Buff-Orbs:</b> Besiegte Gegner droppen Wut, Hast, Fokus oder Vita-Orbs f√ºr tempor√§re Boosts!</span>
        </div>
      </div>
      <div style="margin-top:8px;font-size:10px;color:#3a5060;text-align:center">
        WASD = Bewegen ¬∑ Maus = Zielen ¬∑ LMB/RMB/Q/E = Skills ¬∑ R = Fusion ¬∑ SPACE = Dash
      </div>
    </div>

    <div class="menu-btns">
      <button class="mbtn primary" onclick="goSolo()">‚öî SOLO SPIELEN</button>
      <button class="mbtn" onclick="goTraining()"
        style="background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff">üéØ TRAINING</button>
      <button class="mbtn blue" onclick="goCreateLobby()">üåê ONLINE ‚Äî LOBBY ERSTELLEN</button>
      <button class="mbtn purple" onclick="goJoinLobby()">üîó ONLINE ‚Äî LOBBY BEITRETEN</button>
    </div>
    <div class="eff-row">
      <span style="color:#ff5555">üî•>üåø üíß>üî• üåø>üíß ‚ú®‚Üîüåë (2√ó)</span>
      <span>üåÄ‚Üíü™® (0.5√ó) ¬∑ ü™®‚ÜíüåÄ (1.5√ó)</span>
    </div>
  </div>

  <!-- LOBBY (CREATE) -->
  <div id="lobbyCreate" class="screen hidden">
    <div class="lobby-box">
      <div class="lobby-title">üåê LOBBY ERSTELLEN</div>
      <div>
        <div class="lbl">Dein Raum-Code</div>
        <div class="room-code" id="roomCodeDisplay">...</div>
      </div>
      <div class="lobby-status"><span class="status-dot waiting" id="hostDot"></span><span id="hostStatus">Warte auf
          Mitspieler...</span></div>
      <div class="lbl" style="font-size:9px;color:#2a3a4a">Teile diesen Code mit deinem Mitspieler. Er kann damit
        beitreten.</div>
      <button class="btn btn-back" onclick="lobbyCancel()">ABBRECHEN</button>
    </div>
  </div>

  <!-- LOBBY (JOIN) -->
  <div id="lobbyJoin" class="screen hidden">
    <div class="lobby-box">
      <div class="lobby-title">üîó LOBBY BEITRETEN</div>
      <div>
        <div class="lbl">Raum-Code eingeben</div>
        <input class="inp" id="joinCodeInp" maxlength="6" placeholder="XXXXXX"
          oninput="this.value=this.value.toUpperCase()">
      </div>
      <div class="lobby-status"><span class="status-dot" id="joinDot"></span><span id="joinStatus">Code eingeben und
          verbinden</span></div>
      <button class="mbtn primary" onclick="doJoin()" style="margin-top:4px">VERBINDEN</button>
      <button class="btn btn-back" onclick="lobbyCancel()">ABBRECHEN</button>
    </div>
  </div>

  <!-- LEVEL SELECT -->
  <div id="levelselect" class="screen hidden">
    <div class="gsub">KAPITEL-AUSWAHL</div>
    <div class="gtitle" style="font-size:28px">ELEMENTAL JOURNEY</div>
    <div class="levels-grid" id="levelsGrid"></div>
    <button class="btn btn-back" onclick="goMenu()">‚Üê HAUPTMEN√ú</button>
  </div>

  <!-- DRAFT -->
  <div id="draft" class="screen hidden">
    <div class="gsub" id="draftModeLbl">SOLO</div>
    <div class="gtitle" style="font-size:28px">ELEMENT-DRAFT</div>
    <div class="eff-row">
      <span style="color:#ff5555">üî•>üåø üíß>üî• üåø>üíß ‚ú®‚Üîüåë (2√ó)</span>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
      <div class="plabel" id="plabel"></div>
      <div class="pstep" id="pstep"></div>
    </div>
    <div class="cards" id="cards"></div>
    <div class="lrow" id="lrow"></div>
    <button class="btn btn-go" id="btngo" onclick="startGame()">‚öî KAMPF STARTEN</button>
    <div class="ctrls">
      P1: WASD ¬∑ LMB Angriff ¬∑ RMB(halten)=Charge ¬∑ Q/E Skills ¬∑ R=FUSION-ULTI ¬∑ LEERTASTE Dash ¬∑ TAB Element<br>
      P2(Lokal): IJKL ¬∑ U Atk ¬∑ O Charge ¬∑ 1/2 Skills ¬∑ 3 Fusion ¬∑ Shift+R Dash ¬∑ P Element
    </div>
  </div>

  <!-- GAME -->
  <div id="game" class="screen hidden"><canvas id="cv"></canvas></div>

  <!-- LEVEL COMPLETE -->
  <div id="levelcomplete" class="screen hidden">
    <div class="lc-boss" id="lcBossEmoji">üåã</div>
    <div class="lc-title" id="lcTitle">BOSS BESIEGT!</div>
    <div id="lcBossName"
      style="font-family:'Share Tech Mono',monospace;font-size:12px;color:#4a6375;letter-spacing:3px;margin-top:-8px">
    </div>
    <div class="lc-stats" id="lcStats"></div>
    <button class="btn-next" id="btnNext" onclick="goNextLevel()">N√ÑCHSTES LEVEL ‚Üí</button>
    <button class="btn btn-back" onclick="goMenu()">HAUPTMEN√ú</button>
  </div>

  <!-- GAME COMPLETE -->
  <div id="win" class="screen hidden">
    <div class="end-t win-t">‚ú¶ ALLES BESIEGT ‚ú¶</div>
    <div style="font-size:14px;color:#4a6375;text-align:center;max-width:500px" id="winsub"></div>
    <div style="font-size:32px;margin:8px 0">üî•üíßü™®üåÄüåø‚ú®üåë</div>
    <button class="btn-next" onclick="goMenu()">HAUPTMEN√ú</button>
  </div>
  <div id="lose" class="screen hidden">
    <div class="end-t lose-t">NIEDERLAGE</div>
    <div style="font-size:13px;color:#4a6375;max-width:500px;text-align:center">Die Dunkelheit hat dich verschluckt.
      Steh wieder auf.</div>
    <button class="btn-next" style="background:linear-gradient(135deg,#ef4444,#991b1b);color:#fff;"
      onclick="retryLevel()">NOCHMAL VERSUCHEN</button>
    <button class="btn btn-back" onclick="goMenu()">HAUPTMEN√ú</button>
  </div>

  <div id="tip"></div>

  <!-- TRAINING ROOM -->
  <div id="training" class="screen hidden">
    <div class="gsub">TRAINING</div>
    <div class="gtitle" style="font-size:28px">üéØ TRAININGSRAUM</div>
    <div style="color:#4a6375;font-size:12px;margin-bottom:12px;text-align:center">W√§hle Elemente frei ‚Äî teste alle
      Skills gegen Dummys</div>
    <div style="display:flex;gap:24px;justify-content:center;flex-wrap:wrap;margin-bottom:16px">
      <div style="text-align:center">
        <div style="color:#8090a8;font-size:10px;letter-spacing:2px;margin-bottom:4px">ELEMENT A (Prim√§r)</div>
        <div class="train-picks" id="trainA"></div>
      </div>
      <div style="text-align:center">
        <div style="color:#8090a8;font-size:10px;letter-spacing:2px;margin-bottom:4px">ELEMENT B (Sekund√§r)</div>
        <div class="train-picks" id="trainB"></div>
      </div>
      <div style="text-align:center">
        <div style="color:#8090a8;font-size:10px;letter-spacing:2px;margin-bottom:4px">SEELE (Passive)</div>
        <div class="train-picks" id="trainS"></div>
      </div>
    </div>
    <div id="trainPreview" style="color:#607a8a;font-size:11px;text-align:center;margin-bottom:8px"></div>
    <button class="btn btn-go rdy" id="btnTrainGo" onclick="startTrainingGame()" style="margin-bottom:8px">üéØ TRAINING
      STARTEN</button>
    <button class="btn btn-back" onclick="goMenu()">‚Üê HAUPTMEN√ú</button>
    <div class="ctrls">P1: WASD ¬∑ LMB Angriff ¬∑ RMB(halten)=Charge ¬∑ Q/E Skills ¬∑ R=FUSION-ULTI ¬∑ LEERTASTE Dash ¬∑ TAB
      Element</div>
  </div>
  <script>
    'use strict';
    const GW = 1680, GH = 960, PAD = 60;
    const PC = ['#f4c542', '#4fc3f7'];
    const PN = ['P1', 'P2'];

    // ‚îÄ‚îÄ‚îÄ ELEMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const EL = {
      fire: { n: 'Feuer', e: 'üî•', c: '#ff6b1a', g: '#ff4500' },
      water: { n: 'Wasser', e: 'üíß', c: '#42a5f5', g: '#1e88e5' },
      earth: { n: 'Erde', e: 'ü™®', c: '#a3a86e', g: '#8d9234' },
      wind: { n: 'Wind', e: 'üåÄ', c: '#4fc3f7', g: '#29b6f6' },
      nature: { n: 'Natur', e: 'üåø', c: '#4ade80', g: '#16a34a' },
      light: { n: 'Licht', e: '‚ú®', c: '#fde68a', g: '#f59e0b' },
      darkness: { n: 'Dunkel', e: 'üåë', c: '#a855f7', g: '#7e22ce' },
    };
    const ALL_EL = Object.keys(EL);
    const ROLES = { fire: 'Pure DPS', water: 'Healer', earth: 'Tank', wind: 'Mobility', nature: 'Zoner', light: 'Shielder', darkness: 'Assassin' };

    function getEff(a, d) {
      if (a === 'fire' && d === 'nature') return 2; if (a === 'fire' && d === 'water') return .5;
      if (a === 'water' && d === 'fire') return 2; if (a === 'water' && d === 'nature') return .5;
      if (a === 'nature' && d === 'water') return 2; if (a === 'nature' && d === 'fire') return .5;
      if (a === 'light' && d === 'darkness') return 2; if (a === 'darkness' && d === 'light') return 2;
      if (a === 'wind' && d === 'earth') return .5; if (a === 'earth' && d === 'wind') return 1.5;
      return 1;
    }

    // ‚îÄ‚îÄ‚îÄ SKILL DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function sk(id, nm, el, dmg, cd, desc, stat, syn, p = {}) { return { id, name: nm, element: el, dmg, cd, desc, status: stat, synergy: syn, tags: p.tags || [], ...p }; }
    const POOL = {
      fire: {
        lmb: [
          sk('fl1', 'Feuerball', 'fire', 30, .55, 'Explodiert bei Aufprall.', 'BURN 2s', 'Burst-Schaden.', { t: 'proj', speed: 510, r: 9, aoe: 36, burn: { d: 8, dur: 2 }, tags: ['EXPLOSIV'] }),
          sk('fl2', 'Flammenwerfer', 'fire', 16, .10, 'Kegelstrahl, kurze Reichweite.', 'BURN schnell', 'Nahkampf.', { t: 'beam', range: 140, cA: .46, burn: { d: 12, dur: 2 }, tags: ['KEGEL'] }),
          sk('fl3', 'Funkenflug', 'fire', 13, .65, '3 Funken, Streuschuss.', 'BURN 2s', 'Streuung.', { t: 'multi', cnt: 3, spr: .5, speed: 449, r: 7, burn: { d: 5, dur: 2 }, tags: ['SCHROT'] }),
          sk('fl4', 'Glutsplitter', 'fire', 17, .41, 'Schnelles Projektil, brennt nach.', 'BURN 2s', 'W√§chter.', { t: 'proj', speed: 490, r: 8, burn: { d: 6, dur: 2 }, tags: ['SCHNELL'] }),
          sk('fl5', 'Infernopfeil', 'fire', 33, .57, 'Kegelstrahl, hoher Schaden.', 'BURN 2s', 'Zerst√∂rer.', { t: 'beam', range: 150, cA: .40, burn: { d: 10, dur: 2 }, tags: ['KEGEL'] }),
          sk('fl6', 'Lavawelle', 'fire', 26, .58, 'Langsames Projektil, gro√üe Reichweite.', 'BURN 2s', 'Bewahrer.', { t: 'proj', speed: 380, r: 11, burn: { d: 7, dur: 2 }, tags: ['REICHWEITE'] }),
          sk('fl7', 'Kohlenschlag', 'fire', 26, .70, 'Kegelstrahl, taktisch einsetzbar.', 'BURN 2s', 'Taktiker.', { t: 'beam', range: 150, cA: .38, burn: { d: 8, dur: 2 }, tags: ['KEGEL'] }),
          sk('fl8', 'Zunderfunken', 'fire', 30, .45, 'Schnelle Projektile, hoher DPS.', 'BURN 2s', 'Pl√§nkler.', { t: 'proj', speed: 520, r: 7, burn: { d: 9, dur: 2 }, tags: ['SCHNELL'] }),
          sk('fl9', 'Essensturm', 'fire', 22, .74, 'Kegelstrahl, breiter Bereich.', 'BURN 2s', 'W√§chter.', { t: 'beam', range: 150, cA: .50, burn: { d: 6, dur: 2 }, tags: ['KEGEL'] }),
        ], rmb: [
          sk('fr1', 'Pyro-Schlag', 'fire', 95, 8, 'Riesige Kugel, aufladbar, massiver Splash.', 'BURN 4s', 'Maximaler Dmg.', { t: 'proj', speed: 240, r: 24, aoe: 90, burn: { d: 15, dur: 4 }, tags: ['AUFGELADEN'] }),
          sk('fr2', 'Drachenatem', 'fire', 22, 7, 'Kanalisierter Strahl, R√ºcksto√ü.', 'BURN+KB', 'Abstand.', { t: 'beam', range: 320, cA: .28, kb: 120, burn: { d: 10, dur: 3 }, tags: ['KANAL'] }),
          sk('fr3', 'Meteor-Ruf', 'fire', 115, 9, 'Markiert Boden, 1.5s Einschlag.', 'BURN+STUN', 'Verheerend.', { t: 'daoe', delay: 1.5, r: 85, burn: { d: 15, dur: 4 }, stun: .8, tags: ['TELEGRAPHED'] }),
          sk('fr4', 'Glutkugel', 'fire', 97, 6, 'Sofortiger schwerer Treffer, AoE 80.', 'BURN 3s', 'W√§chter.', { t: 'proj', speed: 360, r: 16, aoe: 80, burn: { d: 12, dur: 3 }, tags: ['SOFORT'] }),
          sk('fr5', 'Infernoramme', 'fire', 92, 6.3, 'Sofortiger Aufschlag, Fl√§che 80.', 'BURN 3s', 'Zerst√∂rer.', { t: 'proj', speed: 340, r: 18, aoe: 80, burn: { d: 14, dur: 3 }, tags: ['SOFORT'] }),
          sk('fr6', 'Lavabrocken', 'fire', 94, 4.2, 'Aufladbar, hoher Einzelschaden.', 'BURN 3s', 'Bewahrer.', { t: 'proj', speed: 280, r: 20, burn: { d: 12, dur: 3 }, tags: ['AUFGELADEN'] }),
          sk('fr7', 'Kohlenbombe', 'fire', 67, 4.3, 'Aufladbar, schneller CD.', 'BURN 2s', 'Taktiker.', { t: 'proj', speed: 300, r: 14, burn: { d: 8, dur: 2 }, tags: ['AUFGELADEN'] }),
          sk('fr8', 'Zunderkanone', 'fire', 109, 7.2, 'Aufladbar, maximaler Schaden.', 'BURN 4s', 'Pl√§nkler.', { t: 'proj', speed: 260, r: 22, burn: { d: 16, dur: 4 }, tags: ['AUFGELADEN'] }),
          sk('fr9', 'Essenschlag', 'fire', 107, 5, 'Sofortschlag, gro√üer AoE.', 'BURN 3s', 'W√§chter.', { t: 'proj', speed: 380, r: 18, aoe: 80, burn: { d: 13, dur: 3 }, tags: ['SOFORT'] }),
        ], q: [
          sk('fq1', 'Feuerwand', 'fire', 0, 10, 'Linie am Boden, verbrennt alles darin.', 'BURN-ZONE 5s', 'Barriere.', { t: 'wall', ww: 220, wh: 14, burn: { d: 12 }, life: 5, tags: ['TERRAIN'] }),
          sk('fq2', 'Phoenix-Dash', 'fire', 28, 9, 'Dash vorw√§rts, hinterl√§sst Feuerspur.', 'BURN 3s+Spur', 'I-Frames.', { t: 'dashSkill', range: 190, burn: { d: 8, dur: 3 }, tags: ['DASH'] }),
          sk('fq3', 'Hitzewelle', 'fire', 55, 11, '360¬∞ Explosion, R√ºcksto√ü.', 'BURN+KB', 'Nahkampf.', { t: 'aoe', r: 115, kb: 155, burn: { d: 10, dur: 2 }, tags: ['360¬∞'] }),
          sk('fq4', 'Glutmantel', 'fire', 0, 9.4, 'AoE Slow im Bereich.', 'SLOW 2s', 'W√§chter.', { t: 'aoe', r: 150, slow: { f: .5, dur: 2 }, burn: { d: 5, dur: 2 }, tags: ['CC'] }),
          sk('fq5', 'Infernolauf', 'fire', 3, 10.2, 'AoE Slow-Explosion.', 'SLOW 2s', 'Zerst√∂rer.', { t: 'aoe', r: 150, slow: { f: .5, dur: 2 }, burn: { d: 6, dur: 2 }, tags: ['CC'] }),
          sk('fq6', 'Lavawall', 'fire', 4, 10.6, 'Dash durch Lava, hinterl√§sst Spur.', 'BURN+DASH', 'Bewahrer.', { t: 'dashSkill', range: 250, burn: { d: 8, dur: 2 }, tags: ['DASH'] }),
          sk('fq7', 'Kohlenrauch', 'fire', 0, 10.9, 'Rauch-Dash, Gegner verlieren Sicht.', 'DASH+BLIND', 'Taktiker.', { t: 'dashSkill', range: 250, blind: 1.5, tags: ['DASH'] }),
          sk('fq8', 'Zunderspur', 'fire', 8, 11.5, 'Erzeugt Feuerschild +50 HP.', 'SCHILD 50HP', 'Pl√§nkler.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
          sk('fq9', 'Essenpanzer', 'fire', 12, 8.4, 'Feuerschild absorbiert +50 HP.', 'SCHILD 50HP', 'W√§chter.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
        ], e: [
          sk('fe1', 'Lebende Bombe', 'fire', 75, 10, 'Klebt an Gegner, explodiert nach 3s.', 'KETTEN-EXPLOSION', 'Setup.', { t: 'proj', speed: 460, r: 9, bomb: { delay: 3, r: 70, burn: { d: 15, dur: 3 } }, tags: ['BOMBE'] }),
          sk('fe2', 'Magma-Pf√ºtze', 'fire', 0, 11, 'Dauerpf√ºtze, 12/s DoT.', 'BURN-ZONE 6s', 'Zoning.', { t: 'zone', r: 85, life: 6, dmgTick: 12, burn: { d: 8, dur: 2 }, tags: ['ZONE'] }),
          sk('fe3', '√úberhitzung', 'fire', 0, 12, '6s +50% Schaden, aber -4HP/s Selbstschaden.', 'DMGBUFF+SelfDoT', 'Glaskanone.', { t: 'buff', dmgBuff: { f: 1.5, dur: 6 }, selfDot: { d: 4, dur: 6 }, tags: ['BUFF'] }),
          sk('fe4', 'Glutsee', 'fire', 40, 12.6, 'Projektil schw√§cht getroffenen Gegner.', 'WEAKNESS 4s', 'W√§chter.', { t: 'proj', speed: 380, r: 12, weakness: { f: .7, dur: 4 }, tags: ['DEBUFF'] }),
          sk('fe5', 'Infernokrater', 'fire', 40, 13.6, 'Projektil schw√§cht Gegner massiv.', 'WEAKNESS 4s', 'Zerst√∂rer.', { t: 'proj', speed: 360, r: 12, weakness: { f: .6, dur: 4 }, tags: ['DEBUFF'] }),
          sk('fe6', 'Lavabecken', 'fire', 0, 10.1, 'Bleibende Schadenszone 6s, 15/tick.', 'ZONE 6s', 'Bewahrer.', { t: 'zone', r: 120, life: 6, dmgTick: 15, burn: { d: 6, dur: 2 }, tags: ['ZONE'] }),
          sk('fe7', 'Kohlenwolke', 'fire', 0, 14, 'Rauchwolke, schadet 15/tick 6s.', 'ZONE 6s', 'Taktiker.', { t: 'zone', r: 120, life: 6, dmgTick: 15, burn: { d: 6, dur: 2 }, tags: ['ZONE'] }),
          sk('fe8', 'Zunderpfad', 'fire', 0, 10.7, 'Beschw√∂rt einen Feuer-Minion.', 'MINION', 'Pl√§nkler.', { t: 'special', summonMinion: true, minionEl: 'fire', tags: ['MINION'] }),
          sk('fe9', 'Essenschmelze', 'fire', 0, 14.6, 'Beschw√∂rt einen Lava-Helfer.', 'MINION', 'W√§chter.', { t: 'special', summonMinion: true, minionEl: 'fire', tags: ['MINION'] }),
        ], passive: [
          sk('fp1', 'Inneres Feuer', 'fire', 0, 0, 'Unter 30% HP: +50% Schaden.', '+50% Dmg (30% HP)', 'Glaskanone.', { t: 'passive', pid: 'innerfire' }),
          sk('fp2', 'Brandstifter', 'fire', 0, 0, 'Crits setzen Gegner in Brand (+50% Burn).', 'Crits‚ÜíBURN +50%', 'DPS.', { t: 'passive', pid: 'brand' }),
          sk('fp3', 'Asche zu Asche', 'fire', 0, 0, 'Gegner sterben ‚Üí kleine Explosion.', 'On-Kill Explosion', 'Kettenreaktion.', { t: 'passive', pid: 'asche' }),
          sk('fp4', 'Feuerpuls', 'fire', 0, 0, 'Gegner-Kill heilt dich um 15 HP.', '+15 HP on Kill', 'W√§chter.', { t: 'passive', pid: 'feuerpuls', killHeal: 15 }),
          sk('fp5', 'Gluthaut', 'fire', 0, 0, '+20% Elementarschaden.', '+20% Elem Dmg', 'Zerst√∂rer.', { t: 'passive', pid: 'gluthaut', elemDmg: 1.2 }),
          sk('fp6', 'Brandsiegel', 'fire', 0, 0, '+30 Max HP.', '+30 Max HP', 'Bewahrer.', { t: 'passive', pid: 'brandsiegel', bonusHP: 30 }),
          sk('fp7', 'Aschewille', 'fire', 0, 0, 'Alle Cooldowns -15%.', '-15% CDs', 'Taktiker.', { t: 'passive', pid: 'aschewille', cdReduce: .15 }),
          sk('fp8', 'Infernopr√§senz', 'fire', 0, 0, '+15% Bewegungsspeed.', '+15% Speed', 'Pl√§nkler.', { t: 'passive', pid: 'infpraes', spdMult: 1.15 }),
          sk('fp9', 'Pyromanie', 'fire', 0, 0, 'Angreifer erleiden 10 Feuerschaden.', '10 Thorns', 'W√§chter.', { t: 'passive', pid: 'pyromania', thorns: 10 }),
        ]
      },
      water: {
        lmb: [
          sk('wl1', 'Wasser-Geschoss', 'water', 21, .60, 'Prallt 1√ó von W√§nden ab.', 'PRALL', 'Winkel.', { t: 'proj', speed: 462, r: 10, bounce: true, tags: ['PRALL'] }),
          sk('wl2', 'Blase', 'water', 17, .70, 'Langsam, sucht Ziel (Homing). +10 Heal.', 'HOMING+HEAL', 'Sicher.', { t: 'proj', speed: 200, r: 12, homing: true, healHit: 10, tags: ['HOMING'] }),
          sk('wl3', 'Wasser-Peitsche', 'water', 24, .65, 'Nahkampf-Arc, Slow 2s. +6 Heal.', 'SLOW+HEAL', 'Melee.', { t: 'aoe', r: 90, slow: { f: .55, dur: 2 }, healHit: 6, tags: ['NAHKAMPF'] }),
          sk('wl4', 'Eissplitter', 'water', 30, .60, 'Schnelles Eisprojektil.', 'kein Status', 'W√§chter.', { t: 'proj', speed: 480, r: 9, tags: ['SCHNELL'] }),
          sk('wl5', 'Frostnadel', 'water', 20, .71, 'Kegelstrahl, Frost-Effekt.', 'SLOW 1s', 'Zerst√∂rer.', { t: 'beam', range: 150, cA: .40, slow: { f: .5, dur: 1 }, tags: ['KEGEL'] }),
          sk('wl6', 'Strudelschuss', 'water', 29, .62, 'Projektil mit Heileffekt.', '+5 HEAL', 'Bewahrer.', { t: 'proj', speed: 440, r: 10, healHit: 5, tags: ['HEILUNG'] }),
          sk('wl7', 'Tiefseestrahl', 'water', 18, .67, 'Kegelstrahl, verlangsamt.', 'SLOW 1.5s', 'Taktiker.', { t: 'beam', range: 150, cA: .38, slow: { f: .4, dur: 1.5 }, tags: ['KEGEL'] }),
          sk('wl8', 'Gischtpfeil', 'water', 18, .49, 'Schnelles Projektil, niedriger CD.', 'kein Status', 'Pl√§nkler.', { t: 'proj', speed: 530, r: 8, tags: ['SCHNELL'] }),
          sk('wl9', 'Eisstachel', 'water', 22, .76, 'Kegelstrahl, breiter Winkel.', 'SLOW 1s', 'W√§chter.', { t: 'beam', range: 150, cA: .48, slow: { f: .4, dur: 1 }, tags: ['KEGEL'] }),
        ], rmb: [
          sk('wr1', 'Tsunami', 'water', 55, 10, 'Breite Welle, w√§scht Gegner weg.', 'KB 200', 'Pusher.', { t: 'proj', speed: 360, r: 30, kb: 200, tags: ['WELLE'] }),
          sk('wr2', 'Hochdruck', 'water', 50, 8, 'D√ºnner Strahl, durchdringt Gegner.', 'PIERCE+SLOW', 'Anti-Alles.', { t: 'beam', range: 390, cA: .09, pierce: true, slow: { f: .5, dur: 3 }, tags: ['PIERCE'] }),
          sk('wr3', 'Heil-Bombe', 'water', 34, 10, 'Kugel heilt Freunde, schadet Feinden.', 'HEAL +35 AoE', 'Dual.', { t: 'proj', speed: 435, r: 18, aoe: 65, healHit: 35, tags: ['HEILUNG'] }),
          sk('wr4', 'Eisblock', 'water', 107, 7, 'Soforttreffer mit AoE 80.', 'SLOW 2s', 'W√§chter.', { t: 'proj', speed: 340, r: 18, aoe: 80, slow: { f: .5, dur: 2 }, tags: ['SOFORT'] }),
          sk('wr5', 'Froststo√ü', 'water', 65, 6.8, 'Sofort-AoE, Frostschaden.', 'SLOW 2s', 'Zerst√∂rer.', { t: 'proj', speed: 360, r: 16, aoe: 80, slow: { f: .6, dur: 2 }, tags: ['SOFORT'] }),
          sk('wr6', 'Strudelball', 'water', 108, 7.6, 'Aufladbar, massiver Schaden.', 'SLOW 3s', 'Bewahrer.', { t: 'proj', speed: 280, r: 20, slow: { f: .5, dur: 3 }, tags: ['AUFGELADEN'] }),
          sk('wr7', 'Tiefseebombe', 'water', 91, 4.9, 'Aufladbar, schneller CD.', 'SLOW 2s', 'Taktiker.', { t: 'proj', speed: 300, r: 16, slow: { f: .4, dur: 2 }, tags: ['AUFGELADEN'] }),
          sk('wr8', 'Gischtkanone', 'water', 101, 4.8, 'Aufladbar, hoher DPS.', 'SLOW 2s', 'Pl√§nkler.', { t: 'proj', speed: 320, r: 18, slow: { f: .5, dur: 2 }, tags: ['AUFGELADEN'] }),
          sk('wr9', 'Eiskoloss', 'water', 73, 4.6, 'Sofort-AoE, breiter Bereich.', 'SLOW 2s', 'W√§chter.', { t: 'proj', speed: 380, r: 16, aoe: 80, slow: { f: .5, dur: 2 }, tags: ['SOFORT'] }),
        ], q: [
          sk('wq1', 'Geysir', 'water', 44, 10, 'Telegraph 0.6s, Stun 1.5s.', 'STUN 1.5s', 'Setup.', { t: 'daoe', delay: .6, r: 68, stun: 1.5, dmg: 44, tags: ['TELEGRAPHED', 'STUN'] }),
          sk('wq2', 'Riptide', 'water', 20, 12, 'Zieht Gegner in einen Strudel.', 'PULL', 'Combo.', { t: 'aoe', r: 140, pull: 200, tags: ['PULL'] }),
          sk('wq3', 'Reinigender Nebel', 'water', 0, 12, 'Entfernt alle Debuffs von dir.', 'CLEANSE', 'Konter.', { t: 'buff', cleanse: true, tags: ['CLEANSE'] }),
          sk('wq4', 'Eisschild', 'water', 10, 8.9, 'AoE-Stun im Bereich.', 'STUN 2s', 'W√§chter.', { t: 'aoe', r: 150, stun: 2, tags: ['CC'] }),
          sk('wq5', 'Frostmantel', 'water', 13, 8.4, 'AoE-Stun, h√∂herer Schaden.', 'STUN 2s', 'Zerst√∂rer.', { t: 'aoe', r: 150, stun: 2, tags: ['CC'] }),
          sk('wq6', 'Strudelsog', 'water', 6, 10.1, 'Wasser-Dash mit Heileffekt.', 'DASH+HEAL', 'Bewahrer.', { t: 'dashSkill', range: 250, healHit: 15, tags: ['DASH'] }),
          sk('wq7', 'Tiefenseele', 'water', 8, 10.3, 'Dash hinterl√§sst Slow-Zone.', 'DASH+SLOW', 'Taktiker.', { t: 'dashSkill', range: 250, slow: { f: .5, dur: 2 }, tags: ['DASH'] }),
          sk('wq8', 'Gischtsprung', 'water', 16, 10.4, 'Erzeugt Wasserschild +50 HP.', 'SCHILD 50HP', 'Pl√§nkler.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
          sk('wq9', 'Eislauf', 'water', 4, 10.6, 'Eisschild absorbiert +50 HP.', 'SCHILD 50HP', 'W√§chter.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
        ], e: [
          sk('we1', 'Gef√§ngnis', 'water', 25, 12, 'Schlie√üt Gegner 3s ein (kampfunf√§hig).', 'BANISH 3s', 'Isolation.', { t: 'proj', speed: 380, r: 12, banish: 3, tags: ['BANISH'] }),
          sk('we2', 'Heilender Regen', 'water', 0, 14, 'Zone heilt 10HP/s f√ºr 6s.', 'HEAL-ZONE 6s', 'Sustain.', { t: 'zone', r: 80, healZ: { a: 10, iv: 1 }, life: 6, tags: ['HEILUNG'] }),
          sk('we3', 'Spiegel-Schild', 'water', 0, 13, 'Reflektiert n√§chstes Projektil 3s.', 'REFLEKTION 3s', 'Konter.', { t: 'buff', reflectDur: 3, tags: ['SCHILD'] }),
          sk('we4', 'Eisfl√§che', 'water', 40, 10.8, 'Projektil schw√§cht Gegner.', 'WEAKNESS 4s', 'W√§chter.', { t: 'proj', speed: 380, r: 12, weakness: { f: .7, dur: 4 }, tags: ['DEBUFF'] }),
          sk('we5', 'Frostzone', 'water', 40, 14.9, 'Projektil, starker Debuff.', 'WEAKNESS 4s', 'Zerst√∂rer.', { t: 'proj', speed: 360, r: 12, weakness: { f: .6, dur: 4 }, tags: ['DEBUFF'] }),
          sk('we6', 'Strudelgrube', 'water', 0, 11, 'Bleibende Zone, 15/tick 6s.', 'ZONE 6s', 'Bewahrer.', { t: 'zone', r: 120, life: 6, dmgTick: 15, slow: { f: .4, dur: 1 }, tags: ['ZONE'] }),
          sk('we7', 'Tiefseegraben', 'water', 0, 12.5, 'Tiefsee-Zone, schadet+slowed.', 'ZONE 6s', 'Taktiker.', { t: 'zone', r: 120, life: 6, dmgTick: 15, slow: { f: .5, dur: 1 }, tags: ['ZONE'] }),
          sk('we8', 'Gischtfeld', 'water', 0, 13.4, 'Beschw√∂rt Wasser-Minion.', 'MINION', 'Pl√§nkler.', { t: 'special', summonMinion: true, minionEl: 'water', tags: ['MINION'] }),
          sk('we9', 'Eisformation', 'water', 0, 11.3, 'Beschw√∂rt Eis-Helfer.', 'MINION', 'W√§chter.', { t: 'special', summonMinion: true, minionEl: 'water', tags: ['MINION'] }),
        ], passive: [
          sk('wp1', 'Fluss', 'water', 0, 0, 'Team-CDs -10%.', 'Team-CDs -10%', 'Utility.', { t: 'passive', pid: 'fluss', cdReduce: .10 }),
          sk('wp2', 'Rutschbahn', 'water', 0, 0, 'Du und Team +20% Speed.', '+20% Speed', 'Kite.', { t: 'passive', pid: 'rutsch', spdMult: 1.2 }),
          sk('wp3', 'N√§sse', 'water', 0, 0, 'Gegner erleiden +15% Schaden durch Blitz/Eis.', '+15% Vuln', 'Debuff.', { t: 'passive', pid: 'naesse', wetVuln: .15 }),
          sk('wp4', 'Flutzeichen', 'water', 0, 0, 'Gegner-Kill heilt dich um 15 HP.', '+15 HP on Kill', 'W√§chter.', { t: 'passive', pid: 'flutzeichen', killHeal: 15 }),
          sk('wp5', 'Eisader', 'water', 0, 0, '+20% Elementarschaden.', '+20% Elem Dmg', 'Zerst√∂rer.', { t: 'passive', pid: 'eisader', elemDmg: 1.2 }),
          sk('wp6', 'Meeresseele', 'water', 0, 0, '+30 Max HP.', '+30 Max HP', 'Bewahrer.', { t: 'passive', pid: 'meeresseele', bonusHP: 30 }),
          sk('wp7', 'Tauchreflex', 'water', 0, 0, 'Alle Cooldowns -15%.', '-15% CDs', 'Taktiker.', { t: 'passive', pid: 'tauchreflex', cdReduce: .15 }),
          sk('wp8', 'Str√∂mungssinn', 'water', 0, 0, '+15% Bewegungsspeed.', '+15% Speed', 'Pl√§nkler.', { t: 'passive', pid: 'stroem', spdMult: 1.15 }),
          sk('wp9', 'Tiefenruf', 'water', 0, 0, 'Angreifer erleiden 10 Schaden.', '10 Thorns', 'W√§chter.', { t: 'passive', pid: 'tiefenruf', thorns: 10 }),
        ]
      },
      earth: {
        lmb: [
          sk('el1', 'Felsbrocken', 'earth', 38, .90, 'Bogenwurf, kleiner Stun 0.8s.', 'STUN 0.8s', '√úber W√§nde.', { t: 'proj', speed: 516, r: 14, arc: true, stun: .8, tags: ['BOGEN'] }),
          sk('el2', 'Steinfaust', 'earth', 42, .90, 'Nahkampf-Hieb, starker R√ºcksto√ü.', 'KB 175', 'Interrupt.', { t: 'aoe', r: 86, kb: 175, tags: ['NAHKAMPF'] }),
          sk('el3', 'Kiesel-Schrot', 'earth', 14, .80, '5 Steine, Streuschuss kurze Distanz.', 'kein Status', 'DPS-Streuung.', { t: 'multi', cnt: 5, spr: .55, speed: 433, r: 7, tags: ['SCHROT'] }),
          sk('el4', 'Granitschuss', 'earth', 24, .61, 'Schwerer Projektilschuss.', 'STUN 0.5s', 'W√§chter.', { t: 'proj', speed: 460, r: 12, stun: .5, tags: ['SCHWER'] }),
          sk('el5', 'Kieselhagel', 'earth', 31, .66, 'Kegelstrahl, Stein-Splitter.', 'kein Status', 'Zerst√∂rer.', { t: 'beam', range: 150, cA: .42, tags: ['KEGEL'] }),
          sk('el6', 'Sandpfeil', 'earth', 11, .75, 'Projektil, bremst Gegner.', 'SLOW 1s', 'Bewahrer.', { t: 'proj', speed: 430, r: 10, slow: { f: .4, dur: 1 }, tags: ['SLOW'] }),
          sk('el7', 'Basaltkegel', 'earth', 33, .66, 'Kegelstrahl, hoher Schaden.', 'kein Status', 'Taktiker.', { t: 'beam', range: 150, cA: .40, tags: ['KEGEL'] }),
          sk('el8', 'Quarznadel', 'earth', 29, .48, 'Schnelles Projektil, Piercing.', 'PIERCE', 'Pl√§nkler.', { t: 'proj', speed: 540, r: 8, pierce: true, tags: ['SCHNELL'] }),
          sk('el9', 'Ger√∂llsturm', 'earth', 15, .78, 'Kegelstrahl, breiter Bereich.', 'kein Status', 'W√§chter.', { t: 'beam', range: 150, cA: .50, tags: ['KEGEL'] }),
        ], rmb: [
          sk('er1', 'Stampfer', 'earth', 60, 10, 'Telegraph 0.7s Stun-AoE.', 'STUN 2s', 'CC-Anker.', { t: 'daoe', delay: .7, r: 120, stun: 2, dmg: 60, tags: ['TELEGRAPHED', 'STUN'] }),
          sk('er2', 'Boulder Roll', 'earth', 68, 9, 'Du rollst, √ºberrennst Gegner.', 'KB 200', 'Ramme.', { t: 'dashSkill', range: 265, kb: 200, tags: ['DASH'] }),
          sk('er3', 'Stalaktit', 'earth', 74, 9, '0.8s Delay, Airborne 2s.', 'AIRBORNE 2s', 'Kombo.', { t: 'daoe', delay: .8, r: 50, stun: 2, dmg: 74, tags: ['TELEGRAPHED'] }),
          sk('er4', 'Granitkugel', 'earth', 100, 4.7, 'Sofort, massiver AoE 80.', 'KB 100', 'W√§chter.', { t: 'proj', speed: 340, r: 18, aoe: 80, kb: 100, tags: ['SOFORT'] }),
          sk('er5', 'Kieselsturm', 'earth', 108, 6.6, 'Sofort, Steinregen trifft breit.', 'STUN 1s', 'Zerst√∂rer.', { t: 'proj', speed: 360, r: 16, aoe: 80, stun: 1, tags: ['SOFORT'] }),
          sk('er6', 'Sandblock', 'earth', 80, 7.2, 'Aufladbar, durchdringt Deckung.', 'KB 80', 'Bewahrer.', { t: 'proj', speed: 280, r: 20, kb: 80, tags: ['AUFGELADEN'] }),
          sk('er7', 'Basaltbombe', 'earth', 81, 5.4, 'Aufladbar, schneller CD.', 'STUN 0.8s', 'Taktiker.', { t: 'proj', speed: 300, r: 16, stun: .8, tags: ['AUFGELADEN'] }),
          sk('er8', 'Quarzgeschoss', 'earth', 96, 4.2, 'Aufladbar, h√∂chster Einzelschaden.', 'KB 120', 'Pl√§nkler.', { t: 'proj', speed: 260, r: 22, kb: 120, tags: ['AUFGELADEN'] }),
          sk('er9', 'Felsenkoloss', 'earth', 64, 8.4, 'Sofort, breiter AoE-Bereich.', 'STUN 1s', 'W√§chter.', { t: 'proj', speed: 380, r: 18, aoe: 80, stun: 1, tags: ['SOFORT'] }),
        ], q: [
          sk('eq1', 'Barrikade', 'earth', 0, 11, 'Zerst√∂rbare Mauer 200HP.', 'Wand 200HP', 'Deckung.', { t: 'wall', ww: 12, wh: 100, hp: 200, life: 6, tags: ['TERRAIN'] }),
          sk('eq2', 'Treibsand', 'earth', 10, 10, '-70% Speed in Zone 5s.', 'SLOW 70%', 'Setup.', { t: 'zone', r: 88, slow: { f: .7 }, life: 5, dmgTick: 2, tags: ['ZONE'] }),
          sk('eq3', 'Stein-R√ºstung', 'earth', 0, 12, 'Schild +100HP f√ºr 6s.', 'SCHILD 100HP', 'Tank.', { t: 'buff', shield: 100, tags: ['SCHILD'] }),
          sk('eq4', 'Granitmantel', 'earth', 0, 11.5, 'AoE-Slow im Bereich, Erdschicht.', 'SLOW 2s', 'W√§chter.', { t: 'aoe', r: 150, slow: { f: .6, dur: 2 }, tags: ['CC'] }),
          sk('eq5', 'Kieselfalle', 'earth', 5, 11.2, 'AoE-Slow, gr√∂√üerer Bereich.', 'SLOW 2s', 'Zerst√∂rer.', { t: 'aoe', r: 150, slow: { f: .5, dur: 2 }, tags: ['CC'] }),
          sk('eq6', 'Sandlauf', 'earth', 18, 10.5, 'Dash durch Steine, hinterl√§sst Spur.', 'DASH+SLOW', 'Bewahrer.', { t: 'dashSkill', range: 250, slow: { f: .5, dur: 2 }, tags: ['DASH'] }),
          sk('eq7', 'Basaltsprung', 'earth', 14, 10.8, 'Erd-Dash mit Knockback.', 'DASH+KB', 'Taktiker.', { t: 'dashSkill', range: 250, kb: 100, tags: ['DASH'] }),
          sk('eq8', 'Quarzpanzer', 'earth', 7, 9.1, 'Steinpanzer absorbiert +50 HP.', 'SCHILD 50HP', 'Pl√§nkler.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
          sk('eq9', 'Felsenform', 'earth', 2, 9.8, 'Erd-Schild +50 HP.', 'SCHILD 50HP', 'W√§chter.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
        ], e: [
          sk('ee1', 'Erdbeben', 'earth', 50, 12, 'Gro√üe AoE, zerst√∂rt Schilde.', 'AoE+SHIELD-BREAK', 'Kontrolle.', { t: 'aoe', r: 140, kb: 0, shieldBreak: true, tags: ['SCHILD-BREAK'] }),
          sk('ee2', 'Versteinerung', 'earth', 0, 13, 'Unverwundbar 3s, aber bewegungslos.', 'INVUL 3s', '√úberleben.', { t: 'buff', invul: 3, immobile: 3, tags: ['INVUL'] }),
          sk('ee3', 'Katapult', 'earth', 0, 12, 'Schleudert dich extrem weit weg.', 'SUPER-DASH', 'Escape.', { t: 'dashSkill', range: 550, kb: 0, tags: ['SUPER-DASH'] }),
          sk('ee4', 'Granitfeld', 'earth', 40, 13.2, 'Projektil schw√§cht Gegner R√ºstung.', 'WEAKNESS 4s', 'W√§chter.', { t: 'proj', speed: 380, r: 12, weakness: { f: .7, dur: 4 }, tags: ['DEBUFF'] }),
          sk('ee5', 'Kieselzone', 'earth', 40, 10.7, 'Projektil-Debuff, starkes Schw√§chen.', 'WEAKNESS 4s', 'Zerst√∂rer.', { t: 'proj', speed: 360, r: 12, weakness: { f: .6, dur: 4 }, tags: ['DEBUFF'] }),
          sk('ee6', 'Sandgrube', 'earth', 0, 14.1, 'Bleibende Zone, 15/tick 6s, slowed.', 'ZONE 6s', 'Bewahrer.', { t: 'zone', r: 120, life: 6, dmgTick: 15, slow: { f: .5, dur: 1 }, tags: ['ZONE'] }),
          sk('ee7', 'Basaltkreis', 'earth', 0, 13.1, 'Stein-Zone, schadet+slowed.', 'ZONE 6s', 'Taktiker.', { t: 'zone', r: 120, life: 6, dmgTick: 15, slow: { f: .4, dur: 1 }, tags: ['ZONE'] }),
          sk('ee8', 'Quarzw√§chter', 'earth', 0, 13.5, 'Beschw√∂rt Stein-Golem.', 'MINION', 'Pl√§nkler.', { t: 'special', summonMinion: true, minionEl: 'earth', tags: ['MINION'] }),
          sk('ee9', 'Felsenriese', 'earth', 0, 10.5, 'Beschw√∂rt Erdgolem-Helfer.', 'MINION', 'W√§chter.', { t: 'special', summonMinion: true, minionEl: 'earth', tags: ['MINION'] }),
        ], passive: [
          sk('ep1', 'Standhaft', 'earth', 0, 0, 'Immun gegen R√ºcksto√ü.', 'KB-Immun', 'Charge.', { t: 'passive', pid: 'standhaft', kbImmune: true }),
          sk('ep2', 'Festung', 'earth', 0, 0, 'Team nimmt 10% weniger Schaden.', '-10% Dmg', 'Tank.', { t: 'passive', pid: 'fest', dmgReduce: .10 }),
          sk('ep3', 'Splitter', 'earth', 0, 0, 'Angreifer erhalten 12 Thorns zur√ºck.', '12 Thorns', 'Rache.', { t: 'passive', pid: 'splitter', thorns: 12 }),
          sk('ep4', 'Steinherz', 'earth', 0, 0, 'Gegner-Kill heilt 15 HP.', '+15 HP on Kill', 'W√§chter.', { t: 'passive', pid: 'steinherz', killHeal: 15 }),
          sk('ep5', 'Erdkraft', 'earth', 0, 0, '+20% Elementarschaden.', '+20% Elem Dmg', 'Zerst√∂rer.', { t: 'passive', pid: 'erdkraft', elemDmg: 1.2 }),
          sk('ep6', 'Felsenseele', 'earth', 0, 0, '+30 Max HP.', '+30 Max HP', 'Bewahrer.', { t: 'passive', pid: 'felsens', bonusHP: 30 }),
          sk('ep7', 'Granitinstinkt', 'earth', 0, 0, 'Alle Cooldowns -15%.', '-15% CDs', 'Taktiker.', { t: 'passive', pid: 'granitinst', cdReduce: .15 }),
          sk('ep8', 'Sandwandler', 'earth', 0, 0, '+15% Bewegungsspeed.', '+15% Speed', 'Pl√§nkler.', { t: 'passive', pid: 'sandwand', spdMult: 1.15 }),
          sk('ep9', 'Quarzwille', 'earth', 0, 0, 'Reflektiert 10 Schaden an Angreifer.', '10 Thorns', 'W√§chter.', { t: 'passive', pid: 'quarzwille', thorns: 10 }),
        ]
      },
      wind: {
        lmb: [
          sk('wil1', 'Windklinge', 'wind', 17, .45, 'Sehr schnell, durchschl√§gt 1 Gegner.', 'PIERCE', 'Spam.', { t: 'proj', speed: 660, r: 7, pierce: true, tags: ['SCHNELL'] }),
          sk('wil2', 'Luftsto√ü', 'wind', 0, .50, 'Kein Schaden, nur R√ºcksto√ü.', 'KB 220', 'Combo.', { t: 'aoe', r: 92, kb: 220, tags: ['KB'] }),
          sk('wil3', 'Bumerang', 'wind', 20, .70, 'Kommt zur√ºck, trifft 2√ó.', '2√ó Treffer', 'R√ºckkehr.', { t: 'proj', speed: 509, r: 9, boomerang: true, tags: ['R√úCKKEHR'] }),
          sk('wil4', 'Sturmnadel', 'wind', 20, .55, 'Schnelles Projektil, KB.', 'KB 60', 'W√§chter.', { t: 'proj', speed: 600, r: 7, kb: 60, tags: ['SCHNELL'] }),
          sk('wil5', 'Orkanschnitt', 'wind', 32, .49, 'Kegelstrahl, hoher Schaden.', 'kein Status', 'Zerst√∂rer.', { t: 'beam', range: 150, cA: .38, tags: ['KEGEL'] }),
          sk('wil6', 'Brisenpfeil', 'wind', 26, .63, 'Projektil, Pierce-Effekt.', 'PIERCE', 'Bewahrer.', { t: 'proj', speed: 580, r: 8, pierce: true, tags: ['PIERCE'] }),
          sk('wil7', 'B√∂enstreich', 'wind', 20, .68, 'Kegelstrahl, Knockback.', 'KB 80', 'Taktiker.', { t: 'beam', range: 150, cA: .42, kb: 80, tags: ['KEGEL'] }),
          sk('wil8', 'Wirbelschuss', 'wind', 21, .40, 'Extrem schnell, niedriger CD.', 'kein Status', 'Pl√§nkler.', { t: 'proj', speed: 700, r: 6, tags: ['SCHNELL'] }),
          sk('wil9', 'Zyklon-Hieb', 'wind', 18, .72, 'Kegelstrahl, breiter AoE.', 'KB 50', 'W√§chter.', { t: 'beam', range: 150, cA: .48, kb: 50, tags: ['KEGEL'] }),
        ], rmb: [
          sk('wir1', 'Tornado-Schuss', 'wind', 64, 9, 'Wirbelt Gegner hoch (Airborne 2s).', 'AIRBORNE 2s', 'Setup.', { t: 'proj', speed: 459, r: 18, stun: 2, tags: ['AIRBORNE'] }),
          sk('wir2', 'Vakuum-Bombe', 'wind', 38, 10, 'Zieht alle Gegner an einen Punkt.', 'PULL', 'Feuer-Combo.', { t: 'aoe', r: 140, pull: 200, tags: ['PULL'] }),
          sk('wir3', 'Schallmauer', 'wind', 48, 8, 'Dashst durch Gegner hindurch.', 'KB 150', 'Escape.', { t: 'dashSkill', range: 335, kb: 150, tags: ['DASH'] }),
          sk('wir4', 'Sturmkugel', 'wind', 60, 5.1, 'Sofort, AoE 80, Knockback.', 'KB 120', 'W√§chter.', { t: 'proj', speed: 400, r: 16, aoe: 80, kb: 120, tags: ['SOFORT'] }),
          sk('wir5', 'Orkansto√ü', 'wind', 102, 4.7, 'Sofort, massiver Schaden.', 'KB 150', 'Zerst√∂rer.', { t: 'proj', speed: 380, r: 18, aoe: 80, kb: 150, tags: ['SOFORT'] }),
          sk('wir6', 'Brisenbogen', 'wind', 91, 7.2, 'Aufladbar, hohe Reichweite.', 'KB 100', 'Bewahrer.', { t: 'proj', speed: 300, r: 20, kb: 100, tags: ['AUFGELADEN'] }),
          sk('wir7', 'B√∂enbombe', 'wind', 89, 4.2, 'Aufladbar, schneller CD.', 'KB 80', 'Taktiker.', { t: 'proj', speed: 320, r: 16, kb: 80, tags: ['AUFGELADEN'] }),
          sk('wir8', 'Wirbelsturm', 'wind', 65, 4.4, 'Aufladbar, hoher DPS.', 'KB 100', 'Pl√§nkler.', { t: 'proj', speed: 280, r: 18, kb: 100, tags: ['AUFGELADEN'] }),
          sk('wir9', 'Zyklonkoloss', 'wind', 108, 7.6, 'Sofort, breiter Bereich.', 'KB 130', 'W√§chter.', { t: 'proj', speed: 380, r: 18, aoe: 80, kb: 130, tags: ['SOFORT'] }),
        ], q: [
          sk('wq1', 'R√ºckenwind', 'wind', 0, 12, '+50% Speed f√ºr 4s.', 'SPEED +50%', 'Kite.', { t: 'buff', speedBuff: 4, tags: ['SPEED'] }),
          sk('wq2', 'Windmauer', 'wind', 0, 12, 'Mauer blockt alle Projektile 5s.', 'PROJ-BLOCK', 'Konter.', { t: 'wall', ww: 12, wh: 100, windWall: true, life: 5, tags: ['BLOCK'] }),
          sk('wq3', 'Sauerstoff-Entzug', 'wind', 0, 12, 'Telegraph 0.6s Stun 1.5s AoE.', 'STUN 1.5s', 'CC.', { t: 'daoe', delay: .6, r: 110, stun: 1.5, dmg: 0, tags: ['TELEGRAPHED'] }),
          sk('wiq4', 'Sturmmantel', 'wind', 3, 10.1, 'AoE-Slow im Bereich.', 'SLOW 2s', 'W√§chter.', { t: 'aoe', r: 150, slow: { f: .5, dur: 2 }, tags: ['CC'] }),
          sk('wiq5', 'Orkansto√ü', 'wind', 5, 10.4, 'AoE-Slow, Wind-Explosion.', 'SLOW 2s', 'Zerst√∂rer.', { t: 'aoe', r: 150, slow: { f: .5, dur: 2 }, tags: ['CC'] }),
          sk('wiq6', 'Brisenlauf', 'wind', 18, 9.7, 'Schneller Dash, hinterl√§sst Trail.', 'DASH', 'Bewahrer.', { t: 'dashSkill', range: 250, tags: ['DASH'] }),
          sk('wiq7', 'B√∂ensprung', 'wind', 16, 10.5, 'Dash mit Slow-Nacheffekt.', 'DASH+SLOW', 'Taktiker.', { t: 'dashSkill', range: 250, slow: { f: .4, dur: 2 }, tags: ['DASH'] }),
          sk('wiq8', 'Wirbelschild', 'wind', 7, 11.2, 'Windschild absorbiert +50 HP.', 'SCHILD 50HP', 'Pl√§nkler.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
          sk('wiq9', 'Zyklon-R√ºstung', 'wind', 3, 8.3, 'Windschild +50 HP.', 'SCHILD 50HP', 'W√§chter.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
        ], e: [
          sk('we1', 'Luft-Tausch', 'wind', 20, 14, 'Tauscht Position mit n√§chstem Gegner.', 'POSITION-TAUSCH', 'Chaos.', { t: 'special', swap: true, tags: ['SWAP'] }),
          sk('we2', 'Sturm-Schub', 'wind', 40, 10, 'St√∂√üt Gegner vor dir extrem weg.', 'KB 280', 'Pusher.', { t: 'proj', speed: 320, r: 22, kb: 280, tags: ['PUSH'] }),
          sk('we3', 'Luft-Klon', 'wind', 0, 12, 'Unsichtbarer Schein-Dash lenkt Gegner ab.', 'FEINT', 'T√§uschung.', { t: 'buff', feint: true, tags: ['FEINT'] }),
          sk('wie4', 'Sturmfeld', 'wind', 40, 12.5, 'Projektil schw√§cht Gegner.', 'WEAKNESS 4s', 'W√§chter.', { t: 'proj', speed: 380, r: 12, weakness: { f: .7, dur: 4 }, tags: ['DEBUFF'] }),
          sk('wie5', 'Orkanzone', 'wind', 40, 13.0, 'Projektil-Debuff, st√§rker.', 'WEAKNESS 4s', 'Zerst√∂rer.', { t: 'proj', speed: 360, r: 12, weakness: { f: .6, dur: 4 }, tags: ['DEBUFF'] }),
          sk('wie6', 'Brisenkreis', 'wind', 0, 12.7, 'Bleibende Zone, 15/tick 6s.', 'ZONE 6s', 'Bewahrer.', { t: 'zone', r: 120, life: 6, dmgTick: 15, tags: ['ZONE'] }),
          sk('wie7', 'B√∂engrube', 'wind', 0, 10.4, 'Wind-Zone, KB.', 'ZONE 6s', 'Taktiker.', { t: 'zone', r: 120, life: 6, dmgTick: 15, kb: 60, tags: ['ZONE'] }),
          sk('wie8', 'Wirbelpfad', 'wind', 0, 14.3, 'Beschw√∂rt Wind-Minion.', 'MINION', 'Pl√§nkler.', { t: 'special', summonMinion: true, minionEl: 'wind', tags: ['MINION'] }),
          sk('wie9', 'Zyklonwesen', 'wind', 0, 11.2, 'Beschw√∂rt Sturm-Helfer.', 'MINION', 'W√§chter.', { t: 'special', summonMinion: true, minionEl: 'wind', tags: ['MINION'] }),
        ], passive: [
          sk('wip1', 'Leichtf√º√üig', 'wind', 0, 0, 'Dash-CD -35%.', 'Dash -35%', 'Mobilit√§t.', { t: 'passive', pid: 'leicht', dashMult: .65 }),
          sk('wip2', 'Statik', 'wind', 0, 0, 'Bewegen l√§dt n√§chsten Angriff (+40%).', '+40% nach Bewegung', 'Stark.', { t: 'passive', pid: 'statik' }),
          sk('wip3', 'B√∂e', 'wind', 0, 0, '20% Chance: Projektile automatisch ausweichen.', '20% Auto-Dodge', 'Phase 3.', { t: 'passive', pid: 'boe', dodge: .2 }),
          sk('wip4', 'Sturmherz', 'wind', 0, 0, 'Gegner-Kill heilt 15 HP.', '+15 HP on Kill', 'W√§chter.', { t: 'passive', pid: 'sturmherz', killHeal: 15 }),
          sk('wip5', 'Orkankraft', 'wind', 0, 0, '+20% Elementarschaden.', '+20% Elem Dmg', 'Zerst√∂rer.', { t: 'passive', pid: 'orkankr', elemDmg: 1.2 }),
          sk('wip6', 'Brisenseele', 'wind', 0, 0, '+30 Max HP.', '+30 Max HP', 'Bewahrer.', { t: 'passive', pid: 'brisens', bonusHP: 30 }),
          sk('wip7', 'Windinstinkt', 'wind', 0, 0, 'Alle Cooldowns -15%.', '-15% CDs', 'Taktiker.', { t: 'passive', pid: 'windindst', cdReduce: .15 }),
          sk('wip8', 'Luftl√§ufer', 'wind', 0, 0, '+15% Bewegungsspeed.', '+15% Speed', 'Pl√§nkler.', { t: 'passive', pid: 'luftlauf', spdMult: 1.15 }),
          sk('wip9', 'Zyklonwille', 'wind', 0, 0, 'Reflektiert 10 Schaden.', '10 Thorns', 'W√§chter.', { t: 'passive', pid: 'zyklonwille', thorns: 10 }),
        ]
      },
      nature: {
        lmb: [
          sk('nl1', 'Dornen-Pfeil', 'nature', 16, .55, 'Bleibt stecken, Gift-DoT 4s.', 'GIFT 7/s', 'Gift.', { t: 'proj', speed: 447, r: 8, poison: { d: 7, dur: 4 }, tags: ['GIFT'] }),
          sk('nl2', 'Gift-Spucke', 'nature', 11, .70, 'Hinterl√§sst Pf√ºtze mit Gift.', 'GIFT-ZONE', 'Zone.', { t: 'proj', speed: 334, r: 10, poisonZ: true, tags: ['PF√úTZE'] }),
          sk('nl3', 'Blatt-Klinge', 'nature', 14, .70, 'Zielsucht (Homing), geringer Schaden.', 'HOMING', 'Sicher.', { t: 'proj', speed: 331, r: 9, homing: true, tags: ['HOMING'] }),
        ], rmb: [
          sk('nr1', 'Ranken-Peitsche', 'nature', 34, 9, 'Hook: Zieht dich zum Gegner hin.', 'PULL-SELF', 'Aggressiv.', { t: 'hook', root: .5, dmg: 34, tags: ['HOOK'] }),
          sk('nr2', 'Sporen-Bombe', 'nature', 30, 10, 'Telegraph 0.7s, vergiftet Bereich.', 'GIFT 5s', 'Zone.', { t: 'daoe', delay: .7, r: 100, dmg: 30, poison: { d: 10, dur: 5 }, tags: ['TELEGRAPHED', 'GIFT'] }),
          sk('nr3', 'Wurzel-Schlag', 'nature', 25, 8, 'Projektil, Root 1s.', 'ROOT 1s', 'Setup.', { t: 'proj', speed: 382, r: 12, root: 1, tags: ['ROOT'] }),
        ], q: [
          sk('nq1', 'Wurzel-Griff', 'nature', 18, 10, 'Telegraph 0.5s, Root 3s im Bereich.', 'ROOT 3s', 'CC.', { t: 'daoe', delay: .5, r: 80, stun: 3, dmg: 18, tags: ['TELEGRAPHED', 'ROOT'] }),
          sk('nq2', 'Heil-Bl√ºte', 'nature', 0, 14, 'Pflanze, die Heil-Sph√§ren droppt.', 'HEAL 10HP/s', 'Sustain.', { t: 'zone', r: 60, healZ: { a: 10, iv: 1.5 }, life: 8, tags: ['HEILUNG'] }),
          sk('nq3', 'Gift-Ranke', 'nature', 0, 11, 'Wand die verlangsamt und vergiftet.', 'SLOW+GIFT-WAND', 'Zoning.', { t: 'wall', ww: 12, wh: 110, poison: { d: 8 }, slow: { f: .5 }, life: 5, tags: ['TERRAIN'] }),
        ], e: [
          sk('ne1', 'Parasit', 'nature', 0, 12, 'Markiert Gegner: Hits heilen dich 6s.', 'LIFESTEAL-MARK 6s', 'Sustain.', { t: 'proj', speed: 380, r: 11, healMark: 6, tags: ['LIFESTEAL'] }),
          sk('ne2', '√úberwucherung', 'nature', 0, 14, 'Team-CDs ticken 40% schneller 6s.', 'TEAM CDR 40%', 'Support.', { t: 'buff', teamCDR: { f: .6, dur: 6 }, tags: ['CDR'] }),
          sk('ne3', 'Treant-Ruf', 'nature', 0, 14, 'Beschw√∂rt kleinen Tank-Minion.', 'MINION', 'Ablenkung.', { t: 'special', summonMinion: true, tags: ['MINION'] }),
        ], passive: [
          sk('np1', 'Dornen-Haut', 'nature', 0, 0, 'Angreifer erhalten 10 Thorns zur√ºck.', '10 Thorns', 'Rache.', { t: 'passive', pid: 'dornen', thorns: 10 }),
          sk('np2', 'Photosynthese', 'nature', 0, 0, 'Stehenbleiben: 8HP/s Regen.', 'Stehend +8HP/s', 'Regen.', { t: 'passive', pid: 'photo', photoRegen: 8 }),
          sk('np3', 'Symbiose', 'nature', 0, 0, 'Heilung auf dich +30%.', 'Heilung +30%', 'Stack.', { t: 'passive', pid: 'sym', healBonus: 1.3 }),
        ]
      },
      light: {
        lmb: [
          sk('lil1', 'Laser', 'light', 24, .50, 'Sofort-Treffer (Hitscan), kein Flug-Speed.', 'SOFORT', 'Pr√§zise.', { t: 'hitscan', range: 360, tags: ['HITSCAN'] }),
          sk('lil2', 'Licht-Orb', 'light', 19, .65, 'Langsam, pulsiert AoE-Schaden im Flug.', 'AoE 30px', 'Abdeckung.', { t: 'proj', speed: 340, r: 13, pulseAoe: 30, tags: ['PULS'] }),
          sk('lil3', 'Smite', 'light', 32, .70, 'Blitzschlag-Verz√∂gerung, Blind 1.2s.', 'BLIND 1.2s', 'Gruppe.', { t: 'daoe', delay: .5, r: 44, blind: 1.2, dmg: 32, tags: ['BLITZ'] }),
          sk('lil4', 'Lichtpfeil', 'light', 22, .52, 'Schneller Lichtstrahl.', 'BLIND 0.5s', 'W√§chter.', { t: 'proj', speed: 550, r: 8, blind: .5, tags: ['SCHNELL'] }),
          sk('lil5', 'Strahlenkegel', 'light', 31, .58, 'Kegelstrahl, blendet.', 'BLIND 0.8s', 'Zerst√∂rer.', { t: 'beam', range: 150, cA: .40, blind: .8, tags: ['KEGEL'] }),
          sk('lil6', 'Prismenschuss', 'light', 23, .63, 'Projektil, heilt leicht.', '+5 HEAL', 'Bewahrer.', { t: 'proj', speed: 480, r: 9, healHit: 5, tags: ['HEILUNG'] }),
          sk('lil7', 'Glorienstrahl', 'light', 25, .65, 'Kegelstrahl, Licht-Effekt.', 'BLIND 0.6s', 'Taktiker.', { t: 'beam', range: 150, cA: .42, blind: .6, tags: ['KEGEL'] }),
          sk('lil8', 'Sonnennadel', 'light', 28, .42, 'Extrem schneller Lichtpfeil.', 'kein Status', 'Pl√§nkler.', { t: 'proj', speed: 600, r: 7, tags: ['SCHNELL'] }),
          sk('lil9', 'Heiligenschein', 'light', 17, .71, 'Kegelstrahl, breiter Bereich.', 'BLIND 0.4s', 'W√§chter.', { t: 'beam', range: 150, cA: .48, blind: .4, tags: ['KEGEL'] }),
        ], rmb: [
          sk('lir1', 'Blend-Granate', 'light', 21, 9, 'Projektil-AoE, Blind 3s.', 'BLIND 3s', 'Konter.', { t: 'proj', speed: 352, r: 14, aoe: 108, blind: 3, tags: ['BLIND'] }),
          sk('lir2', 'Lichtschwert', 'light', 78, 10, 'Gro√üer Nahkampf-Schwung, KB.', 'KB 120', 'Dmg.', { t: 'aoe', r: 115, kb: 120, tags: ['NAHKAMPF'] }),
          sk('lir3', 'Prisma-Strahl', 'light', 35, 9, 'Teilt sich in 3 Strahlen auf.', '3√ó Strahlen', 'Multi.', { t: 'multi', cnt: 3, speed: 511, r: 9, tags: ['SPLIT'] }),
          sk('lir4', 'Lichtkugel', 'light', 83, 5.3, 'Sofort, AoE 80, Blind.', 'BLIND 1.5s', 'W√§chter.', { t: 'proj', speed: 360, r: 16, aoe: 80, blind: 1.5, tags: ['SOFORT'] }),
          sk('lir5', 'Strahlensto√ü', 'light', 105, 5.5, 'Sofort, massiver Lichtschaden.', 'BLIND 2s', 'Zerst√∂rer.', { t: 'proj', speed: 380, r: 18, aoe: 80, blind: 2, tags: ['SOFORT'] }),
          sk('lir6', 'Prismenbogen', 'light', 82, 7.5, 'Aufladbar, Heileffekt.', '+20 HEAL', 'Bewahrer.', { t: 'proj', speed: 280, r: 20, healHit: 20, tags: ['AUFGELADEN'] }),
          sk('lir7', 'Glorienblitz', 'light', 103, 4.6, 'Aufladbar, schneller CD.', 'BLIND 1s', 'Taktiker.', { t: 'proj', speed: 300, r: 16, blind: 1, tags: ['AUFGELADEN'] }),
          sk('lir8', 'Sonnenkanone', 'light', 63, 4.3, 'Aufladbar, hoher DPS.', 'BLIND 1.5s', 'Pl√§nkler.', { t: 'proj', speed: 260, r: 22, blind: 1.5, tags: ['AUFGELADEN'] }),
          sk('lir9', 'Heiligenkoloss', 'light', 91, 8.0, 'Sofort, breiter AoE.', 'BLIND 1s', 'W√§chter.', { t: 'proj', speed: 380, r: 18, aoe: 80, blind: 1, tags: ['SOFORT'] }),
        ], q: [
          sk('lq1', 'Schutz-Engel', 'light', 0, 12, 'Schild 150HP f√ºr Verb√ºndeten/dich.', 'SCHILD 150HP', 'Tank.', { t: 'buff', shield: 150, tags: ['SCHILD'] }),
          sk('lq2', 'Flash', 'light', 0, 11, 'Sofort-Teleport zur Mausposition.', 'BLINK', 'Escape.', { t: 'special', blink: true, tags: ['BLINK'] }),
          sk('lq3', 'Reinigung', 'light', 0, 10, 'Entfernt CC-Effekte (Stun, Root).', 'CLEANSE CC', 'Konter.', { t: 'buff', cleanse: true, tags: ['CLEANSE'] }),
          sk('lq4', 'Lichtmantel', 'light', 0, 9.5, 'AoE-Blind im Bereich.', 'BLIND 2s', 'W√§chter.', { t: 'aoe', r: 150, blind: 2, tags: ['CC'] }),
          sk('lq5', 'Strahlenmantel', 'light', 8, 9.0, 'AoE-Blind, gr√∂√üerer Bereich.', 'BLIND 2s', 'Zerst√∂rer.', { t: 'aoe', r: 150, blind: 2, tags: ['CC'] }),
          sk('lq6', 'Prismenlauf', 'light', 12, 10.5, 'Licht-Dash, hellt Zone auf.', 'DASH+BLIND', 'Bewahrer.', { t: 'dashSkill', range: 250, blind: 1, tags: ['DASH'] }),
          sk('lq7', 'Gloriensprung', 'light', 10, 9.3, 'Dash mit Heal-Nacheffekt.', 'DASH+HEAL', 'Taktiker.', { t: 'dashSkill', range: 250, healHit: 10, tags: ['DASH'] }),
          sk('lq8', 'Sonnenschild', 'light', 3, 10.8, 'Licht-Schild +50 HP.', 'SCHILD 50HP', 'Pl√§nkler.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
          sk('lq9', 'Heiligenpanzer', 'light', 2, 8.5, 'Licht-Schild +50 HP.', 'SCHILD 50HP', 'W√§chter.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
        ], e: [
          sk('le1', 'Gesegneter Boden', 'light', 0, 12, 'Zone +50% Angriffskraft 6s.', 'DMGBUFF-ZONE', 'Offense.', { t: 'zone', r: 80, dmgBuffZone: { f: 1.5, dur: 6 }, life: 6, tags: ['BUFF-ZONE'] }),
          sk('le2', 'Ketten-Blitz', 'light', 40, 10, 'Springt von Feind zu Feind, heilt dich.', 'CHAIN +20HP', 'Multi.', { t: 'special', chainLightning: true, chainDmg: 40, chainHeal: 20, tags: ['CHAIN'] }),
          sk('le3', 'Wiederbelebung', 'light', 0, 30, 'Wiederbelebt toten Spieler sofort.', 'REVIVE', 'Einmalig.', { t: 'special', revive: true, tags: ['REVIVE'] }),
          sk('le4', 'Lichtfeld', 'light', 40, 14.5, 'Projektil schw√§cht Gegner.', 'WEAKNESS 4s', 'W√§chter.', { t: 'proj', speed: 380, r: 12, weakness: { f: .7, dur: 4 }, tags: ['DEBUFF'] }),
          sk('le5', 'Strahlenzone', 'light', 40, 11.5, 'Projektil-Debuff, st√§rker.', 'WEAKNESS 4s', 'Zerst√∂rer.', { t: 'proj', speed: 360, r: 12, weakness: { f: .6, dur: 4 }, tags: ['DEBUFF'] }),
          sk('le6', 'Prismenkreis', 'light', 0, 13.7, 'Bleibende Licht-Zone 6s, 15/tick.', 'ZONE 6s', 'Bewahrer.', { t: 'zone', r: 120, life: 6, dmgTick: 15, tags: ['ZONE'] }),
          sk('le7', 'Gloriengrube', 'light', 0, 10.6, 'Licht-Zone, schadet+blendet.', 'ZONE 6s', 'Taktiker.', { t: 'zone', r: 120, life: 6, dmgTick: 15, blind: .5, tags: ['ZONE'] }),
          sk('le8', 'Sonnenfreund', 'light', 0, 12.5, 'Beschw√∂rt Licht-Minion.', 'MINION', 'Pl√§nkler.', { t: 'special', summonMinion: true, minionEl: 'light', tags: ['MINION'] }),
          sk('le9', 'Heiligengeist', 'light', 0, 11.1, 'Beschw√∂rt Licht-Helfer.', 'MINION', 'W√§chter.', { t: 'special', summonMinion: true, minionEl: 'light', tags: ['MINION'] }),
        ], passive: [
          sk('lip1', 'Hoffnung', 'light', 0, 0, 'Erhaltene Heilung/Schilde +30%.', '+30% Heal/Schild', 'Stack.', { t: 'passive', pid: 'hoff', healBonus: 1.3 }),
          sk('lip2', 'Solar-Energie', 'light', 0, 0, 'R-Ulti l√§dt passiv auf (CD -30%).', '-30% R-CD', 'Ulti.', { t: 'passive', pid: 'solar', fusionCDR: .3 }),
          sk('lip3', 'Blendende R√ºstung', 'light', 0, 0, 'Angreifer werden kurz geblendet.', 'Angreifer BLIND', 'Def.', { t: 'passive', pid: 'blend2' }),
          sk('lip4', 'Lichtherz', 'light', 0, 0, 'Gegner-Kill heilt 15 HP.', '+15 HP on Kill', 'W√§chter.', { t: 'passive', pid: 'lichtherz', killHeal: 15 }),
          sk('lip5', 'Strahlenmacht', 'light', 0, 0, '+20% Elementarschaden.', '+20% Elem Dmg', 'Zerst√∂rer.', { t: 'passive', pid: 'strahlenmacht', elemDmg: 1.2 }),
          sk('lip6', 'Prismenseele', 'light', 0, 0, '+30 Max HP.', '+30 Max HP', 'Bewahrer.', { t: 'passive', pid: 'prismens', bonusHP: 30 }),
          sk('lip7', 'Glorieninstinkt', 'light', 0, 0, 'Alle Cooldowns -15%.', '-15% CDs', 'Taktiker.', { t: 'passive', pid: 'glorieninst', cdReduce: .15 }),
          sk('lip8', 'Sonnenl√§ufer', 'light', 0, 0, '+15% Bewegungsspeed.', '+15% Speed', 'Pl√§nkler.', { t: 'passive', pid: 'sonnenlauf', spdMult: 1.15 }),
          sk('lip9', 'Heiligenwille', 'light', 0, 0, 'Reflektiert 10 Licht-Schaden.', '10 Thorns', 'W√§chter.', { t: 'passive', pid: 'heiligenwille', thorns: 10 }),
        ]
      },
      darkness: {
        lmb: [
          sk('dl1', 'Schatten-Bolzen', 'darkness', 17, .60, 'St√§rker je weiter er fliegt. +8 Lifesteal.', 'DISTANZ-SKALA+LIFESTEAL', 'Lange Distanz.', { t: 'proj', speed: 456, r: 9, rangeMult: 2.5, healHit: 8, tags: ['LIFESTEAL'] }),
          sk('dl2', 'Sense', 'darkness', 26, .65, 'Breiter Nahkampf-Schwung. +10 Lifesteal.', 'LIFESTEAL +10', 'Sustain.', { t: 'aoe', r: 110, healHit: 10, tags: ['NAHKAMPF'] }),
          sk('dl3', 'Leeren-Kugel', 'darkness', 20, .70, 'Geht durch W√§nde hindurch. +6 Lifesteal.', 'DURCH-W√ÑNDE+LIFESTEAL', 'Walls.', { t: 'proj', speed: 483, r: 10, throughWalls: true, healHit: 6, tags: ['DURCH-W√ÑNDE'] }),
          sk('dl4', 'Schattensplitter', 'darkness', 23, .53, 'Schnelles Projektil, Lifesteal.', '+6 LIFESTEAL', 'W√§chter.', { t: 'proj', speed: 480, r: 8, healHit: 6, tags: ['SCHNELL'] }),
          sk('dl5', 'Fluchkegel', 'darkness', 29, .60, 'Kegelstrahl, Schatten-DoT.', 'SHADOW 6/s', 'Zerst√∂rer.', { t: 'beam', range: 150, cA: .40, poison: { d: 6, dur: 3 }, tags: ['KEGEL'] }),
          sk('dl6', 'Leerepfeil', 'darkness', 22, .67, 'Projektil mit Lifesteal.', '+8 LIFESTEAL', 'Bewahrer.', { t: 'proj', speed: 450, r: 9, healHit: 8, tags: ['LIFESTEAL'] }),
          sk('dl7', 'Seelenstrahl', 'darkness', 20, .68, 'Kegelstrahl, Lifesteal.', '+5 LIFESTEAL', 'Taktiker.', { t: 'beam', range: 150, cA: .42, healHit: 5, tags: ['KEGEL'] }),
          sk('dl8', 'Nachtnadel', 'darkness', 25, .44, 'Schnelles Projektil, niedriger CD.', '+4 LIFESTEAL', 'Pl√§nkler.', { t: 'proj', speed: 520, r: 7, healHit: 4, tags: ['SCHNELL'] }),
          sk('dl9', 'Dunkelhieb', 'darkness', 18, .72, 'Kegelstrahl, breiter Bereich.', '+5 LIFESTEAL', 'W√§chter.', { t: 'beam', range: 150, cA: .48, healHit: 5, tags: ['KEGEL'] }),
        ], rmb: [
          sk('dr1', 'Seelen-Raub', 'darkness', 16, 10, 'Channelstrahl, Lifesteal 100%.', 'LIFESTEAL 100%', 'Drain.', { t: 'beam', range: 265, healHit: 16, tags: ['DRAIN'] }),
          sk('dr2', 'Furcht-Schrei', 'darkness', 0, 11, 'Telegraph 0.65s, Fear-AoE 2s.', 'FEAR 2s', 'Abstand.', { t: 'daoe', delay: .65, r: 135, fear: 2, dmg: 0, tags: ['TELEGRAPHED', 'FEAR'] }),
          sk('dr3', 'Schatten-Sprung', 'darkness', 44, 9, 'Teleport hinter Gegner, immer kritisch.', 'TELEPORT+KRIT', 'Backstab.', { t: 'special', teleportBehind: true, critBuff: 2, tags: ['TELEPORT'] }),
          sk('dr4', 'Schattenkugel', 'darkness', 62, 4.3, 'Sofort, AoE 80, Lifesteal.', '+15 LIFESTEAL', 'W√§chter.', { t: 'proj', speed: 360, r: 16, aoe: 80, healHit: 15, tags: ['SOFORT'] }),
          sk('dr5', 'Fluchball', 'darkness', 109, 5.3, 'Sofort, massiver Schaden.', 'FEAR 1s', 'Zerst√∂rer.', { t: 'proj', speed: 380, r: 18, aoe: 80, fear: 1, tags: ['SOFORT'] }),
          sk('dr6', 'Leeresto√ü', 'darkness', 88, 7.5, 'Aufladbar, hoher Einzelschaden.', 'FEAR 1.5s', 'Bewahrer.', { t: 'proj', speed: 280, r: 20, fear: 1.5, tags: ['AUFGELADEN'] }),
          sk('dr7', 'Seelenramme', 'darkness', 99, 4.7, 'Aufladbar, schneller CD.', '+20 LIFESTEAL', 'Taktiker.', { t: 'proj', speed: 300, r: 16, healHit: 20, tags: ['AUFGELADEN'] }),
          sk('dr8', 'Nachtbombe', 'darkness', 103, 4.2, 'Aufladbar, hoher DPS.', 'FEAR 1s', 'Pl√§nkler.', { t: 'proj', speed: 260, r: 22, fear: 1, tags: ['AUFGELADEN'] }),
          sk('dr9', 'Dunkelkoloss', 'darkness', 69, 8.0, 'Sofort, breiter AoE.', '+18 LIFESTEAL', 'W√§chter.', { t: 'proj', speed: 380, r: 18, aoe: 80, healHit: 18, tags: ['SOFORT'] }),
        ], q: [
          sk('dq1', 'Unsichtbarkeit', 'darkness', 0, 14, '3s Stealth, erster Angriff kritisch.', 'STEALTH 3s‚ÜíKRIT', 'Opener.', { t: 'buff', stealth: true, critMult: 2.5, tags: ['STEALTH'] }),
          sk('dq2', 'Verderbnis', 'darkness', 10, 11, 'Boden-Zone: Schaden+Lifesteal 5s.', '12/s DMG+8/s HEAL', 'Sustain.', { t: 'zone', r: 88, dmgTick: 12, healTick: 8, life: 5, tags: ['ZONE'] }),
          sk('dq3', 'Fluch der Schw√§che', 'darkness', 0, 12, 'Gegner macht 50% weniger Schaden 6s.', 'BOSS -50%', 'Konter.', { t: 'special', curseE: { dur: 6, dr: .5 }, tags: ['FLUCH'] }),
          sk('dq4', 'Schattenmantel', 'darkness', 0, 8.0, 'AoE-Slow im Bereich.', 'SLOW 2s', 'W√§chter.', { t: 'aoe', r: 150, slow: { f: .5, dur: 2 }, tags: ['CC'] }),
          sk('dq5', 'Fluchschleier', 'darkness', 6, 11.4, 'AoE-Slow, gr√∂√üerer Bereich.', 'SLOW 2s', 'Zerst√∂rer.', { t: 'aoe', r: 150, slow: { f: .6, dur: 2 }, tags: ['CC'] }),
          sk('dq6', 'Leereschritt', 'darkness', 20, 11.1, 'Shadow-Dash durch Feinde.', 'DASH+FEAR', 'Bewahrer.', { t: 'dashSkill', range: 250, fear: 1, tags: ['DASH'] }),
          sk('dq7', 'Seelenpanzer', 'darkness', 19, 11.3, 'Dash mit Lifesteal-Trail.', 'DASH+HEAL', 'Taktiker.', { t: 'dashSkill', range: 250, healHit: 12, tags: ['DASH'] }),
          sk('dq8', 'Nachtlauf', 'darkness', 13, 11.4, 'Schatten-Schild +50 HP.', 'SCHILD 50HP', 'Pl√§nkler.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
          sk('dq9', 'Dunkelform', 'darkness', 3, 9.5, 'Dunkel-Schild +50 HP.', 'SCHILD 50HP', 'W√§chter.', { t: 'buff', shield: 50, tags: ['SCHILD'] }),
        ], e: [
          sk('de1', 'Opferung', 'darkness', 120, 14, 'Kostet 30 eigene HP, massiver Schaden.', 'TRUE DMG -30HP', 'All-In.', { t: 'special', sacrifice: { selfCost: 30, dmg: 120 }, tags: ['OPFER'] }),
          sk('de2', 'Stille', 'darkness', 0, 12, 'Projektil: Gegner kann 4s keine Skills nutzen.', 'SILENCE 4s', 'Konter.', { t: 'proj', speed: 340, r: 12, silence: 4, tags: ['SILENCE'] }),
          sk('de3', 'Schwarzes Loch', 'darkness', 0, 14, 'Zone 4s: saugt Projektile ein, zieht Gegner ran.', 'PROJ-DELETE+PULL', 'Kontrolle.', { t: 'zone', r: 80, life: 4, blackHole: true, pull: 60, tags: ['SCHWARZES LOCH'] }),
          sk('de4', 'Schattenfeld', 'darkness', 40, 14.5, 'Projektil schw√§cht Gegner.', 'WEAKNESS 4s', 'W√§chter.', { t: 'proj', speed: 380, r: 12, weakness: { f: .7, dur: 4 }, tags: ['DEBUFF'] }),
          sk('de5', 'Fluchzone', 'darkness', 40, 11.5, 'Projektil-Debuff, st√§rker.', 'WEAKNESS 4s', 'Zerst√∂rer.', { t: 'proj', speed: 360, r: 12, weakness: { f: .6, dur: 4 }, tags: ['DEBUFF'] }),
          sk('de6', 'Leerekreis', 'darkness', 0, 13.7, 'Bleibende Schatten-Zone 6s, 15/tick.', 'ZONE 6s', 'Bewahrer.', { t: 'zone', r: 120, life: 6, dmgTick: 15, tags: ['ZONE'] }),
          sk('de7', 'Seelengrube', 'darkness', 0, 10.6, 'Schatten-Zone, Lifesteal.', 'ZONE 6s', 'Taktiker.', { t: 'zone', r: 120, life: 6, dmgTick: 15, healTick: 5, tags: ['ZONE'] }),
          sk('de8', 'Nachtfeld', 'darkness', 0, 12.5, 'Beschw√∂rt Schatten-Minion.', 'MINION', 'Pl√§nkler.', { t: 'special', summonMinion: true, minionEl: 'darkness', tags: ['MINION'] }),
          sk('de9', 'Dunkelzone', 'darkness', 0, 11.1, 'Beschw√∂rt Dunkel-Helfer.', 'MINION', 'W√§chter.', { t: 'special', summonMinion: true, minionEl: 'darkness', tags: ['MINION'] }),
        ], passive: [
          sk('dp1', 'Vampir', 'darkness', 0, 0, '5% Lifesteal auf alles.', '5% Lifesteal', 'Sustain.', { t: 'passive', pid: 'vamp', lifesteal: .05 }),
          sk('dp2', 'Exekution', 'darkness', 0, 0, 'Gegner unter 15% HP: +80% Schaden.', '<15%‚Üí+80%', 'Finisher.', { t: 'passive', pid: 'exek' }),
          sk('dp3', 'Nachtwandler', 'darkness', 0, 0, 'W√§hrend Stealth: +30% Speed.', 'Stealth +30%', 'Opener.', { t: 'passive', pid: 'nacht' }),
          sk('dp4', 'Schattenherz', 'darkness', 0, 0, 'Gegner-Kill heilt 15 HP.', '+15 HP on Kill', 'W√§chter.', { t: 'passive', pid: 'schattenherz', killHeal: 15 }),
          sk('dp5', 'Leerepuls', 'darkness', 0, 0, '+20% Elementarschaden.', '+20% Elem Dmg', 'Zerst√∂rer.', { t: 'passive', pid: 'leerepuls', elemDmg: 1.2 }),
          sk('dp6', 'Dunkelseele', 'darkness', 0, 0, '+30 Max HP.', '+30 Max HP', 'Bewahrer.', { t: 'passive', pid: 'dunkelseele', bonusHP: 30 }),
          sk('dp7', 'Fluchzeichen', 'darkness', 0, 0, 'Alle Cooldowns -15%.', '-15% CDs', 'Taktiker.', { t: 'passive', pid: 'fluchzeichen', cdReduce: .15 }),
          sk('dp8', 'Nachtinstinkt', 'darkness', 0, 0, '+15% Bewegungsspeed.', '+15% Speed', 'Pl√§nkler.', { t: 'passive', pid: 'nachtinst', spdMult: 1.15 }),
          sk('dp9', 'Abgrundwille', 'darkness', 0, 0, 'Reflektiert 10 Schatten-Schaden.', '10 Thorns', 'W√§chter.', { t: 'passive', pid: 'abgrundwille', thorns: 10 }),
        ]
      },
    };

    // ‚îÄ‚îÄ‚îÄ FUSIONS: 3 Varianten pro Kombo (aus CSV) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const FUS3 = {
      'fire+water': [
        { variant: 1, n: 'Dampfwalze', e: 'üí®', el: 'fire', d: 'AoE 160px, 100 Dmg, Blind 3s + Burn.', fx: 'steamRoll', cd: 21 },
        { variant: 2, n: 'Kochender Regen', e: 'üåß', el: 'water', d: 'Gro√üer AoE, schmilzt R√ºstung, Stun 2s.', fx: 'boilingRain', cd: 21 },
        { variant: 3, n: 'Explosive Blasen', e: 'üí¢', el: 'fire', d: 'Schwebende Minen 8s, platzen bei Ber√ºhrung.', fx: 'explodingBubbles', cd: 20 },
        { variant: 4, n: 'Dampfexplosion', e: 'üí®', el: 'fire', d: '236 Dmg, AoE 300, Transformation.', fx: 'steamExplosion', cd: 34 },
        { variant: 5, n: 'Kochende Welle', e: 'üåß', el: 'water', d: '268 Dmg, AoE 300, Beschw√∂rung.', fx: 'boilingWave', cd: 25 },
        { variant: 6, n: 'Dampfhammer', e: 'üí®', el: 'fire', d: '189 Dmg, AoE 300, Globaler Sturm.', fx: 'steamHammer', cd: 29 },
        { variant: 7, n: 'Siedende Flut', e: 'üåä', el: 'water', d: '275 Dmg, AoE 300, Transformation.', fx: 'boilingFlood', cd: 37 },
        { variant: 8, n: 'Hei√üwassergeysir', e: 'üíß', el: 'water', d: '199 Dmg, AoE 300, Beschw√∂rung.', fx: 'hotGeyser', cd: 22 },
        { variant: 9, n: 'Nebelbrand', e: 'üî•', el: 'fire', d: '246 Dmg, AoE 300, Globaler Sturm.', fx: 'fogFire', cd: 31 },
      ],
      'fire+earth': [
        { variant: 1, n: 'Meteor-Hagel', e: 'üåã', el: 'fire', d: 'Mehrere Meteore zerst√∂ren Deckung, Burn.', fx: 'meteorShower', cd: 18 },
        { variant: 2, n: 'Vulkan-Ausbruch', e: 'üî•', el: 'fire', d: 'Vulkanzone 8s spuckt Feuer.', fx: 'volcano', cd: 18 },
        { variant: 3, n: 'Lava-Fluss', e: 'üåä', el: 'fire', d: 'Boden = Todeszone 8s, 30 Dmg/s + Burn.', fx: 'lavaFlow', cd: 21 },
        { variant: 4, n: 'Magmabeben', e: 'üåã', el: 'fire', d: '155 Dmg, AoE 300, Transformation.', fx: 'magmaQuake', cd: 26 },
        { variant: 5, n: 'Feuerstein-Regen', e: 'ü™®', el: 'earth', d: '197 Dmg, AoE 300, Beschw√∂rung.', fx: 'fireStoneRain', cd: 34 },
        { variant: 6, n: 'Lavafall', e: 'üî•', el: 'fire', d: '199 Dmg, AoE 300, Globaler Sturm.', fx: 'lavaFall', cd: 28 },
        { variant: 7, n: 'Erdkern-Eruption', e: 'üåã', el: 'earth', d: '282 Dmg, AoE 300, Transformation.', fx: 'coreEruption', cd: 39 },
        { variant: 8, n: 'Obsidian-Splitter', e: 'ü™®', el: 'earth', d: '264 Dmg, AoE 300, Beschw√∂rung.', fx: 'obsidianShard', cd: 24 },
        { variant: 9, n: 'Vulkanischer Sturm', e: 'üî•', el: 'fire', d: '164 Dmg, AoE 300, Globaler Sturm.', fx: 'volcanicStorm', cd: 30 },
      ],
      'fire+wind': [
        { variant: 1, n: 'Flammen-Tornado', e: 'üåÄ', el: 'fire', d: 'Wandernder Tornado 5s, zieht+verbrennt.', fx: 'fireTornado', cd: 18 },
        { variant: 2, n: 'Hitzeschock', e: 'üí•', el: 'fire', d: 'Globaler Feuerschaden an allem.', fx: 'heatShock', cd: 22 },
        { variant: 3, n: 'Jetpack-Overload', e: 'üöÄ', el: 'wind', d: 'Mehrfach-Bomben-Teppich 8s.', fx: 'jetBombs', cd: 20 },
        { variant: 4, n: 'Feuertornado', e: 'üåÄ', el: 'fire', d: '183 Dmg, AoE 300, Transformation.', fx: 'fireTornado2', cd: 38 },
        { variant: 5, n: 'Glutb√∂e', e: 'üí•', el: 'fire', d: '265 Dmg, AoE 300, Beschw√∂rung.', fx: 'emberGust', cd: 23 },
        { variant: 6, n: 'Hitzeschockwelle', e: 'üî•', el: 'fire', d: '242 Dmg, AoE 300, Globaler Sturm.', fx: 'heatShockwave', cd: 27 },
        { variant: 7, n: 'Infernowirbel', e: 'üå™', el: 'fire', d: '181 Dmg, AoE 300, Transformation.', fx: 'infernoWhirl', cd: 36 },
        { variant: 8, n: 'Flammenstrudel', e: 'üî•', el: 'wind', d: '248 Dmg, AoE 300, Beschw√∂rung.', fx: 'flameVortex', cd: 36 },
        { variant: 9, n: 'Aschenwind', e: 'üå¨', el: 'fire', d: '189 Dmg, AoE 300, Globaler Sturm.', fx: 'ashWind', cd: 29 },
      ],
      'fire+nature': [
        { variant: 1, n: 'Brennende Ranken', e: 'üåø', el: 'fire', d: 'Fesselt Gegner 3s + Burn 20/s.', fx: 'fireVines', cd: 19 },
        { variant: 2, n: 'Phosphor-Sporen', e: '‚òÅ', el: 'nature', d: 'Explosive Pflanzen wachsen √ºberall auf.', fx: 'phosphorSpores', cd: 21 },
        { variant: 3, n: 'Sonnenstrahl', e: '‚òÄ', el: 'fire', d: 'Geb√ºndelter Orbit-Laser, 150 Dmg.', fx: 'sunBeam', cd: 19 },
        { variant: 4, n: 'Feuerreben', e: 'üåø', el: 'fire', d: '252 Dmg, AoE 300, Transformation.', fx: 'fireVines2', cd: 36 },
        { variant: 5, n: 'Glutsporen', e: '‚òÅ', el: 'nature', d: '195 Dmg, AoE 300, Beschw√∂rung.', fx: 'emberSpores', cd: 35 },
        { variant: 6, n: 'Brennende Saat', e: 'üî•', el: 'fire', d: '268 Dmg, AoE 300, Globaler Sturm.', fx: 'burningSeed', cd: 27 },
        { variant: 7, n: 'Pflanzenbrand', e: 'üåø', el: 'nature', d: '293 Dmg, AoE 300, Transformation.', fx: 'plantFire', cd: 23 },
        { variant: 8, n: 'Sonnenranke', e: '‚òÄ', el: 'nature', d: '200 Dmg, AoE 300, Beschw√∂rung.', fx: 'sunVine', cd: 38 },
        { variant: 9, n: 'Phosphorwald', e: 'üå≥', el: 'fire', d: '260 Dmg, AoE 300, Globaler Sturm.', fx: 'phosphorForest', cd: 21 },
      ],
      'fire+light': [
        { variant: 1, n: 'Supernova', e: '‚ö°', el: 'light', d: 'AoE 200px 130 Dmg + Blind 3s.', fx: 'supernova', cd: 22 },
        { variant: 2, n: 'Laser-Gitter', e: 'üîÜ', el: 'light', d: 'Rotierende Laser schneiden durch Arena.', fx: 'laserGrid', cd: 18 },
        { variant: 3, n: 'L√§uterung', e: '‚ú®', el: 'light', d: 'Team heilen + Gegner Vollschaden.', fx: 'purification', cd: 18 },
        { variant: 4, n: 'Solarbrand', e: '‚òÄ', el: 'fire', d: '187 Dmg, AoE 300, Transformation.', fx: 'solarBurn', cd: 26 },
        { variant: 5, n: 'Lichthagel', e: 'üîÜ', el: 'light', d: '207 Dmg, AoE 300, Beschw√∂rung.', fx: 'lightHail', cd: 31 },
        { variant: 6, n: 'Strahlender Inferno', e: 'üî•', el: 'fire', d: '239 Dmg, AoE 300, Globaler Sturm.', fx: 'radiantInferno', cd: 24 },
        { variant: 7, n: 'Heilige Flamme', e: '‚ú®', el: 'light', d: '211 Dmg, AoE 300, Transformation.', fx: 'holyFlame', cd: 34 },
        { variant: 8, n: 'Sonnenkern', e: '‚òÄ', el: 'fire', d: '242 Dmg, AoE 300, Beschw√∂rung.', fx: 'sunCore', cd: 21 },
        { variant: 9, n: 'G√∂ttliche Eruption', e: 'üåã', el: 'fire', d: '177 Dmg, AoE 300, Globaler Sturm.', fx: 'divineEruption', cd: 25 },
      ],
      'fire+darkness': [
        { variant: 1, n: 'Schwarze Flamme', e: 'üñ§', el: 'fire', d: 'True Damage 200 an allem in 180px.', fx: 'blackFlame', cd: 19 },
        { variant: 2, n: 'D√§monen-Pakt', e: 'üòà', el: 'darkness', d: '8s Melee-Form: Life-Drain+Schaden.', fx: 'demonPact', cd: 21 },
        { variant: 3, n: 'Schatten-Explosion', e: 'üí£', el: 'darkness', d: 'Detoniert Schatten aller Gegner, AoE.', fx: 'shadowExplode', cd: 21 },
        { variant: 4, n: 'H√∂llenfeuer', e: 'üñ§', el: 'fire', d: '183 Dmg, AoE 300, Transformation.', fx: 'hellfire2', cd: 29 },
        { variant: 5, n: 'Schattendetonation', e: 'üí£', el: 'darkness', d: '243 Dmg, AoE 300, Beschw√∂rung.', fx: 'shadowDet', cd: 31 },
        { variant: 6, n: 'Dunkle Eruption', e: 'üåë', el: 'darkness', d: '162 Dmg, AoE 300, Globaler Sturm.', fx: 'darkEruption', cd: 27 },
        { variant: 7, n: 'Geisterflamme', e: 'üëª', el: 'fire', d: '274 Dmg, AoE 300, Transformation.', fx: 'ghostFlame', cd: 25 },
        { variant: 8, n: 'Verderbensfeuer', e: 'üî•', el: 'darkness', d: '215 Dmg, AoE 300, Beschw√∂rung.', fx: 'corruptFire', cd: 22 },
        { variant: 9, n: 'D√§monenpyre', e: 'üòà', el: 'fire', d: '276 Dmg, AoE 300, Globaler Sturm.', fx: 'demonPyre', cd: 33 },
      ],
      'water+earth': [
        { variant: 1, n: 'Erdrutsch', e: 'üåä', el: 'water', d: 'Riesige Matsch-Welle, Stun 3s + Slow.', fx: 'mudslide', cd: 20 },
        { variant: 2, n: 'Sumpf-Monster', e: 'üêä', el: 'earth', d: 'Beschw√∂rt Golem, verlangsamt+schl√§gt.', fx: 'swampGolem', cd: 19 },
        { variant: 3, n: 'Treibsand-Grube', e: 'üï≥', el: 'earth', d: 'Riesige Zone 8s zieht Gegner nach unten.', fx: 'sandPit', cd: 22 },
        { variant: 4, n: 'Schlammstrom', e: 'üåä', el: 'water', d: '184 Dmg, AoE 300, Transformation.', fx: 'mudStream', cd: 29 },
        { variant: 5, n: 'Sumpfbrocken', e: 'üêä', el: 'earth', d: '256 Dmg, AoE 300, Beschw√∂rung.', fx: 'swampChunk', cd: 31 },
        { variant: 6, n: 'Erdrutschflut', e: 'üåä', el: 'water', d: '162 Dmg, AoE 300, Globaler Sturm.', fx: 'mudFlood', cd: 36 },
        { variant: 7, n: 'Tiefengraben', e: 'üï≥', el: 'earth', d: '202 Dmg, AoE 300, Transformation.', fx: 'deepTrench', cd: 35 },
        { variant: 8, n: 'Erdbebenflut', e: 'üåä', el: 'water', d: '186 Dmg, AoE 300, Beschw√∂rung.', fx: 'quakeFlood', cd: 36 },
        { variant: 9, n: 'Schlammlawine', e: 'üêä', el: 'earth', d: '223 Dmg, AoE 300, Globaler Sturm.', fx: 'mudSlide2', cd: 38 },
      ],
      'water+wind': [
        { variant: 1, n: 'Blizzard', e: 'üå®', el: 'water', d: 'Gefriert alles 2s (Global Freeze).', fx: 'blizzard', cd: 24 },
        { variant: 2, n: 'Monsun', e: 'üåß', el: 'water', d: 'St√∂√üt alles weg + heilt Team massiv.', fx: 'monsoon', cd: 19 },
        { variant: 3, n: 'Eis-Splitter-Sturm', e: 'üå™', el: 'water', d: 'Maschinengewehr Eis-Projektile 3s.', fx: 'iceStorm', cd: 21 },
        { variant: 4, n: 'Sturmwelle', e: 'üåä', el: 'water', d: '221 Dmg, AoE 300, Transformation.', fx: 'stormWave', cd: 35 },
        { variant: 5, n: 'Eistornado', e: 'üå™', el: 'water', d: '154 Dmg, AoE 300, Beschw√∂rung.', fx: 'iceTornado', cd: 23 },
        { variant: 6, n: 'Gefrierb√∂e', e: 'üå®', el: 'water', d: '256 Dmg, AoE 300, Globaler Sturm.', fx: 'freezeGust', cd: 38 },
        { variant: 7, n: 'Schneesturm', e: '‚ùÑ', el: 'water', d: '151 Dmg, AoE 300, Transformation.', fx: 'snowStorm', cd: 26 },
        { variant: 8, n: 'Frostwirbel', e: 'üåÄ', el: 'water', d: '184 Dmg, AoE 300, Beschw√∂rung.', fx: 'frostWhirl', cd: 30 },
        { variant: 9, n: 'Eisschauer', e: 'üå®', el: 'water', d: '253 Dmg, AoE 300, Globaler Sturm.', fx: 'iceShower', cd: 36 },
      ],
      'water+nature': [
        { variant: 1, n: 'Sumpf des Lebens', e: 'üå±', el: 'nature', d: 'Heil-Zone 8s + Slow.', fx: 'lifeSwamp', cd: 18 },
        { variant: 2, n: 'Riesen-Seerose', e: 'üå∏', el: 'water', d: 'Riesiges Schild absorbiert Schaden 8s.', fx: 'giantLily', cd: 19 },
        { variant: 3, n: 'Gift-Regen', e: '‚ò†', el: 'nature', d: 'Saurer Regen 8s, 20 Dmg/s + Gift.', fx: 'acidRain', cd: 20 },
        { variant: 4, n: 'Giftflut', e: '‚ò†', el: 'nature', d: '284 Dmg, AoE 300, Transformation.', fx: 'poisonFlood', cd: 31 },
        { variant: 5, n: 'Rankentauchgang', e: 'üåø', el: 'nature', d: '195 Dmg, AoE 300, Beschw√∂rung.', fx: 'vineDive', cd: 40 },
        { variant: 6, n: 'Sumpfgas', e: 'üí®', el: 'nature', d: '224 Dmg, AoE 300, Globaler Sturm.', fx: 'swampGas', cd: 34 },
        { variant: 7, n: 'Algenwall', e: 'üåä', el: 'water', d: '154 Dmg, AoE 300, Transformation.', fx: 'algaeWall', cd: 36 },
        { variant: 8, n: 'Tiefenwurzel', e: 'üå±', el: 'nature', d: '197 Dmg, AoE 300, Beschw√∂rung.', fx: 'deepRoot', cd: 34 },
        { variant: 9, n: 'Meerespflanze', e: 'üåø', el: 'water', d: '233 Dmg, AoE 300, Globaler Sturm.', fx: 'seaPlant', cd: 23 },
      ],
      'water+light': [
        { variant: 1, n: 'Heiliges Wasser', e: '‚ú®', el: 'light', d: 'Boden-Zone: 5s Unverwundbar f√ºr Team.', fx: 'holyWater', cd: 22 },
        { variant: 2, n: 'Prisma-Reflektion', e: 'üåà', el: 'light', d: 'Schilde reflektieren Strahlen auf Gegner.', fx: 'prismaRefract', cd: 20 },
        { variant: 3, n: 'Spiegelkabinett', e: 'ü™û', el: 'light', d: 'Erzeugt 3 Decoy-Klone von dir.', fx: 'mirrorRoom', cd: 23 },
        { variant: 4, n: 'Heilwasser', e: '‚ú®', el: 'light', d: '211 Dmg, AoE 300, Transformation.', fx: 'healWater', cd: 29 },
        { variant: 5, n: 'Lichtreflexion', e: 'üåà', el: 'light', d: '234 Dmg, AoE 300, Beschw√∂rung.', fx: 'lightReflect', cd: 39 },
        { variant: 6, n: 'Prismaflut', e: 'üåä', el: 'water', d: '210 Dmg, AoE 300, Globaler Sturm.', fx: 'prismaFlood', cd: 23 },
        { variant: 7, n: 'Strahlende Quelle', e: '‚ú®', el: 'light', d: '266 Dmg, AoE 300, Transformation.', fx: 'radiantSpring', cd: 30 },
        { variant: 8, n: 'Heiliger Regen', e: 'üåß', el: 'water', d: '237 Dmg, AoE 300, Beschw√∂rung.', fx: 'holyRain', cd: 29 },
        { variant: 9, n: 'Spiegelflut', e: 'ü™û', el: 'water', d: '180 Dmg, AoE 300, Globaler Sturm.', fx: 'mirrorFlood', cd: 38 },
      ],
      'water+darkness': [
        { variant: 1, n: 'Kraken', e: 'üêô', el: 'darkness', d: '180 Dmg-Zone 8s + Stun.', fx: 'kraken', cd: 21 },
        { variant: 2, n: 'Ertrinken', e: 'ü´ß', el: 'water', d: 'Gegner schweben in Blasen, DoT 8s.', fx: 'drown', cd: 18 },
        { variant: 3, n: 'Tinte', e: 'üåë', el: 'darkness', d: 'Komplette Dunkelheit: Globaler Blind.', fx: 'ink', cd: 22 },
        { variant: 4, n: 'Schwarzwasser', e: 'üåë', el: 'darkness', d: '266 Dmg, AoE 300, Transformation.', fx: 'blackWater', cd: 36 },
        { variant: 5, n: 'Abgrundflut', e: 'üêô', el: 'darkness', d: '285 Dmg, AoE 300, Beschw√∂rung.', fx: 'abyssFlood', cd: 23 },
        { variant: 6, n: 'Tintennebel', e: 'üåë', el: 'darkness', d: '218 Dmg, AoE 300, Globaler Sturm.', fx: 'inkFog', cd: 21 },
        { variant: 7, n: 'Schattentauchgang', e: 'üåä', el: 'water', d: '299 Dmg, AoE 300, Transformation.', fx: 'shadowDive', cd: 27 },
        { variant: 8, n: 'Tiefseegeist', e: 'üëª', el: 'darkness', d: '154 Dmg, AoE 300, Beschw√∂rung.', fx: 'deepGhost', cd: 23 },
        { variant: 9, n: 'Krakenschw√§rze', e: 'üêô', el: 'darkness', d: '180 Dmg, AoE 300, Globaler Sturm.', fx: 'krakenDark', cd: 35 },
      ],
      'earth+wind': [
        { variant: 1, n: 'Sandsturm', e: 'üå™', el: 'earth', d: 'Blind 5s + DoT in Arena.', fx: 'sandstorm', cd: 23 },
        { variant: 2, n: 'Erosion', e: 'üå¨', el: 'earth', d: 'Entfernt R√ºstung+Curse permanent 8s.', fx: 'erosion', cd: 24 },
        { variant: 3, n: 'Steinschlag', e: 'ü™®', el: 'wind', d: 'Wind schleudert Felsen: Physik-Chaos.', fx: 'rockThrow', cd: 18 },
        { variant: 4, n: 'Sandschneise', e: 'üå™', el: 'earth', d: '159 Dmg, AoE 300, Transformation.', fx: 'sandCut', cd: 20 },
        { variant: 5, n: 'Felssturm', e: 'ü™®', el: 'earth', d: '241 Dmg, AoE 300, Beschw√∂rung.', fx: 'rockStorm', cd: 39 },
        { variant: 6, n: 'Erosionsb√∂e', e: 'üå¨', el: 'earth', d: '191 Dmg, AoE 300, Globaler Sturm.', fx: 'erosionGust', cd: 39 },
        { variant: 7, n: 'Staubwirbel', e: 'üå™', el: 'wind', d: '272 Dmg, AoE 300, Transformation.', fx: 'dustWhirl', cd: 33 },
        { variant: 8, n: 'Steinschlagorkan', e: 'ü™®', el: 'wind', d: '153 Dmg, AoE 300, Beschw√∂rung.', fx: 'rockHurricane', cd: 35 },
        { variant: 9, n: 'W√ºstensturm', e: 'üå™', el: 'earth', d: '292 Dmg, AoE 300, Globaler Sturm.', fx: 'desertStorm', cd: 24 },
      ],
      'earth+nature': [
        { variant: 1, n: 'Weltenbaum', e: 'üå≥', el: 'nature', d: 'Riesenwand + Team voll heilen.', fx: 'worldTree', cd: 23 },
        { variant: 2, n: 'Erd-Spie√üe', e: 'üåµ', el: 'earth', d: 'Wald aus Steinspie√üen aus dem Boden.', fx: 'earthSpikes', cd: 21 },
        { variant: 3, n: 'Lebende Festung', e: 'üè∞', el: 'earth', d: 'Team: Stein-R√ºstung -40% Schaden 8s.', fx: 'livingFortress', cd: 20 },
        { variant: 4, n: 'Rankenfels', e: 'üåø', el: 'nature', d: '281 Dmg, AoE 300, Transformation.', fx: 'vineRock', cd: 35 },
        { variant: 5, n: 'Erdwurzel', e: 'üå≥', el: 'nature', d: '270 Dmg, AoE 300, Beschw√∂rung.', fx: 'earthRoot', cd: 38 },
        { variant: 6, n: 'Steinwald', e: 'üåµ', el: 'earth', d: '272 Dmg, AoE 300, Globaler Sturm.', fx: 'stoneForest', cd: 31 },
        { variant: 7, n: 'Felsspross', e: 'üå±', el: 'nature', d: '207 Dmg, AoE 300, Transformation.', fx: 'rockSprout', cd: 25 },
        { variant: 8, n: 'Bodenwucherung', e: 'üåø', el: 'nature', d: '254 Dmg, AoE 300, Beschw√∂rung.', fx: 'groundGrowth', cd: 38 },
        { variant: 9, n: 'Lebender Stein', e: 'üóø', el: 'earth', d: '246 Dmg, AoE 300, Globaler Sturm.', fx: 'livingStone', cd: 38 },
      ],
      'earth+light': [
        { variant: 1, n: 'Diamant-Haut', e: 'üíé', el: 'light', d: 'Team 5s unverwundbar.', fx: 'diamondSkin', cd: 22 },
        { variant: 2, n: 'Kristall-Turm', e: 'üî´', el: 'earth', d: 'Turm schie√üt Laser auf Gegner.', fx: 'crystalTower', cd: 20 },
        { variant: 3, n: 'Licht-Brechung', e: 'üî∑', el: 'light', d: 'Kristalle verst√§rken alle Projektile 8s.', fx: 'lightRefract', cd: 18 },
        { variant: 4, n: 'Kristallglanz', e: 'üíé', el: 'light', d: '294 Dmg, AoE 300, Transformation.', fx: 'crystalShine', cd: 37 },
        { variant: 5, n: 'Leuchtstein', e: 'üî∑', el: 'earth', d: '251 Dmg, AoE 300, Beschw√∂rung.', fx: 'glowStone', cd: 38 },
        { variant: 6, n: 'Diamantblitz', e: 'üíé', el: 'light', d: '166 Dmg, AoE 300, Globaler Sturm.', fx: 'diamondFlash', cd: 27 },
        { variant: 7, n: 'Edelsteinlicht', e: 'üí†', el: 'light', d: '268 Dmg, AoE 300, Transformation.', fx: 'gemLight', cd: 39 },
        { variant: 8, n: 'Mineralaura', e: 'üî∑', el: 'earth', d: '153 Dmg, AoE 300, Beschw√∂rung.', fx: 'mineralAura', cd: 39 },
        { variant: 9, n: 'Lichtquarz', e: 'üíé', el: 'light', d: '287 Dmg, AoE 300, Globaler Sturm.', fx: 'lightQuartz', cd: 31 },
      ],
      'earth+darkness': [
        { variant: 1, n: 'Zombie-H√§nde', e: 'üíÄ', el: 'darkness', d: 'H√§nde halten alle fest Root 4s + 100 Dmg.', fx: 'zombieHands', cd: 22 },
        { variant: 2, n: 'Sarkophag', e: '‚ö∞', el: 'earth', d: 'Schlie√üt Gegner komplett ein (Banish 5s).', fx: 'sarcophagus', cd: 19 },
        { variant: 3, n: 'Erd-Spalte', e: 'üï≥', el: 'earth', d: 'Boden √∂ffnet sich, Gegner fallen rein.', fx: 'groundSplit', cd: 18 },
        { variant: 4, n: 'Grabstein', e: 'üíÄ', el: 'darkness', d: '182 Dmg, AoE 300, Transformation.', fx: 'gravestone', cd: 35 },
        { variant: 5, n: 'Schattenfels', e: 'ü™®', el: 'earth', d: '179 Dmg, AoE 300, Beschw√∂rung.', fx: 'shadowRock', cd: 30 },
        { variant: 6, n: 'Dunkle Erde', e: 'üåë', el: 'darkness', d: '161 Dmg, AoE 300, Globaler Sturm.', fx: 'darkEarth', cd: 24 },
        { variant: 7, n: 'Totenw√§chter', e: 'üíÄ', el: 'darkness', d: '163 Dmg, AoE 300, Transformation.', fx: 'deathGuard', cd: 34 },
        { variant: 8, n: 'Erdfluch', e: 'üï≥', el: 'earth', d: '240 Dmg, AoE 300, Beschw√∂rung.', fx: 'earthCurse', cd: 37 },
        { variant: 9, n: 'Untergrundgeist', e: 'üëª', el: 'darkness', d: '279 Dmg, AoE 300, Globaler Sturm.', fx: 'underGhost', cd: 31 },
      ],
      'wind+nature': [
        { variant: 1, n: 'Pollenflug', e: 'üå∏', el: 'nature', d: 'Alle Gegner schlafen 3s ein.', fx: 'pollenSleep', cd: 18 },
        { variant: 2, n: 'Sporen-Tornado', e: 'üå™', el: 'nature', d: 'Giftiger Wirbelwind wandert 5s.', fx: 'sporeTornado', cd: 23 },
        { variant: 3, n: 'Bl√§ttertanz', e: 'üçÉ', el: 'wind', d: 'Team unsichtbar + +30% Speed 5s.', fx: 'leafDance', cd: 21 },
        { variant: 4, n: 'Pollenwirbel', e: 'üå∏', el: 'nature', d: '208 Dmg, AoE 300, Transformation.', fx: 'pollenWhirl', cd: 25 },
        { variant: 5, n: 'Sporensturm', e: 'üå™', el: 'nature', d: '265 Dmg, AoE 300, Beschw√∂rung.', fx: 'sporeStorm', cd: 29 },
        { variant: 6, n: 'Blatttornado', e: 'üçÉ', el: 'wind', d: '183 Dmg, AoE 300, Globaler Sturm.', fx: 'leafTornado', cd: 22 },
        { variant: 7, n: 'Rankensturm', e: 'üåø', el: 'nature', d: '296 Dmg, AoE 300, Transformation.', fx: 'vineStorm', cd: 37 },
        { variant: 8, n: 'Giftb√∂e', e: '‚ò†', el: 'nature', d: '232 Dmg, AoE 300, Beschw√∂rung.', fx: 'poisonGust', cd: 26 },
        { variant: 9, n: 'Waldtornado', e: 'üå≥', el: 'wind', d: '250 Dmg, AoE 300, Globaler Sturm.', fx: 'forestTornado', cd: 29 },
      ],
      'wind+light': [
        { variant: 1, n: 'Licht-Geschwindigkeit', e: 'üí´', el: 'light', d: 'Zeitlupe 4s f√ºr Gegner, Normalzeit dich.', fx: 'lightSpeed', cd: 21 },
        { variant: 2, n: 'Nordlicht', e: 'üåå', el: 'light', d: 'Schleier: Gegner laufen in falsche Richtung.', fx: 'northernLights', cd: 18 },
        { variant: 3, n: 'Blitzgewitter', e: '‚õà', el: 'wind', d: 'Elektrischer Sturm: Chain-Lightning.', fx: 'lightningStorm', cd: 19 },
        { variant: 4, n: 'Nordlichtbogen', e: 'üåå', el: 'light', d: '280 Dmg, AoE 300, Transformation.', fx: 'auroraArc', cd: 39 },
        { variant: 5, n: 'Lichtb√∂e', e: 'üí´', el: 'light', d: '202 Dmg, AoE 300, Beschw√∂rung.', fx: 'lightGust', cd: 33 },
        { variant: 6, n: 'Blitzsturm', e: '‚õà', el: 'wind', d: '187 Dmg, AoE 300, Globaler Sturm.', fx: 'flashStorm', cd: 39 },
        { variant: 7, n: 'Leuchtwind', e: 'üå¨', el: 'wind', d: '165 Dmg, AoE 300, Transformation.', fx: 'glowWind', cd: 21 },
        { variant: 8, n: 'Strahlende B√∂e', e: '‚ú®', el: 'light', d: '193 Dmg, AoE 300, Beschw√∂rung.', fx: 'radiantGust', cd: 27 },
        { variant: 9, n: 'Lichtblitzwirbel', e: '‚ö°', el: 'wind', d: '249 Dmg, AoE 300, Globaler Sturm.', fx: 'lightFlashWhirl', cd: 28 },
      ],
      'wind+darkness': [
        { variant: 1, n: 'Schatten-Schritt', e: 'üåë', el: 'darkness', d: 'Teleport zu jedem Gegner 1√ó und schl√§gt zu.', fx: 'shadowStep', cd: 20 },
        { variant: 2, n: 'Vakuum der Leere', e: 'üï≥', el: 'darkness', d: 'Schwarzes Loch: zieht alles rein, Low-HP-Kill.', fx: 'voidVacuum', cd: 19 },
        { variant: 3, n: 'Nachtmahr', e: 'üëÅ', el: 'darkness', d: 'Gegner sehen Geister: Chaos + Fear 3s.', fx: 'nightmare', cd: 23 },
        { variant: 4, n: 'Schattensturm', e: 'üåë', el: 'darkness', d: '266 Dmg, AoE 300, Transformation.', fx: 'shadowStorm', cd: 31 },
        { variant: 5, n: 'Leerenb√∂e', e: 'üï≥', el: 'darkness', d: '160 Dmg, AoE 300, Beschw√∂rung.', fx: 'voidGust', cd: 21 },
        { variant: 6, n: 'Fl√ºsterfinsternis', e: 'üëÅ', el: 'darkness', d: '176 Dmg, AoE 300, Globaler Sturm.', fx: 'whisperDark', cd: 35 },
        { variant: 7, n: 'Nachtwind', e: 'üå¨', el: 'wind', d: '195 Dmg, AoE 300, Transformation.', fx: 'nightWind', cd: 26 },
        { variant: 8, n: 'Dunkler Wirbel', e: 'üåÄ', el: 'darkness', d: '215 Dmg, AoE 300, Beschw√∂rung.', fx: 'darkWhirl', cd: 25 },
        { variant: 9, n: 'Abgrundwind', e: 'üåë', el: 'wind', d: '198 Dmg, AoE 300, Globaler Sturm.', fx: 'abyssWind', cd: 21 },
      ],
      'nature+light': [
        { variant: 1, n: 'Feen-Staub', e: 'üßö', el: 'light', d: 'Verwandelt Gegner kurz in Tiere (Polymorph).', fx: 'fairyDust', cd: 21 },
        { variant: 2, n: 'Lebens-Zyklus', e: 'üåô', el: 'nature', d: 'T√∂tet alle Minions, heilt Team voll.', fx: 'lifeCycle', cd: 18 },
        { variant: 3, n: 'Mondlichtung', e: '‚ú®', el: 'light', d: 'Zone der Ruhe 8s: kein Schaden m√∂glich.', fx: 'moonClear', cd: 18 },
        { variant: 4, n: 'Heilige Bl√ºte', e: 'üå∏', el: 'light', d: '248 Dmg, AoE 300, Transformation.', fx: 'holyBlossom', cd: 32 },
        { variant: 5, n: 'Lichtranke', e: 'üåø', el: 'nature', d: '190 Dmg, AoE 300, Beschw√∂rung.', fx: 'lightVine', cd: 28 },
        { variant: 6, n: 'Strahlende Pflanze', e: '‚ú®', el: 'nature', d: '217 Dmg, AoE 300, Globaler Sturm.', fx: 'radiantPlant', cd: 39 },
        { variant: 7, n: 'Lebenslicht', e: 'üåô', el: 'light', d: '164 Dmg, AoE 300, Transformation.', fx: 'lifeLight', cd: 21 },
        { variant: 8, n: 'Feenglanz', e: 'üßö', el: 'light', d: '189 Dmg, AoE 300, Beschw√∂rung.', fx: 'fairyShine', cd: 34 },
        { variant: 9, n: 'Heiligtumswald', e: 'üå≥', el: 'nature', d: '188 Dmg, AoE 300, Globaler Sturm.', fx: 'sanctuaryForest', cd: 21 },
      ],
      'nature+darkness': [
        { variant: 1, n: 'Seuche', e: '‚ò†', el: 'nature', d: 'Ansteckender Virus springt zwischen Gegnern.', fx: 'plague', cd: 20 },
        { variant: 2, n: 'Fleischfressende Pflanze', e: 'üå±', el: 'darkness', d: 'Verschlingt Gegner, kauen-DoT 5s.', fx: 'carnivousPlant', cd: 20 },
        { variant: 3, n: 'Todes-Bl√ºte', e: 'üíÄ', el: 'nature', d: 'Bei Kill: Dornen-Explosion in alle Richtungen.', fx: 'deathBloom', cd: 23 },
        { variant: 4, n: 'Fauler Spross', e: 'üå±', el: 'nature', d: '211 Dmg, AoE 300, Transformation.', fx: 'rotSprout', cd: 28 },
        { variant: 5, n: 'Giftige Finsternis', e: '‚ò†', el: 'darkness', d: '294 Dmg, AoE 300, Beschw√∂rung.', fx: 'toxicDark', cd: 33 },
        { variant: 6, n: 'Todesranke', e: 'üíÄ', el: 'nature', d: '183 Dmg, AoE 300, Globaler Sturm.', fx: 'deathVine', cd: 22 },
        { variant: 7, n: 'Verwesungsspore', e: '‚ò†', el: 'nature', d: '197 Dmg, AoE 300, Transformation.', fx: 'decaySpore', cd: 32 },
        { variant: 8, n: 'Fluchbl√ºte', e: 'üå∏', el: 'darkness', d: '170 Dmg, AoE 300, Beschw√∂rung.', fx: 'curseBlossom', cd: 27 },
        { variant: 9, n: 'Pestwald', e: 'üå≥', el: 'nature', d: '194 Dmg, AoE 300, Globaler Sturm.', fx: 'plagueForest', cd: 21 },
      ],
      'light+darkness': [
        { variant: 1, n: 'Eclipse', e: 'üåó', el: 'darkness', d: 'Verdunkelt Sonne: 220 True Dmg global.', fx: 'eclipse', cd: 22 },
        { variant: 2, n: 'Gleichgewicht', e: '‚öñ', el: 'light', d: 'Tauscht HP von dir und Gegner (riskant!).', fx: 'balance', cd: 23 },
        { variant: 3, n: 'Yin & Yang', e: '‚òØ', el: 'light', d: 'Zone 8s: Innen heilst du, au√üen Dmg.', fx: 'yinYang', cd: 18 },
        { variant: 4, n: 'Schatteneclipse', e: 'üåó', el: 'darkness', d: '210 Dmg, AoE 300, Transformation.', fx: 'shadowEclipse', cd: 26 },
        { variant: 5, n: 'D√§mmerlicht', e: 'üåÖ', el: 'light', d: '194 Dmg, AoE 300, Beschw√∂rung.', fx: 'dawnLight', cd: 40 },
        { variant: 6, n: 'Zwielichtstrahl', e: 'üåó', el: 'light', d: '158 Dmg, AoE 300, Globaler Sturm.', fx: 'twilightBeam', cd: 38 },
        { variant: 7, n: 'Yin-Yang-Explosion', e: '‚òØ', el: 'light', d: '222 Dmg, AoE 300, Transformation.', fx: 'yinYangExplosion', cd: 28 },
        { variant: 8, n: 'Graues Gleichgewicht', e: '‚öñ', el: 'darkness', d: '237 Dmg, AoE 300, Beschw√∂rung.', fx: 'grayBalance', cd: 32 },
        { variant: 9, n: 'Grenzlicht', e: 'üåó', el: 'light', d: '195 Dmg, AoE 300, Globaler Sturm.', fx: 'borderLight', cd: 33 },
      ],
    };

    // ‚îÄ‚îÄ‚îÄ 7 ELEMENTAL BOSSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const BOSS_DEFS = {
      fire: {
        name: 'Inferno-Drake', boss_el: 'fire', emoji: 'üêâ', hp: 1800, r: 50, spd: 88,
        color: '#ff4500', glow: '#ff6b1a',
        desc: 'Feurige Bestie ‚Äî Schwach gegen Wasser',
        phases: [
          { hp: 1800, atkPattern: 'spread3', spd: 88, chargeCD: 9, minionEl: 'fire', minionHP: 70 },
          { hp: 900, atkPattern: 'spread5+fire', spd: 125, chargeCD: 6, minionEl: 'fire', minionHP: 70 },
          { hp: 400, atkPattern: 'spread7+meteor', spd: 165, chargeCD: 4, minionEl: 'fire', minionHP: 70 },
        ],
        specialAtks: ['fireBreath', 'meteors', 'firePillar', 'flameRing'],
      },
      water: {
        name: 'Tidal-Leviathan', boss_el: 'water', emoji: 'üåä', hp: 2000, r: 56, spd: 72,
        color: '#1565c0', glow: '#42a5f5',
        desc: 'Tiefsee-Titan ‚Äî Schwach gegen Natur',
        phases: [
          { hp: 2000, atkPattern: 'homing3', spd: 72, chargeCD: 11, minionEl: 'water', minionHP: 75 },
          { hp: 1000, atkPattern: 'homing5+wave', spd: 105, chargeCD: 8, minionEl: 'water', minionHP: 75 },
          { hp: 450, atkPattern: 'tidal+ring', spd: 140, chargeCD: 5, minionEl: 'water', minionHP: 75 },
        ],
        specialAtks: ['tidalWave', 'waterPrison', 'healSelf', 'vortex'],
      },
      earth: {
        name: 'Stein-Koloss', boss_el: 'earth', emoji: 'üóø', hp: 2400, r: 58, spd: 65,
        color: '#5d4037', glow: '#a3a86e',
        desc: 'Uralter Kolos ‚Äî Schwach gegen Wind',
        phases: [
          { hp: 2400, atkPattern: 'boulder', spd: 65, chargeCD: 12, minionEl: 'earth', minionHP: 90 },
          { hp: 1200, atkPattern: 'quake+spikes', spd: 92, chargeCD: 8, minionEl: 'earth', minionHP: 90 },
          { hp: 500, atkPattern: 'quake+spikes+meteors', spd: 125, chargeCD: 5, minionEl: 'earth', minionHP: 90 },
        ],
        specialAtks: ['groundSlam', 'rockSpikes', 'stoneWalls', 'quakeShockwave'],
      },
      wind: {
        name: 'Sturm-Geist', boss_el: 'wind', emoji: 'üå™', hp: 1600, r: 46, spd: 105,
        color: '#01579b', glow: '#4fc3f7',
        desc: '√Ñtherisches Wesen ‚Äî Schwach gegen Erde',
        phases: [
          { hp: 1600, atkPattern: 'fast5', spd: 105, chargeCD: 8, minionEl: 'wind', minionHP: 60 },
          { hp: 800, atkPattern: 'fast8+tornado', spd: 148, chargeCD: 5, minionEl: 'wind', minionHP: 60 },
          { hp: 350, atkPattern: 'fast12+vacuum', spd: 190, chargeCD: 3, minionEl: 'wind', minionHP: 60 },
        ],
        specialAtks: ['windBarrage', 'tornadoSpin', 'vacuum', 'airBurst'],
      },
      nature: {
        name: 'Uralter Baum', boss_el: 'nature', emoji: 'üå≥', hp: 2200, r: 55, spd: 58,
        color: '#1b5e20', glow: '#4ade80',
        desc: 'Lebendige Natur ‚Äî Schwach gegen Feuer',
        phases: [
          { hp: 2200, atkPattern: 'poison3', spd: 58, chargeCD: 14, minionEl: 'nature', minionHP: 80 },
          { hp: 1100, atkPattern: 'poison5+roots', spd: 82, chargeCD: 9, minionEl: 'nature', minionHP: 80 },
          { hp: 500, atkPattern: 'spore+root+heal', spd: 108, chargeCD: 6, minionEl: 'nature', minionHP: 80 },
        ],
        specialAtks: ['rootCage', 'sporeBurst', 'natureSeal', 'healing'],
      },
      light: {
        name: 'Solar-Ph√∂nix', boss_el: 'light', emoji: 'ü¶Ö', hp: 1900, r: 50, spd: 80,
        color: '#f57f17', glow: '#fde68a',
        desc: 'Strahlender W√§chter ‚Äî Schwach gegen Dunkelheit',
        phases: [
          { hp: 1900, atkPattern: 'laser3', spd: 80, chargeCD: 10, minionEl: 'light', minionHP: 65 },
          { hp: 950, atkPattern: 'laser5+blind', spd: 115, chargeCD: 7, minionEl: 'light', minionHP: 65 },
          { hp: 400, atkPattern: 'fullBlast+resurrection', spd: 150, chargeCD: 4, minionEl: 'light', minionHP: 65 },
        ],
        specialAtks: ['solarFlare', 'blindPulse', 'holyBeam', 'reviveMinions'],
      },
      darkness: {
        name: 'Void-Harbinger', boss_el: 'darkness', emoji: 'üëÅ', hp: 2100, r: 52, spd: 78,
        color: '#4a0072', glow: '#a855f7',
        desc: 'Dunkler Herrscher ‚Äî Schwach gegen Licht',
        phases: [
          { hp: 2100, atkPattern: 'shadow3', spd: 78, chargeCD: 10, minionEl: 'darkness', minionHP: 75 },
          { hp: 1050, atkPattern: 'shadow5+fear', spd: 112, chargeCD: 7, minionEl: 'darkness', minionHP: 75 },
          { hp: 450, atkPattern: 'drain+curse+portal', spd: 150, chargeCD: 4, minionEl: 'darkness', minionHP: 75 },
        ],
        specialAtks: ['shadowBeam', 'fearShout', 'voidPortal', 'lifeSteal'],
      },
    };

    // ‚îÄ‚îÄ‚îÄ LEVEL DEFINITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const LEVELS = [
      {
        id: 0, name: 'Feuer-Tempel', emoji: 'üî•', boss: 'fire',
        bg: '#0d0401', gridCol: '#2a0c04', borderGlow: '#ff4500', cornerSymbol: 'üî•',
        fxLayer: 'fireAsh', // flickering ash particles
        difficulty: 'Anf√§nger', pillarsLayout: 'open', guardians: ['fire'], minionWaves: 2
      },
      {
        id: 1, name: 'Tiefsee-Graben', emoji: 'üåä', boss: 'water',
        bg: '#010810', gridCol: '#031428', borderGlow: '#0ea5e9', cornerSymbol: '„Ä∞',
        fxLayer: 'waterDrops', // dripping droplet particles
        difficulty: 'Leicht', pillarsLayout: 'ring', guardians: ['water', 'wind'], minionWaves: 2
      },
      {
        id: 2, name: 'Steinburg', emoji: 'ü™®', boss: 'earth',
        bg: '#080604', gridCol: '#161008', borderGlow: '#a16207', cornerSymbol: '‚ñ≤',
        fxLayer: 'earthDust', // ground dust
        difficulty: 'Mittel', pillarsLayout: 'maze', guardians: ['earth', 'nature'], minionWaves: 3
      },
      {
        id: 3, name: 'Sturmgipfel', emoji: '‚ö°', boss: 'wind',
        bg: '#020610', gridCol: '#04091e', borderGlow: '#7dd3fc', cornerSymbol: '‚âã',
        fxLayer: 'windLines', // speed lines
        difficulty: 'Mittel', pillarsLayout: 'sparse', guardians: ['wind', 'fire'], minionWaves: 3
      },
      {
        id: 4, name: 'Urwald', emoji: 'üåø', boss: 'nature',
        bg: '#020803', gridCol: '#041208', borderGlow: '#4ade80', cornerSymbol: '‚ùß',
        fxLayer: 'naturePollen', // pollen motes
        difficulty: 'Schwer', pillarsLayout: 'dense', guardians: ['nature', 'water', 'earth'], minionWaves: 4
      },
      {
        id: 5, name: 'Lichttempel', emoji: '‚ú®', boss: 'light',
        bg: '#0a0902', gridCol: '#181402', borderGlow: '#fde68a', cornerSymbol: '‚ú¶',
        fxLayer: 'lightMotes', // floating light orbs
        difficulty: 'Schwer', pillarsLayout: 'cross', guardians: ['light', 'fire', 'wind'], minionWaves: 4
      },
      {
        id: 6, name: 'Schattenvoid', emoji: 'üåë', boss: 'darkness',
        bg: '#050008', gridCol: '#0a0012', borderGlow: '#a855f7', cornerSymbol: '‚òΩ',
        fxLayer: 'shadowSmoke', // dark smoke wisps
        difficulty: 'Extrem', pillarsLayout: 'chaos', guardians: ['darkness', 'light', 'nature', 'fire'], minionWaves: 5
      },
    ];

    function buildPillarsForLayout(layout, bossEl) {
      const cx = GW / 2, cy = GH / 2;
      const el = bossEl || 'fire';
      // ‚îÄ Procedural mirrored generator: spacious arenas ‚îÄ
      // 2-4 obstacle groups in top-left quadrant ‚Üí 8-16 total pillars (not too many!)
      const density = 2 + Math.floor(Math.random() * 3);
      const halfW = (cx - PAD - 60), halfH = (cy - PAD - 60);
      const result = [];
      // Center pillar (always present, small anchor)
      result.push({ x: cx - 18, y: cy - 18, w: 36, h: 36, _el: el });
      // Generate obstacles in top-left quadrant and mirror
      for (let i = 0; i < density; i++) {
        let ox, oy, attempts = 0;
        // Random shape: 0=square, 1=wide, 2=tall (smaller sizes)
        const shape = Math.floor(Math.random() * 3);
        let w, h;
        if (shape === 0) { w = 26 + Math.floor(Math.random() * 18); h = w; } // small square
        else if (shape === 1) { w = 40 + Math.floor(Math.random() * 40); h = 14 + Math.floor(Math.random() * 10); } // medium wall
        else { w = 14 + Math.floor(Math.random() * 10); h = 40 + Math.floor(Math.random() * 40); } // tall wall
        do {
          ox = PAD + 60 + Math.random() * (halfW - 60);
          oy = PAD + 60 + Math.random() * (halfH - 60);
          attempts++;
        } while (attempts < 30 && (
          Math.sqrt((ox + w / 2 - cx) ** 2 + (oy + h / 2 - cy) ** 2) < 180 // wide center clearance
        ));
        if (attempts >= 30) continue;
        // Mirror to all 4 quadrants
        const mirrors = [
          { x: ox, y: oy },
          { x: GW - ox - w, y: oy },
          { x: ox, y: GH - oy - h },
          { x: GW - ox - w, y: GH - oy - h },
        ];
        mirrors.forEach(m => {
          // Skip if too close to center (boss spawn safety 160px)
          if (Math.sqrt((m.x + w / 2 - cx) ** 2 + (m.y + h / 2 - cy) ** 2) < 160) return;
          // Skip if overlaps player spawn area (bottom center)
          if (Math.abs(m.x + w / 2 - cx) < 100 && m.y + h > GH - PAD - 120) return;
          result.push({ x: m.x, y: m.y, w, h, _el: el });
        });
      }
      return result.map(p => ({ ...p, temp: false }));
    }
    // ‚îÄ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let gameMode = 'solo'; // 'solo' | 'host' | 'guest'
    let peer = null, conn = null, isHost = false;
    let currentLevel = 0, completedLevels = [];
    let loadouts = [null, null];
    let draftState = { step: 0, curPlayer: 0, picks: [[], [], []] };
    let rngS = Date.now() | 0;
    function sr() { rngS = (rngS * 1664525 + 1013904223) >>> 0; return rngS / 4294967296; }
    function pickN(a, n) { const b = [...a]; for (let i = b.length - 1; i > 0; i--) { const j = Math.floor(sr() * (i + 1));[b[i], b[j]] = [b[j], b[i]]; } return b.slice(0, n); }
    function rndFrom(a) { return a[Math.floor(Math.random() * a.length)]; } // True random, not seeded

    // Anti-duplicate passive tracker (per session)
    let lastPassivePids = [];
    function pickPassive(el) {
      const pool = POOL[el]?.passive || [];
      if (!pool.length) return null;
      // Avoid last 2 used pids across all elements
      const avail = pool.filter(p => !lastPassivePids.includes(p.pid || p.id));
      const chosen = rndFrom(avail.length > 0 ? avail : pool);
      lastPassivePids.push(chosen.pid || chosen.id);
      if (lastPassivePids.length > 4) lastPassivePids.shift();
      return chosen;
    }

    // Fusion variant anti-repeat per key
    let lastFusionVariants = {};
    function getFus(a, b) {
      const ka = a.toLowerCase().trim(), kb = b.toLowerCase().trim();
      const key = [ka, kb].sort().join('+');
      // Try sorted key, original order, and reversed order
      const variants = FUS3[key] || FUS3[ka + '+' + kb] || FUS3[kb + '+' + ka];
      console.log('Fusion Key:', key, '| Also tried:', ka + '+' + kb, kb + '+' + ka, '| Found:', !!variants);
      if (!variants || !variants.length) return null;
      const last = lastFusionVariants[key];
      const avail = variants.filter(v => v.variant !== last);
      const chosen = rndFrom(avail.length > 0 ? avail : variants);
      lastFusionVariants[key] = chosen.variant;
      return chosen;
    }

    // ‚îÄ‚îÄ‚îÄ GAME OBJECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let cv, ctx, running = false, animId = null, lastT = 0;
    let players = [], enemies = [], projs = [], parts = [], floats = [], fieldFx = [], pillars = [];
    let shakeX = 0, shakeY = 0, shakeT = 0, shakeA = 0;
    let ann = { text: '', t: 0, max: 0 };
    let gamePhase = 0, phaseCD = 0;
    let levelTimer = 0, killCount = 0;
    const keys = {}; let mx = GW / 2, my = GH / 2;
    let p2autoT = 0;
    let lastBossHp = 9999;

    // ‚îÄ‚îÄ‚îÄ MENU NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function goMenu() { cleanupPeer(); if (animId) { cancelAnimationFrame(animId); animId = null; } running = false; removeListeners(); hideTip(); showScreen('menu'); }
    function goSolo() { gameMode = 'solo'; currentLevel = 0; completedLevels = []; shuffleLevels(); buildLevelGrid(); showScreen('levelselect'); }
    function retryLevel() { startDraft(); }

    // ‚îÄ‚îÄ‚îÄ TRAINING ROOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let trainPicks = { a: 'fire', b: 'water', s: 'earth' };
    function goTraining() {
      showScreen('training');
      const elKeys = Object.keys(EL);
      ['trainA', 'trainB', 'trainS'].forEach((containerId, ci) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const pickKey = ['a', 'b', 's'][ci];
        elKeys.forEach(ek => {
          const btn = document.createElement('button');
          btn.className = 'train-el-btn' + (trainPicks[pickKey] === ek ? ' active' : '');
          btn.style.cssText = `border-color:${EL[ek].c};color:${EL[ek].c};`;
          btn.innerHTML = `${EL[ek].e}<br><span style="font-size:7px">${EL[ek].n}</span>`;
          btn.onclick = () => {
            trainPicks[pickKey] = ek;
            goTraining(); // refresh
          };
          container.appendChild(btn);
        });
      });
      // Preview
      const fusion = getFus(trainPicks.a, trainPicks.b);
      const prev = document.getElementById('trainPreview');
      prev.innerHTML = `${EL[trainPicks.a].e} ${EL[trainPicks.a].n} + ${EL[trainPicks.b].e} ${EL[trainPicks.b].n} | Seele: ${EL[trainPicks.s].e} ${EL[trainPicks.s].n}` +
        (fusion ? ` | <span style="color:#c084fc">R: ${fusion.e} ${fusion.n}</span>` : ' | <span style="color:#ef4444">Kein Fusion</span>');
    }
    function startTrainingGame() {
      gameMode = 'solo';
      // Build loadout directly from training picks
      const A = trainPicks.a, B = trainPicks.b, soul = trainPicks.s;
      const lo = {
        elemA: A, elemB: B, soul, activeEl: 'A',
        lmbA: rndFrom(POOL[A].lmb), lmbB: rndFrom(POOL[B].lmb),
        rmbA: rndFrom(POOL[A].rmb), rmbB: rndFrom(POOL[B].rmb),
        qSkill: rndFrom(POOL[A].q || POOL[A].active || []),
        eSkill: rndFrom(POOL[B].e || POOL[B].active || []),
        passive: pickPassive(soul),
      };
      lo.fusion = getFus(lo.elemA, lo.elemB);
      loadouts = [lo, null];
      // Reset keys
      for (const k in keys) keys[k] = false;
      // Open arena ‚Äî no pillars
      pillars = [];
      players = [makePlayer(0, loadouts[0])];
      gamePhase = 0; phaseCD = 0; enemies = []; projs = []; parts = []; floats = []; fieldFx = []; lvAmbient = []; crates = []; lootOrbs = [];
      shakeX = shakeY = shakeT = shakeA = 0; ann = { text: '', t: 0, max: 0 };
      levelTimer = 0; killCount = 0; lastBossHp = 9999; p2autoT = 0; hazardTimer = 0; hazardActive = false;
      activeAffixes = []; activeArenaMod = null;
      // Spawn 4 training dummies spread across the arena
      const dummyPositions = [
        { x: GW * 0.2, y: GH * 0.25 }, { x: GW * 0.5, y: GH * 0.25 }, { x: GW * 0.8, y: GH * 0.25 },
        { x: GW * 0.2, y: GH * 0.55 }, { x: GW * 0.5, y: GH * 0.55 }, { x: GW * 0.8, y: GH * 0.55 },
        { x: GW * 0.5, y: GH * 0.75 },
      ];
      dummyPositions.forEach((pos, di) => {
        enemies.push({
          id: 'dummy_' + di, type: 'guardian', element: ['fire', 'water', 'earth', 'wind', 'light', 'nature', 'darkness'][di],
          x: pos.x, y: pos.y, r: 26, hp: 99999, maxHp: 99999, spd: 0,
          atkT: 99999, angle: 0, hitFlash: 0,
          stunT: 0, slowT: 0, slowF: 1, blindT: 0, fearT: 0, frozenT: 0,
          burnT: 0, burnD: 0, burnTick: 0, poisonT: 0, poisonTick: 0,
          _curseDR: 0, _curseDur: 0, _silenceT: 0, _healMarkT: 0,
          _wseed: Math.random() * 100,
          _dummy: true,
        });
      });
      // Use first level's visual theme
      currentLevel = 0;
      showAnn('üéØ TRAININGSRAUM ‚Äî Teste deine Skills!', 4);
      showScreen('game');
      cv = document.getElementById('cv'); cv.width = GW; cv.height = GH; ctx = cv.getContext('2d');
      addListeners(); running = true; lastT = performance.now(); animId = requestAnimationFrame(loop);
    }

    // ‚îÄ‚îÄ‚îÄ LEVEL SELECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildLevelGrid() {
      const g = document.getElementById('levelsGrid'); g.innerHTML = '';
      LEVELS.forEach((lv, i) => {
        const done = completedLevels.includes(i), locked = i > 0 && !completedLevels.includes(i - 1), cur = i === currentLevel;
        const bd = BOSS_DEFS[lv.boss];
        const revealed = done || i === 0; // Only reveal beaten levels + first level
        const c = document.createElement('div'); c.className = 'lcard' + (locked ? ' locked' : '') + (done ? ' completed' : '') + (cur ? ' current' : '');
        c.style.cssText = revealed ? `border-color:${EL[lv.boss].c}${locked ? '22' : '55'};` : `border-color:#1a2a3a${locked ? '22' : '55'};`;
        c.innerHTML = `<div class="lem">${revealed ? lv.emoji : '‚ùì'}</div><div class="lname" style="color:${revealed ? EL[lv.boss].c : '#4a6375'}">${revealed ? lv.name : 'Unbekanntes Kapitel'}</div><div class="ldiff" style="color:${revealed ? EL[lv.boss].c + '88' : '#2a3a4a'}">${revealed ? lv.difficulty : '???'}</div>${done ? '<div class="lbadge">‚úì</div>' : ''}`;
        if (!locked) c.onclick = () => { currentLevel = i; startDraft(); };
        g.appendChild(c);
      });
    }

    // ‚îÄ‚îÄ‚îÄ LOBBY (PeerJS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function genCode() { let s = ''; for (let i = 0; i < 6; i++)s += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random() * 36)]; return s; }

    function goCreateLobby() {
      gameMode = 'host'; isHost = true; showScreen('lobbyCreate');
      const code = genCode(); document.getElementById('roomCodeDisplay').textContent = code;
      try {
        peer = new Peer('EC-' + code, { debug: 0 });
        peer.on('open', () => { document.getElementById('hostStatus').textContent = 'Warte auf Mitspieler...'; });
        peer.on('connection', c => {
          conn = c;
          document.getElementById('hostDot').className = 'status-dot connected';
          document.getElementById('hostStatus').textContent = '‚úì Verbunden! Starte Draft...';
          c.on('open', () => { setTimeout(() => { currentLevel = 0; buildLevelGrid(); startDraftOnline(); }, 1200); });
          c.on('data', onNetData);
          c.on('close', () => { if (running) showAnn('üî¥ Verbindung getrennt', 4); });
        });
        peer.on('error', e => { document.getElementById('hostStatus').textContent = '‚ö† Fehler: ' + e.type; });
      } catch (e) { document.getElementById('hostStatus').textContent = 'PeerJS nicht verf√ºgbar ‚Äì Offline-Modus'; }
    }

    function goJoinLobby() { gameMode = 'guest'; isHost = false; showScreen('lobbyJoin'); }

    function doJoin() {
      const code = document.getElementById('joinCodeInp').value.trim().toUpperCase();
      if (code.length < 4) { document.getElementById('joinStatus').textContent = 'Code zu kurz'; return; }
      document.getElementById('joinDot').className = 'status-dot waiting';
      document.getElementById('joinStatus').textContent = 'Verbinde...';
      try {
        peer = new Peer('EC-GUEST-' + Math.floor(Math.random() * 99999), { debug: 0 });
        peer.on('open', () => {
          conn = peer.connect('EC-' + code);
          conn.on('open', () => {
            document.getElementById('joinDot').className = 'status-dot connected';
            document.getElementById('joinStatus').textContent = '‚úì Verbunden!';
            conn.on('data', onNetData);
            conn.on('close', () => { if (running) showAnn('üî¥ Host getrennt', 4); });
          });
          conn.on('error', e => { document.getElementById('joinStatus').textContent = '‚ö† ' + e; });
        });
        peer.on('error', e => { document.getElementById('joinStatus').textContent = '‚ö† Fehler: ' + e.type; });
      } catch (e) { document.getElementById('joinStatus').textContent = 'PeerJS nicht verf√ºgbar'; }
    }

    function onNetData(d) {
      if (d.type === 'input' && gameMode === 'host' && players[1]) {
        const p = players[1]; if (d.keys) Object.assign(p._netKeys || {}, d.keys);
      }
      if (d.type === 'start') { currentLevel = d.level; startDraft(); }
    }

    function startDraftOnline() { showScreen('draft'); initDraft(); }
    function lobbyCancel() { cleanupPeer(); showScreen('menu'); }
    function cleanupPeer() { if (conn) try { conn.close(); } catch (e) { } if (peer) try { peer.destroy(); } catch (e) { } conn = null; peer = null; }

    // ‚îÄ‚îÄ‚îÄ DRAFT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function initDraft() {
      draftState = { step: 0, curPlayer: 0, picks: [[], [], []] };
      loadouts = [null, null]; rngS = Date.now() | 0;
      const pl = gameMode === 'solo' ? 1 : 2;
      document.getElementById('draftModeLbl').textContent = gameMode === 'solo' ? 'SOLO ¬∑ LEVEL ' + (currentLevel + 1) + '/7' : 'ONLINE CO-OP ¬∑ LEVEL ' + (currentLevel + 1) + '/7';
      document.getElementById('btngo').classList.remove('rdy');
      document.getElementById('lrow').innerHTML = '';
      showDraftStep();
    }

    const SL = ['PHASE 1 ‚Äî PRIM√ÑR', 'PHASE 2 ‚Äî SEKUND√ÑR', 'PHASE 3 ‚Äî SEELE'];
    function showDraftStep() {
      const { step, curPlayer } = draftState;
      const numP = gameMode === 'solo' ? 1 : 2;
      document.getElementById('plabel').innerHTML = `<span style="color:${PC[curPlayer]}">SPIELER ${curPlayer + 1}</span>`;
      document.getElementById('pstep').textContent = SL[step] + ' ‚Äî W√§hle dein Element';
      const used = []; draftState.picks.forEach(a => a.forEach(e => e && used.push(e)));
      const avail = ALL_EL.filter(e => !used.includes(e));
      const pool = pickN(avail, 3);
      const row = document.getElementById('cards'); row.innerHTML = '';
      pool.forEach((el, i) => {
        const E = EL[el]; const d = document.createElement('div'); d.className = 'card';
        d.style.cssText = `border-color:${E.c}44;`;
        d.innerHTML = `<div class="cem">${E.e}</div><div class="cname" style="color:${E.c}">${E.n.toUpperCase()}</div><div class="crole">${ROLES[el]}</div>`;
        d.onclick = () => { const t = d.querySelector('#cardPreview'); if (t) t.remove(); pickCard(el, d); };
        // ‚îÄ‚îÄ Hover preview ‚îÄ‚îÄ
        d.onmouseenter = () => {
          const p = POOL[el]; if (!p) return;
          const lmb = rndFrom(p.lmb || []), rmb = rndFrom(p.rmb || []), q = rndFrom(p.q || []);
          let html = `<div class="cp-title" style="color:${E.c}">${E.e} ${E.n.toUpperCase()} ‚Äî Vorschau</div>`;
          if (lmb) html += `<div class="cp-sk">‚öî <b>${lmb.name}</b>: ${lmb.desc}</div>`;
          if (rmb) html += `<div class="cp-sk">üí• <b>${rmb.name}</b>: ${rmb.desc}</div>`;
          if (q) html += `<div class="cp-sk">üî∑ <b>${q.name}</b>: ${q.desc}</div>`;
          // Phase 2: show fusion preview
          if (step === 1) {
            const primEl = draftState.picks[0][curPlayer];
            if (primEl) {
              const fKey = [primEl, el].sort().join('+');
              const fVars = FUS3[fKey] || FUS3[primEl + '+' + el] || FUS3[el + '+' + primEl];
              if (fVars && fVars.length > 0) {
                const fv = fVars[0];
                html += `<div class="cp-fus">‚ö° <b>FUSION: ${fv.e} ${fv.n}</b><br>${fv.d}</div>`;
              } else {
                html += `<div class="cp-fus" style="color:#ef4444">‚ö° Keine Fusion mit ${EL[primEl].e} ${EL[primEl].n}</div>`;
              }
            }
          }
          const tip = document.createElement('div'); tip.id = 'cardPreview';
          tip.style.borderTopColor = E.c; tip.innerHTML = html;
          d.appendChild(tip);
        };
        d.onmouseleave = () => { const t = d.querySelector('#cardPreview'); if (t) t.remove(); };
        d.style.opacity = '0'; d.style.transform = 'translateY(10px)';
        setTimeout(() => { d.style.transition = 'all .3s'; d.style.opacity = '1'; d.style.transform = 'none'; }, 50 + i * 80);
        row.appendChild(d);
      });
    }

    function pickCard(el, div) {
      const { step, curPlayer } = draftState;
      draftState.picks[step][curPlayer] = el;
      document.querySelectorAll('.card').forEach(c => c.classList.add('dim'));
      div.classList.remove('dim'); div.classList.add('sel');
      div.style.borderColor = EL[el].c; div.style.boxShadow = `0 0 24px ${EL[el].c}55`;
      setTimeout(() => {
        const numP = gameMode === 'solo' ? 1 : 2;
        const other = curPlayer === 0 ? 1 : 0;
        if (numP > 1 && !draftState.picks[step][other]) { draftState.curPlayer = other; showDraftStep(); }
        else {
          draftState.step++; draftState.curPlayer = 0;
          if (draftState.step < 3) showDraftStep();
          else { buildLoadouts(); finalizeDraft(); }
        }
      }, 540);
    }

    function buildLoadouts() {
      const { picks } = draftState; const numP = gameMode === 'solo' ? 1 : 2;
      for (let p = 0; p < numP; p++) {
        const A = picks[0][p] || picks[0][0], B = picks[1][p] || picks[1][0], soul = picks[2][p] || picks[2][0];
        if (!A || !B || !soul) continue;
        const lo = {
          elemA: A, elemB: B, soul, activeEl: 'A',
          lmbA: rndFrom(POOL[A].lmb), lmbB: rndFrom(POOL[B].lmb),
          rmbA: rndFrom(POOL[A].rmb), rmbB: rndFrom(POOL[B].rmb),
          qSkill: rndFrom(POOL[A].q || POOL[A].active || []),
          eSkill: rndFrom(POOL[B].e || POOL[B].active || []),
          passive: pickPassive(soul),
        };
        lo.fusion = getFus(lo.elemA, lo.elemB);
        loadouts[p] = lo;
      }
      if (gameMode === 'solo' && !loadouts[1]) {
        const A2 = 'water', B2 = 'earth', S2 = 'nature';
        const lo2 = {
          elemA: A2, elemB: B2, soul: S2, activeEl: 'A',
          lmbA: rndFrom(POOL[A2].lmb), lmbB: rndFrom(POOL[B2].lmb),
          rmbA: rndFrom(POOL[A2].rmb), rmbB: rndFrom(POOL[B2].rmb),
          qSkill: rndFrom(POOL[A2].q || POOL[A2].active || []),
          eSkill: rndFrom(POOL[B2].e || POOL[B2].active || []),
          passive: pickPassive(S2), ai: true,
        };
        lo2.fusion = getFus(lo2.elemA, lo2.elemB);
        loadouts[1] = lo2;
      }
    }

    function finalizeDraft() {
      const lv = LEVELS[currentLevel];
      const bd = BOSS_DEFS[lv.boss];
      let preview = ``;
      for (let p = 0; p < 2; p++) { const lo = loadouts[p]; if (!lo) continue; const f = lo.fusion; preview += `<div class="ls" style="border-color:${PC[p]}44"><span style="color:${PC[p]}">P${p + 1}</span><span>${EL[lo.elemA].e}${EL[lo.elemB].e}${EL[lo.soul].e}</span>${f ? `<span style="color:#c084fc;font-size:10px">${f.e}${f.n}</span>` : ''}</div>`; }
      document.getElementById('plabel').textContent = 'BUILDS BEREIT';
      document.getElementById('pstep').innerHTML = `<span style="color:#8090a8">‚ùì UNBEKANNTE BEDROHUNG ‚Äî Bereite dich auf alles vor!</span>`;
      document.getElementById('cards').innerHTML = ''; document.getElementById('lrow').innerHTML = preview;
      document.getElementById('btngo').classList.add('rdy');
    }

    // ‚îÄ‚îÄ‚îÄ START GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function makePlayer(p, lo) {
      const pass = lo.passive;
      const startX = p === 0 ? GW * .28 : GW * .72, startY = GH * .76;
      return {
        id: p, x: startX, y: startY, r: 16, hp: 140, maxHp: 140,
        spd: 222 * (pass?.spdMult || 1), iframes: 0, shield: 0, invul: 0,
        stunT: 0, immobileT: 0,
        burnT: 0, burnD: 0, burnTick: 0, poisonT: 0, poisonTick: 0,
        reflectT: 0, speedBuffT: 0, stealthOn: false, stealthCrit: false, critBuff: 1, staticT: 0,
        dmgReduce: pass?.dmgReduce || 0, kbImmune: !!pass?.kbImmune,
        dodge: pass?.dodge || 0, lifesteal: pass?.lifesteal || 0,
        healBonus: pass?.healBonus || 1, dashCDMult: pass?.dashMult || 1,
        fusionCDR: pass?.fusionCDR || 0, thorns: pass?.thorns || 0,
        photoRegen: pass?.photoRegen || 0, hpRegen: pass?.hpRegen || 0,
        dmgBuff: null, selfDot: null, teamCDRBuff: null,
        _rageBuff: 0, _hasteBuff: 0, _focusBuff: 0,
        cds: { lmb: 0, rmb: 0, q: 0, e: 0, r: 0, dash: 0 }, chargeT: 0, chargeHeld: false, alive: true,
        _netKeys: {},
      };
    }

    // ‚îÄ‚îÄ‚îÄ LEVEL SHUFFLE (Roguelike) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function shuffleLevels() {
      // Fisher-Yates shuffle indices 0-5, keep index 6 (Schattenvoid) pinned as final
      const sub = LEVELS.slice(0, 6);
      for (let i = sub.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[sub[i], sub[j]] = [sub[j], sub[i]]; }
      for (let i = 0; i < 6; i++)LEVELS[i] = sub[i];
      // Update level ids to match new positions
      LEVELS.forEach((lv, i) => lv.id = i);
    }

    function startGame() {
      if (!loadouts[0]) return;
      // ‚îÄ Shuffle already happened in goSolo ‚îÄ
      // ‚îÄ Reset all held keys so player doesn't auto-walk into the level ‚îÄ
      for (const k in keys) keys[k] = false;
      const lv = LEVELS[currentLevel];
      pillars = buildPillarsForLayout(lv.pillarsLayout, lv.boss);
      // Solo: only P1. Co-op: P1 + P2
      if (gameMode === 'solo') {
        players = [makePlayer(0, loadouts[0])];
      } else {
        players = [makePlayer(0, loadouts[0]), makePlayer(1, loadouts[1])];
      }
      gamePhase = 0; phaseCD = 0; enemies = []; projs = []; parts = []; floats = []; fieldFx = []; lvAmbient = []; crates = []; lootOrbs = [];
      shakeX = shakeY = shakeT = shakeA = 0; ann = { text: '', t: 0, max: 0 };
      levelTimer = 0; killCount = 0; lastBossHp = 9999; p2autoT = 0; hazardTimer = 0; hazardActive = false;
      _lvScale = 1; // reset scaling for guardians phase
      pickModifiers();
      // Spawn breakable crates
      const crateCount = 5 + Math.floor(Math.random() * 4);
      for (let ci = 0; ci < crateCount; ci++) { const sp = safePos(24, 30); crates.push({ x: sp.x - 16, y: sp.y - 16, w: 32, h: 32, hp: 40, maxHp: 40 }); }
      // Spawn guardians spread across top half
      const bd = BOSS_DEFS[lv.boss];
      const gCount = lv.guardians.length;
      lv.guardians.forEach((el, i) => {
        const t = (gCount === 1) ? 0.5 : (i / (gCount - 1));
        const gx = PAD + 80 + (GW - PAD * 2 - 160) * t;
        const gy = GH * 0.25 + Math.sin(i * 1.3) * 60;
        spawnGuardian(el, gx, gy);
      });
      showAnn(`${bd.emoji} ${lv.name.toUpperCase()} ‚Äî BESIEGE DIE W√ÑCHTER!`, 4);
      showScreen('game');
      cv = document.getElementById('cv'); cv.width = GW; cv.height = GH; ctx = cv.getContext('2d');
      addListeners(); running = true; lastT = performance.now(); animId = requestAnimationFrame(loop);
    }

    function spawnGuardian(el, gx, gy) {
      const scale = Math.pow(1.15, currentLevel);
      const hp = Math.round(420 * scale);
      enemies.push({
        id: 'g' + Date.now(), type: 'guardian', element: el,
        x: clamp(gx, PAD + 38, GW - PAD - 38), y: clamp(gy, PAD + 38, GH - PAD - 38),
        r: 30, hp, maxHp: hp, spd: 66, atkT: 2.6, angle: 0, hitFlash: 0,
        _wseed: Math.random() * 100,
        stunT: 0, slowT: 0, slowF: 1, blindT: 0, fearT: 0, frozenT: 0,
        burnT: 0, burnD: 0, burnTick: 0, poisonT: 0, poisonTick: 0, _curseDR: 0, _curseDur: 0,
      });
    }

    let _lvScale = 1; // global damage scaling for enemies
    function spawnBoss() {
      const lv = LEVELS[currentLevel]; const bd = BOSS_DEFS[lv.boss];
      const scale = Math.pow(1.15, currentLevel);
      _lvScale = scale;
      const scaledHp = Math.round(bd.hp * scale);
      const pos = safePos(bd.r + 8);
      // Pick sub-elements for Avatar system (Phase 2/3)
      const otherEls = ALL_EL.filter(e => e !== bd.boss_el);
      const shuffled = [...otherEls].sort(() => Math.random() - .5);
      const boss = {
        id: 'boss', type: 'boss', element: bd.boss_el,
        x: pos.x, y: pos.y, r: bd.r, hp: scaledHp, maxHp: scaledHp, phase: 0,
        spd: bd.phases[0].spd, atkT: 2.2, angle: 0, hitFlash: 0,
        stunT: 0, slowT: 0, slowF: 1, blindT: 0, fearT: 0, frozenT: 0,
        burnT: 0, burnD: 0, burnTick: 0, poisonT: 0, poisonTick: 0, _curseDR: 0, _curseDur: 0,
        specialCD: 7, specialIdx: 0,
        chargeCD: bd.phases[0].chargeCD, charging: false, chargeDx: 0, chargeDy: 0, chargeRemain: 0,
        minionCD: 15, minionSpawnCount: 0, phase3T: 5, orbRingCD: 5, _wseed: Math.random() * 100,
        mSpawns: [...bd.phases.map((_, i) => scaledHp * (1 - (i / bd.phases.length))).slice(1)],
        bossEl: bd.boss_el, bossData: bd,
        // Avatar system: sub-elements for Phase 2/3
        _subEl1: shuffled[0], _subEl2: shuffled[1],
        _healUses: 0, // nature boss heal counter
        // anti-stuck
        _stuckCheckX: pos.x, _stuckCheckY: pos.y, _stuckTimer: 0,
      };
      activeAffixes.forEach(a => a.apply(boss));
      if (boss._rasend) { boss.spd = Math.round(boss.spd * 1.35); boss.atkT = 1.6; }
      enemies.push(boss);
      emitP(pos.x, pos.y, bd.color || EL[bd.boss_el].c, 45, 200);
      doShake(18, .7);
    }

    function spawnMinion(x, y, el) {
      const lv = LEVELS[currentLevel];
      const bd = BOSS_DEFS[lv.boss];
      const ph = bd.phases[getBossPhase()];
      const scale = Math.pow(1.15, currentLevel);
      const mhp = Math.round((ph?.minionHP || 75) * scale);
      enemies.push({
        id: 'm' + Date.now() + Math.random(), type: 'minion',
        element: el || ph?.minionEl || lv.boss,
        x: clamp(x, PAD + 22, GW - PAD - 22), y: clamp(y, PAD + 22, GH - PAD - 22),
        r: 18, hp: mhp, maxHp: mhp,
        spd: 148, atkT: 1.6, angle: 0, hitFlash: 0, _wseed: Math.random() * 100,
        stunT: 0, slowT: 0, slowF: 1, blindT: 0, fearT: 0, frozenT: 0,
        burnT: 0, burnD: 0, burnTick: 0, poisonT: 0, poisonTick: 0, _curseDR: 0, _curseDur: 0,
      });
    }

    function getBossPhase() {
      const b = enemies.find(e => e.type === 'boss'); if (!b) return 0;
      const bd = b.bossData;
      if (b.hp > bd.hp * 0.67) return 0;
      if (b.hp > bd.hp * 0.33) return 1;
      return 2;
    }

    // ‚îÄ‚îÄ‚îÄ SAFE SPAWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function safePos(r, tries = 120) {
      for (let i = 0; i < tries; i++) {
        const x = PAD + r + 40 + Math.random() * (GW - PAD * 2 - r * 2 - 80);
        const y = PAD + r + 40 + Math.random() * (GH - PAD * 2 - r * 2 - 80);
        if (pillHit(x, y, r + 14)) continue;
        let ok = true;
        for (const pl of players) { if (pl && Math.sqrt((pl.x - x) ** 2 + (pl.y - y) ** 2) < 130) { ok = false; break; } }
        if (ok) return { x, y };
      }
      // fallback: centre-ish clear zone
      return { x: GW / 2 + (Math.random() - .5) * 80, y: GH * 0.35 + (Math.random() - .5) * 60 };
    }

    // ‚îÄ‚îÄ‚îÄ FALLBACK ULTIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const FALLBACK_ULTI = {
      fire: { n: 'Inferno-Ring', e: 'üî•', d: '16 Feuerb√§lle aus dir heraus.', cd: 18, el: 'fire', fx: 'fbFire' },
      water: { n: 'Tidalwelle', e: 'üíß', d: 'Breite Slow-Welle 10 Projektile.', cd: 18, el: 'water', fx: 'fbWater' },
      earth: { n: 'Erdbeben', e: 'ü™®', d: 'Telegraphed Stun-AoE 180px.', cd: 18, el: 'earth', fx: 'fbEarth' },
      wind: { n: 'Vakuum', e: 'üåÄ', d: 'Zieht alle Gegner ran + AoE-Burst.', cd: 18, el: 'wind', fx: 'fbWind' },
      nature: { n: 'Sporenregen', e: 'üåø', d: 'Gift-Zone 8s √ºberall in der Arena.', cd: 18, el: 'nature', fx: 'fbNature' },
      light: { n: 'G√∂ttlicher Blitz', e: '‚ú®', d: '3 √ó Verz√∂gerte Blitze auf Gegner.', cd: 18, el: 'light', fx: 'fbLight' },
      darkness: { n: 'Void-Entladung', e: 'üåë', d: 'True 150 + Fear via Meter-Ring.', cd: 18, el: 'darkness', fx: 'fbDark' },
    };
    function getUlti(p) {
      const lo = loadouts[p]; if (!lo) return null;
      if (lo.fusion) { const f = lo.fusion; return { name: f.n, cd: f.cd, element: f.el, tags: ['FUSION'], desc: f.d, status: null, synergy: null, _raw: f }; }
      const soul = lo.soul || lo.elemA;
      const fb = FALLBACK_ULTI[soul] || FALLBACK_ULTI[lo.elemA];
      if (!fb) return null;
      return { name: fb.n, cd: fb.cd, element: fb.el, tags: ['OVERDRIVE'], desc: fb.d, status: null, synergy: null, _fb: fb };
    }

    // ‚îÄ‚îÄ‚îÄ AFFIXES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const AFFIX_POOL = [
      {
        id: 'rasend', name: 'RASEND', emoji: '‚ö°', col: '#f97316',
        desc: 'Boss 35% schneller & greift √∂fter an.',
        apply(b) { b._rasend = true; }
      },
      {
        id: 'splitter', name: 'SPLITTER', emoji: 'üí•', col: '#a855f7',
        desc: 'Boss spawnt alle 10s Verst√§rkung.',
        apply(b) { b._splitter = true; b._splitterCD = 10; }
      },
      {
        id: 'reflektor', name: 'REFLEKTOR', emoji: 'üõ°', col: '#42a5f5',
        desc: 'Alle 20s: 4s Reflektions-Phase (Vorsicht!).',
        apply(b) { b._reflektor = true; b._reflektCD = 18; b._reflektT = 0; }
      },
    ];

    // ‚îÄ‚îÄ‚îÄ ARENA MODS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ARENA_MOD_POOL = [
      {
        id: 'slippery', name: 'RUTSCHIGER BODEN', emoji: '‚ùÑ', col: '#90caf9', lvMin: 1,
        desc: 'Bewegungstr√§gheit (Wasser-Drift).'
      },
      {
        id: 'firefields', name: 'FEUERFELDER', emoji: 'üî•', col: '#ff6b1a', lvMin: 2,
        desc: 'Telegraphed Feuerzonen periodisch.'
      },
      {
        id: 'darkmod', name: 'DUNKELHEIT', emoji: 'üåë', col: '#a855f7', lvMin: 3,
        desc: 'Eingeschr√§nkte Sicht (Vignette).'
      },
      {
        id: 'shockwave', name: 'SCHOCKWELLE', emoji: 'üí´', col: '#f4c542', lvMin: 4,
        desc: 'Periodische Bodenersch√ºtterungen.'
      },
    ];

    let activeAffixes = [], activeArenaMod = null, arenaTick = 0;
    let driftVx = [0, 0], driftVy = [0, 0]; // slippery per player
    let annPersist = { text: '', col: '#f4c542', t: 0 }; // persistent banner
    let hazardTimer = 0, hazardActive = false; // 6s active / 12s cooldown
    let crates = [], lootOrbs = []; // breakable objects & loot

    function pickModifiers() {
      const lv = currentLevel;
      const n = lv === 0 ? 1 : lv < 4 ? Math.min(2, 1 + Math.floor(Math.random() * 2)) : 2;
      activeAffixes = [...[...AFFIX_POOL].sort(() => Math.random() - .5)].slice(0, n);
      const elig = ARENA_MOD_POOL.filter(m => m.lvMin <= lv);
      activeArenaMod = (lv > 0 && elig.length > 0 && Math.random() < .75) ? elig[Math.floor(Math.random() * elig.length)] : null;
      arenaTick = 0; driftVx = [0, 0]; driftVy = [0, 0];
    }

    // ‚îÄ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addListeners() {
      document.addEventListener('keydown', onKD); document.addEventListener('keyup', onKU);
      cv.addEventListener('mousemove', onMM); cv.addEventListener('mousedown', onMD); cv.addEventListener('mouseup', onMU);
      cv.addEventListener('contextmenu', e => e.preventDefault());
      cv.addEventListener('mousemove', checkTip); cv.addEventListener('mouseleave', () => hideTip());
    }
    function removeListeners() {
      document.removeEventListener('keydown', onKD); document.removeEventListener('keyup', onKU);
    }
    function onKD(e) {
      keys[e.key] = true; keys[e.key.toLowerCase()] = true;
      const k = e.key.toLowerCase();
      if ([' ', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(k)) e.preventDefault();
      if (k === 'tab') { e.preventDefault(); switchEl(0); }
      if (k === 'q') useSlot(0, 'q'); if (k === 'e') useSlot(0, 'e');
      if (k === 'r' && !e.shiftKey) useFusion(0);
      if (e.key === ' ') doDash(0);
      // P2 local
      if (k === 'p') switchEl(1); if (k === '1') useSlot(1, 'q'); if (k === '2') useSlot(1, 'e');
      if (k === '3') useFusion(1); if (e.key === 'R' && e.shiftKey) doDash(1);
    }
    function onKU(e) { keys[e.key] = false; keys[e.key.toLowerCase()] = false; if (e.button === 2) releaseCharge(0); }
    function onMM(e) { const r = cv.getBoundingClientRect(); mx = e.clientX - r.left; my = e.clientY - r.top; }
    function onMD(e) { if (e.button === 0) useLMB(0); if (e.button === 2) { players[0].chargeHeld = true; players[0].chargeT = 0; } }
    function onMU(e) { if (e.button === 2) releaseCharge(0); }
    function switchEl(p) { const lo = loadouts[p]; if (!lo) return; lo.activeEl = lo.activeEl === 'A' ? 'B' : 'A'; emitP(players[p].x, players[p].y, EL[lo.activeEl === 'A' ? lo.elemA : lo.elemB].c, 8, 60); }
    function curEl(p) { const lo = loadouts[p]; return lo?.activeEl === 'A' ? lo.elemA : lo.elemB; }
    function cdM(p) { return loadouts[p]?.passive?.cdReduce ? 1 - loadouts[p].passive.cdReduce : 1; }
    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
    function pillHit(x, y, r) { for (const p of pillars) { const ex = clamp(x, p.x, p.x + p.w), ey = clamp(y, p.y, p.y + p.h); if (Math.sqrt((x - ex) ** 2 + (y - ey) ** 2) < r) return true; } return false; }
    function nearE(x, y) { return enemies.filter(e => e.hp > 0 && !e.friendly).sort((a, b) => (a.x - x) ** 2 + (a.y - y) ** 2 - (b.x - x) ** 2 - (b.y - y) ** 2)[0] || null; }
    function aV(p) {
      if (p === 0) { const pl = players[0], dx = mx - pl.x, dy = my - pl.y, l = Math.sqrt(dx * dx + dy * dy) || 1; return { nx: dx / l, ny: dy / l }; }
      const pl = players[1]; if (!pl) return { nx: 0, ny: -1 };
      const t = nearE(pl.x, pl.y);
      if (!t) return { nx: 0, ny: -1 }; const dx = t.x - pl.x, dy = t.y - pl.y, l = Math.sqrt(dx * dx + dy * dy) || 1; return { nx: dx / l, ny: dy / l };
    }
    function useLMB(p) {
      if (!running || !players[p]?.alive) return;
      const lo = loadouts[p], pl = players[p];
      const sk = lo.activeEl === 'A' ? lo.lmbA : lo.lmbB;
      if (!sk || pl.cds.lmb > 0) return;
      pl.cds.lmb = sk.cd * cdM(p); castSk(p, sk, curEl(p));
    }
    function releaseCharge(p) {
      const pl = players[p]; if (!pl?.chargeHeld || !running || !pl.alive) { if (pl) pl.chargeHeld = false; return; }
      pl.chargeHeld = false; const lo = loadouts[p];
      const sk = lo.activeEl === 'A' ? lo.rmbA : lo.rmbB;
      if (!sk || pl.cds.rmb > 0) return;
      const cf = Math.min(1, pl.chargeT / 1.5); if (cf < .15) return;
      pl.cds.rmb = sk.cd * cdM(p); castSk(p, { ...sk, dmg: (sk.dmg || 20) * cf }, curEl(p));
      doShake(4 * cf, .14); pl.chargeT = 0;
    }
    function useSlot(p, s) {
      if (!running || !players[p]?.alive) return;
      const lo = loadouts[p], pl = players[p];
      const sk = s === 'q' ? lo.qSkill : lo.eSkill, el = s === 'q' ? lo.elemA : lo.elemB;
      if (!sk || pl.cds[s] > 0) return; pl.cds[s] = sk.cd * cdM(p); castSk(p, sk, el);
    }
    function useFusion(p) {
      if (!running || !players[p]?.alive) return;
      const pl = players[p];
      const ulti = getUlti(p);
      if (!ulti || pl.cds.r > 0) return;
      const realCD = (ulti._raw?.cd || ulti.cd || 18) * (1 - (pl.fusionCDR || 0));
      pl.cds.r = realCD;
      if (ulti._fb) castFallbackUlti(p, ulti._fb);
      else castFusion(p);
    }
    function doDash(p) {
      if (!running || !players[p]?.alive) return; const pl = players[p]; if (pl.cds.dash > 0) return;
      pl.cds.dash = 2.6 * (pl.dashCDMult || 1);
      let dx = 0, dy = 0;
      if (p === 0) { if (keys['a'] || keys['ArrowLeft']) dx -= 1; if (keys['d'] || keys['ArrowRight']) dx += 1; if (keys['w'] || keys['ArrowUp']) dy -= 1; if (keys['s'] || keys['ArrowDown']) dy += 1; }
      else { if (keys['j']) dx -= 1; if (keys['l']) dx += 1; if (keys['i']) dy -= 1; if (keys['k']) dy += 1; }
      if (!dx && !dy) { const v = aV(p); dx = v.nx; dy = v.ny; }
      const dl = Math.sqrt(dx * dx + dy * dy) || 1, ox = pl.x, oy = pl.y;
      pl.x = clamp(pl.x + (dx / dl) * 168, PAD + pl.r, GW - PAD - pl.r); pl.y = clamp(pl.y + (dy / dl) * 168, PAD + pl.r, GH - PAD - pl.r);
      pl.iframes = .4; if (loadouts[p]?.passive?.pid === 'nacht') { pl.stealthOn = true; pl.iframes = .9; }
      emitP(ox, oy, EL[loadouts[p].elemA].c, 12, 88, dx / dl, dy / dl);
    }

    // ‚îÄ‚îÄ‚îÄ CAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function gM(p) {
      const pl = players[p]; let m = pl.critBuff || 1;
      if (pl.stealthCrit) { m = 2.5; pl.stealthCrit = false; pl.stealthOn = false; pl.critBuff = 1; }
      if (loadouts[p]?.passive?.pid === 'statik' && pl.staticT >= 1) { m = Math.max(m, 1.4); pl.staticT = 0; }
      // dmgBuff from √úberhitzung, Opferung etc.
      if (pl.dmgBuff && pl.dmgBuff.t > 0) m = Math.max(m, pl.dmgBuff.f || 1);
      // innerfire passive: <30% HP ‚Üí +50%
      if (loadouts[p]?.passive?.pid === 'innerfire' && pl.hp < pl.maxHp * .30) m = Math.max(m, 1.5);
      pl.critBuff = 1; return m;
    }
    function castSk(p, sk, el) {
      const pl = players[p], { nx, ny } = aV(p), E = EL[el], mult = gM(p);
      const tx = p === 0 ? mx : nearE(pl.x, pl.y)?.x || pl.x, ty = p === 0 ? my : nearE(pl.x, pl.y)?.y || pl.y;
      // ‚îÄ Cast flash ring ‚îÄ
      const cfR = sk.r || 18;
      parts.push({ x: pl.x, y: pl.y, vx: 0, vy: 0, life: .18, maxLife: .18, c: E.c, r: cfR * 1.6, _ring: true, _rOuter: cfR * 2.2, _col: E.c });
      emitP(pl.x, pl.y, E.c, 10 + Math.round((sk.dmg || 20) / 8), 90, nx, ny);
      switch (sk.t) {
        case 'proj': default:
          {
            const pr = { x: pl.x, y: pl.y, vx: nx * (sk.speed || 485), vy: ny * (sk.speed || 485), r: sk.r || 9, color: E.c, glow: E.g, dmg: (sk.dmg || 20) * mult, team: 'p', srcP: p, el, pierce: sk.pierce, bounce: !!sk.bounce, burn: sk.burn, poison: sk.poison, slow: sk.slow, stun: sk.stun, healHit: sk.healHit, homing: sk.homing, throughWalls: sk.throughWalls, aoe: sk.aoe, _banishDur: sk.banish || undefined, fear: sk.fear || undefined };
            if (sk.rangeMult) { pr._rangeMult = sk.rangeMult; pr._originX = pl.x; pr._originY = pl.y; pr._baseDmg = pr.dmg; }
            if (sk.arc) pr._arc = true;
            if (sk.boomerang) { pr._boomerang = true; pr._maxLife = pr.life || 3; }
            if (sk.pulseAoe) { pr._pulseAoe = sk.pulseAoe; pr._pulseTick = 0; }
            if (sk.poisonZ) pr._poisonZ = true;
            if (sk.bomb) pr._bomb = sk.bomb;
            if (sk.healMark) pr._healMark = sk.healMark;
            if (sk.silence) pr._silence = sk.silence;
            spP(pr);
          } break;
        case 'multi':
          for (let i = 0; i < (sk.cnt || 3); i++) { const a = Math.atan2(ny, nx) + (i - (sk.cnt - 1) / 2) * (sk.spr || .4) / Math.max(1, sk.cnt - 1); spP({ x: pl.x, y: pl.y, vx: Math.cos(a) * (sk.speed || 435), vy: Math.sin(a) * (sk.speed || 435), r: sk.r || 7, color: E.c, glow: E.g, dmg: (sk.dmg || 13) * mult, team: 'p', srcP: p, el, burn: sk.burn, poison: sk.poison }); } break;
        case 'beam': case 'hitscan': {
          const rng = sk.range || 245, cn = sk.cA || .45, sr = 3;
          // Raycast step-loop: walk along beam direction, stop at first wall
          let rayLen = rng, hitWall = false;
          for (let d = 10; d <= rng; d += 10) {
            const rx = pl.x + nx * d, ry = pl.y + ny * d;
            let blocked = false;
            for (const wp of pillars) {
              const ex = clamp(rx, wp.x, wp.x + wp.w), ey = clamp(ry, wp.y, wp.y + wp.h);
              if (Math.sqrt((rx - ex) ** 2 + (ry - ey) ** 2) < sr) {
                if (wp.temp && wp.hp != null) {
                  // Destructible wall: deal damage to it and stop beam here
                  wp.hp -= (sk.dmg || 17) * mult;
                  if (wp.hp <= 0) { const pi = pillars.indexOf(wp); if (pi >= 0) pillars.splice(pi, 1); }
                }
                rayLen = d; blocked = true; hitWall = true; break;
              }
            }
            if (blocked) break;
          }
          // Hit enemies within cone that are not behind walls
          enemies.forEach(e => {
            if (e.hp <= 0) return;
            const dx = e.x - pl.x, dy = e.y - pl.y, dist = Math.sqrt(dx * dx + dy * dy) || 1;
            if (dist > rayLen + e.r) return; // behind wall
            if (Math.acos(Math.min(1, (dx / dist * nx + dy / dist * ny))) < cn)
              hitE(e, (sk.dmg || 17) * mult, el, p, sk.burn, sk.poison, sk.slow, sk.kb, sk.stun, sk.healHit);
          });
          emitP(pl.x + nx * rayLen * .5, pl.y + ny * rayLen * .5, E.c, 12, 58, nx, ny);
          // Beam particles along the ray
          for (let d2 = 20; d2 <= rayLen; d2 += 28)parts.push({ x: pl.x + nx * d2, y: pl.y + ny * d2, vx: (Math.random() - .5) * 18, vy: (Math.random() - .5) * 18, life: .14, maxLife: .14, c: E.c, r: 3.5 });
          break;
        }

        case 'aoe': { const isMelee = sk.tags && (sk.tags.includes('NAHKAMPF') || sk.tags.includes('MELEE')); const ax = isMelee ? pl.x : tx, ay = isMelee ? pl.y : ty; doAoe(ax, ay, sk.r || 80, (sk.dmg || 58) * mult, el, p, sk.stun, sk.burn, sk.kb, sk.fear, sk.blind); emitP(ax, ay, E.c, 16, 105); break; }
        case 'daoe': fieldFx.push({ type: 'meter', x: tx, y: ty, t: sk.delay || 1, r: sk.r || 80, dmg: (sk.dmg || 80) * mult, el, stun: sk.stun, burn: sk.burn, blind: sk.blind, fear: sk.fear, srcP: p }); emitP(tx, ty, E.c, 8, 42); break;
        case 'zone': fieldFx.push({ type: 'zone', x: tx, y: ty, t: sk.life || 5, r: sk.r || 80, el, dmg: sk.dmgTick || 0, healTick: sk.healTick || 0, slow: sk.slow, burn: sk.burn, poison: sk.poison, healZ: sk.healZ, tick: 0, srcP: p, followP: false }); emitP(pl.x, pl.y, E.c, 10, 65); break;
        case 'wall':
          if (sk.windWall) fieldFx.push({ type: 'windwall', x: tx - 6, y: ty - 50, w: 12, h: 100, t: sk.life || 5 });
          else pillars.push({ x: tx - (sk.ww || 10) / 2, y: ty - (sk.wh || 100) / 2, w: sk.ww || 10, h: sk.wh || 100, hp: sk.hp || 200, maxHp: sk.hp || 200, el, life: sk.life || 6, temp: true });
          emitP(pl.x, pl.y, E.c, 10, 65); break;
        case 'dashSkill': { const ox = pl.x, oy = pl.y; pl.x = clamp(pl.x + nx * (sk.range || 185), PAD + pl.r, GW - PAD - pl.r); pl.y = clamp(pl.y + ny * (sk.range || 185), PAD + pl.r, GH - PAD - pl.r); pl.iframes = .38; enemies.forEach(e => { if (e.hp <= 0) return; if (Math.sqrt((e.x - ox) ** 2 + (e.y - oy) ** 2) < (sk.range || 185) + e.r) hitE(e, (sk.dmg || 28) * mult, el, p, sk.burn, null, null, sk.kb); }); emitP(ox, oy, E.c, 12, 85, nx, ny); break; }
        case 'buff':
          if (sk.shield) pl.shield = Math.min(pl.shield + (sk.shield || 80) * (pl.healBonus || 1), 300);
          if (sk.reflectDur) pl.reflectT = sk.reflectDur; if (sk.cleanse) { pl.burnT = 0; pl.poisonT = 0; pl.stunT = 0; }
          if (sk.speedBuff) pl.speedBuffT = sk.speedBuff; if (sk.stealth) { pl.stealthOn = true; pl.stealthCrit = true; }
          if (sk.critMult) pl.critBuff = sk.critMult;
          // √úberhitzung: damage buff + self DoT
          if (sk.dmgBuff) { pl.dmgBuff = { f: sk.dmgBuff.f, t: sk.dmgBuff.dur }; spawnFT(pl.x, pl.y - 28, '√úBERHITZT +' + Math.round((sk.dmgBuff.f - 1) * 100) + '%!', E.c); }
          if (sk.selfDot) { pl.selfDot = { d: sk.selfDot.d, t: sk.selfDot.dur }; }
          // Versteinerung: invulnerable but immobile
          if (sk.invul) { pl.invul = sk.invul; pl.immobileT = sk.immobile || sk.invul; spawnFT(pl.x, pl.y - 28, 'VERSTEINERT ' + sk.invul + 's', E.c); }
          // Team CDR buff (√úberwucherung)
          if (sk.teamCDR) { players.forEach(pl2 => { if (pl2.alive) { pl2.teamCDRBuff = { f: sk.teamCDR.f, t: sk.teamCDR.dur }; } }); spawnFT(pl.x, pl.y - 28, 'TEAM CDR √ó' + Math.round(sk.teamCDR.f * 100) + '% ' + sk.teamCDR.dur + 's!', E.c); }
          spawnFT(pl.x, pl.y - 28, sk.shield ? '+' + Math.round(sk.shield * (pl.healBonus || 1)) + ' üõ°' : sk.cleanse ? 'GEREINIGT' : sk.dmgBuff ? '' : sk.invul ? '' : sk.stealth ? 'STEALTH' : sk.teamCDR ? '' : 'AKTIV', E.c);
          emitP(pl.x, pl.y, E.c, 11, 85); break;
        case 'hook': {
          // Skillshot: fire a hook projectile toward cursor
          spP({ x: pl.x, y: pl.y, vx: nx * (sk.speed || 380), vy: ny * (sk.speed || 380), r: sk.r || 11, color: E.c, glow: E.g, dmg: (sk.dmg || 32) * mult, team: 'p', srcP: p, el, _hook: true, _hookRoot: sk.root || 0 });
          emitP(pl.x, pl.y, E.c, 12, 85); break;
        }
        case 'special':
          if (sk.swap) {
            // Skillshot: fire a swap projectile toward cursor
            spP({ x: pl.x, y: pl.y, vx: nx * (sk.speed || 420), vy: ny * (sk.speed || 420), r: sk.r || 10, color: E.c, glow: E.g, dmg: (sk.dmg || 20) * mult, team: 'p', srcP: p, el, _swap: true });
          }
          if (sk.rootT) {
            // Skillshot: fire a root projectile toward cursor
            spP({ x: pl.x, y: pl.y, vx: nx * (sk.speed || 400), vy: ny * (sk.speed || 400), r: sk.r || 9, color: E.c, glow: E.g, dmg: (sk.dmg || 15) * mult, team: 'p', srcP: p, el, _rootT: sk.rootT });
          }
          if (sk.teleportBehind) {
            // Skillshot: fire a teleport projectile toward cursor
            spP({ x: pl.x, y: pl.y, vx: nx * (sk.speed || 500), vy: ny * (sk.speed || 500), r: sk.r || 8, color: E.c, glow: E.g, dmg: (sk.dmg || 18) * mult, team: 'p', srcP: p, el, _tpBehind: true, _critBuff: sk.critBuff || 2 });
          }
          if (sk.blink) {
            // Raycasted blink: step toward cursor, stop at first wall
            const bdx = tx - pl.x, bdy = ty - pl.y, bdl = Math.sqrt(bdx * bdx + bdy * bdy) || 1;
            const bnx = bdx / bdl, bny = bdy / bdl, maxBlink = Math.min(bdl, 280);
            let blinkDist = maxBlink;
            for (let bd2 = 10; bd2 <= maxBlink; bd2 += 10) { if (pillHit(pl.x + bnx * bd2, pl.y + bny * bd2, pl.r)) { blinkDist = bd2 - 10; break; } }
            // Safety loop: step back 15px until destination is clear
            while (blinkDist > 0 && pillHit(pl.x + bnx * blinkDist, pl.y + bny * blinkDist, pl.r + 10)) blinkDist -= 15;
            blinkDist = Math.max(0, blinkDist);
            pl.x = clamp(pl.x + bnx * blinkDist, PAD + pl.r, GW - PAD - pl.r);
            pl.y = clamp(pl.y + bny * blinkDist, PAD + pl.r, GH - PAD - pl.r);
            pl.iframes = .4; spawnFT(pl.x, pl.y - 28, 'BLINK!', E.c);
          }
          if (sk.curseE) {
            // Skillshot: fire a curse projectile toward cursor
            spP({ x: pl.x, y: pl.y, vx: nx * (sk.speed || 380), vy: ny * (sk.speed || 380), r: sk.r || 10, color: E.c, glow: E.g, dmg: (sk.dmg || 15) * mult, team: 'p', srcP: p, el, _curseE: sk.curseE });
          }
          // ‚îÄ‚îÄ Opferung: pay 30 HP, gain 2√ó dmg for 5s ‚îÄ‚îÄ
          if (sk.sacrifice) {
            const cost = sk.sacrifice.selfCost || 30;
            if (pl.hp > cost + 5) {
              pl.hp -= cost;
              pl.critBuff = Math.max(pl.critBuff, 2);
              pl.dmgBuff = { f: 2, t: 5 };
              spawnFT(pl.x, pl.y - 28, 'OPFER -' + cost + ' HP ‚Üí √ó2 DMG!', '#f87171');
              emitP(pl.x, pl.y, '#a855f7', 20, 130);
              const dmg = sk.sacrifice.dmg || 120;
              const t2 = nearE(pl.x, pl.y);
              if (t2) hitE(t2, dmg * mult, el, p, null, null, null, null, null, null, true);
            } else spawnFT(pl.x, pl.y - 28, 'ZU WENIG HP!', '#f87171');
          }
          // ‚îÄ‚îÄ Banish: target enters stun+invul state (removed from combat) ‚îÄ‚îÄ
          if (sk.banish) {
            spP({ x: pl.x, y: pl.y, vx: nx * (sk.speed || 380), vy: ny * (sk.speed || 380), r: sk.r || 12, color: E.c, glow: E.g, dmg: (sk.dmg || 25) * mult, team: 'p', srcP: p, el, _banishDur: sk.banish, pierce: false });
          }
          // ‚îÄ‚îÄ Chain Lightning: jump to 3 nearest enemies ‚îÄ‚îÄ
          if (sk.chainLightning) {
            const chainDmg = (sk.chainDmg || 40) * mult, chainHeal = sk.chainHeal || 20;
            const sortedE = enemies.filter(e => e.hp > 0).sort((a, b) => (a.x - pl.x) ** 2 + (a.y - pl.y) ** 2 - (b.x - pl.x) ** 2 - (b.y - pl.y) ** 2).slice(0, 3);
            let lastX = pl.x, lastY = pl.y;
            sortedE.forEach((e, i) => {
              setTimeout(() => {
                if (!running || e.hp <= 0) return;
                hitE(e, chainDmg * (1 - i * .2), el, p, null, null, null, null, null, null, false);
                pl.hp = Math.min(pl.maxHp, pl.hp + chainHeal * (pl.healBonus || 1));
                spawnFT(e.x, e.y - 18, '‚ö°+' + chainHeal, E.c);
                // Lightning arc particle trail
                emitP(e.x, e.y, E.c, 8, 80);
              }, i * 80);
              lastX = e.x; lastY = e.y;
            });
            if (sortedE.length === 0) spawnFT(pl.x, pl.y - 28, 'KEIN ZIEL', '#666');
          }
          // ‚îÄ‚îÄ Summon Minion (nature treant tank) ‚îÄ‚îÄ
          if (sk.summonMinion) {
            const sp = safePos(28, 20);
            enemies.push({
              id: 'treant_' + Date.now(), type: 'minion', team: 'p', element: el,
              x: sp.x, y: sp.y, r: 22, hp: 160, maxHp: 160, spd: 0, atkT: 99, angle: 0, hitFlash: 0,
              isTaunt: true, friendly: true, srcP: p,
              stunT: 0, slowT: 0, slowF: 1, blindT: 0, fearT: 0, frozenT: 0,
              burnT: 0, burnD: 0, burnTick: 0, poisonT: 0, poisonTick: 0, _curseDR: 0, _curseDur: 0,
              _wseed: Math.random() * 100, life: 10, _minionTimer: 10,
            });
            spawnFT(sp.x, sp.y - 28, 'üå≥ TREANT BESCHWOREN', '#4ade80');
          }
          // ‚îÄ‚îÄ Revive: instant ally revival ‚îÄ‚îÄ
          if (sk.revive) {
            const dead = players.find(pl2 => !pl2.alive && pl2 !== pl);
            if (dead) { dead.alive = true; dead.hp = dead.maxHp * .4; dead.iframes = 1.5; spawnFT(dead.x, dead.y - 28, 'WIEDERBELEBT!', '#fde68a'); }
            else spawnFT(pl.x, pl.y - 28, 'KEIN TOTER VERB√úNDETER', '#666');
          }
          // ‚îÄ‚îÄ Feint: dash ghost decoy ‚îÄ‚îÄ
          if (sk.feint) { pl.stealthOn = true; pl.iframes = .8; spawnFT(pl.x, pl.y - 28, 'FEINT', '#a855f7'); }
          emitP(pl.x, pl.y, E.c, 9, 75); break;
      }
    }

    // ‚îÄ‚îÄ‚îÄ FUSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function castFusion(p) {
      const f = loadouts[p]?.fusion; if (!f) return;
      const pl = players[p], { nx, ny } = aV(p), E = EL[f.el];
      doShake(14, .55); showAnn(f.e + ' ' + f.n.toUpperCase(), 3); emitP(pl.x, pl.y, E.c, 24, 145, nx, ny);
      spP({ x: pl.x, y: pl.y, vx: nx * 190, vy: ny * 190, r: 24, color: E.c, glow: E.g, dmg: 85 + Math.random() * 30, team: 'p', srcP: p, el: f.el, life: 5, isFusion: true, fusionFx: f.fx, pierce: false });
      const t = nearE(pl.x, pl.y);
      switch (f.fx) {
        case 'holyWater': pl.invul = 3; pl.hp = Math.min(pl.maxHp, pl.hp + 50 * (pl.healBonus || 1)); spawnFT(pl.x, pl.y - 28, 'INVUL 3s', '#fde68a'); break;
        case 'diamondSkin': pl.invul = 5; spawnFT(pl.x, pl.y - 28, 'DIAMANT 5s', '#d4d8a0'); break;
        case 'lightSpeed': enemies.forEach(e => { if (e.hp > 0) { e.slowT = 4; e.slowF = .2; } }); break;
        case 'pollenSleep': enemies.forEach(e => { if (e.hp > 0) { e.stunT = Math.max(e.stunT, 3); } }); break;
        case 'eclipse': enemies.forEach(e => { if (e.hp > 0) hitE(e, 220, f.el, p, null, null, null, null, null, null, true) }); doShake(26, 1); emitP(GW / 2, GH / 2, '#a855f7', 50, 220); break;
        case 'sandstorm': enemies.forEach(e => { if (e.hp > 0) e.blindT = Math.max(e.blindT || 0, 5); }); break;
        case 'moonClear': pl.invul = 4; enemies.forEach(e => { if (e.hp > 0) e.stunT = Math.max(e.stunT, 4); }); fieldFx.push({ type: 'zone', x: GW / 2, y: GH / 2, t: 4, r: GW, el: 'light', dmg: 0, tick: 0, healZ: { a: 16, iv: 1 }, srcP: p }); break;
        case 'shadowStep': for (let i = 0; i < 5; i++)setTimeout(() => { if (!running) return; const t2 = nearE(pl.x, pl.y); if (t2) { hitE(t2, 40, f.el, p); emitP(t2.x, t2.y, '#a855f7', 6, 78); } }, i * 150); break;
        case 'worldTree': pillars.push({ x: pl.x - 22, y: pl.y - 110, w: 44, h: 220, hp: 600, maxHp: 600, el: 'nature', temp: true, life: 9 }); fieldFx.push({ type: 'zone', x: pl.x, y: pl.y, t: 8, r: 85, el: 'nature', dmg: 0, tick: 0, healZ: { a: 14, iv: 1 }, srcP: p }); break;
        case 'lifeSwamp': fieldFx.push({ type: 'zone', x: pl.x, y: pl.y, t: 6, r: 100, el: 'nature', dmg: 8, tick: 0, slow: { f: .5 }, healZ: { a: 12, iv: 1 }, srcP: p, followP: p }); break;
        case 'blizzard': enemies.forEach(e => { if (e.hp > 0) { e.frozenT = 3; e.stunT = Math.max(e.stunT, 3); } }); doShake(18, .7); break;
      }
    }
    function onFusionHit(orb, e) {
      const E = EL[orb.el]; doAoe(orb.x, orb.y, 100, orb.dmg, orb.el, orb.srcP); doShake(12, .45); emitP(orb.x, orb.y, E.c, 28, 155);
      switch (orb.fusionFx) {
        case 'steamRoll': doAoe(orb.x, orb.y, 140, 80, 'fire', orb.srcP, 1.5, { d: 12, dur: 3 }, null, null, 3); break;
        case 'volcano': fieldFx.push({ type: 'zone', x: orb.x, y: orb.y, t: 8, r: 90, el: 'fire', dmg: 16, tick: 0, burn: { d: 14, dur: 3 }, srcP: orb.srcP }); break;
        case 'fireTornado': fieldFx.push({ type: 'tornado', x: orb.x, y: orb.y, t: 5, r: 95, el: 'fire', dmg: 14, vx: orb.vx * .18, vy: orb.vy * .18, angle: 0, tick: 0, srcP: orb.srcP }); break;
        case 'fireVines': e.stunT = Math.max(e.stunT, 5); applyBurn(e, 20, 5); break;
        case 'supernova': e.blindT = Math.max(e.blindT || 0, 4); doShake(20, .8); break;
        case 'blackFlame': hitE(e, 200, 'darkness', orb.srcP, null, null, null, null, null, null, true); break;
        case 'mudslide': e.stunT = Math.max(e.stunT, 3); e.slowT = 8; e.slowF = .3; break;
        case 'kraken': hitE(e, 180, 'darkness', orb.srcP, null, null, null, null, 2); break;
        case 'zombieHands': e.stunT = Math.max(e.stunT, 4); hitE(e, 120, 'darkness', orb.srcP); break;
        case 'plague': e.poisonT = 8; e.poisonTick = 0; applyBurn(e, 12, 8); break;
      }
    }

    // ‚îÄ‚îÄ‚îÄ FALLBACK ULTI CAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function castFallbackUlti(p, fb) {
      const pl = players[p], { nx, ny } = aV(p), E = EL[fb.el];
      doShake(10, .4); showAnn(fb.e + ' ' + fb.n.toUpperCase() + ' (OVERDRIVE)', 2.5);
      emitP(pl.x, pl.y, E.c, 22, 145, nx, ny);
      switch (fb.fx) {
        case 'fbFire':
          for (let i = 0; i < 16; i++) { const a = (i / 16) * Math.PI * 2; spP({ x: pl.x, y: pl.y, vx: Math.cos(a) * 310, vy: Math.sin(a) * 310, r: 10, color: '#ff6b1a', glow: '#ff4500', dmg: 35, team: 'p', srcP: p, el: 'fire', burn: { d: 12, dur: 3 } }); }
          break;
        case 'fbWater':
          for (let i = 0; i < 12; i++) { const a = Math.atan2(ny, nx) + (i - 5.5) * .25; spP({ x: pl.x, y: pl.y, vx: Math.cos(a) * 320, vy: Math.sin(a) * 320, r: 13, color: '#42a5f5', glow: '#1e88e5', dmg: 28, team: 'p', srcP: p, el: 'water', slow: { f: .55, dur: 3 } }); }
          break;
        case 'fbEarth':
          fieldFx.push({ type: 'meter', x: pl.x, y: pl.y, t: .7, r: 175, dmg: 58, el: 'earth', stun: 2.2, srcP: p });
          emitP(pl.x, pl.y, '#a3a86e', 20, 110); break;
        case 'fbWind':
          enemies.forEach(e => { if (e.hp <= 0) return; const dx = pl.x - e.x, dy = pl.y - e.y, dl = Math.sqrt(dx * dx + dy * dy) || 1; e.x = clamp(e.x + dx / dl * 175, PAD + e.r, GW - PAD - e.r); e.y = clamp(e.y + dy / dl * 175, PAD + e.r, GH - PAD - e.r); });
          setTimeout(() => { if (running) doAoe(pl.x, pl.y, 145, 32, 'wind', p); }, 350); break;
        case 'fbNature':
          fieldFx.push({ type: 'zone', x: GW / 2, y: GH / 2, t: 8, r: 900, el: 'nature', dmg: 4, tick: 0, poison: { d: 7, dur: 4 }, srcP: p }); break;
        case 'fbLight':
          for (let i = 0; i < 3; i++) { const t = () => { if (!running) return; const tgt = nearE(pl.x, pl.y); if (tgt) { fieldFx.push({ type: 'meter', x: tgt.x + (Math.random() - .5) * 90, y: tgt.y + (Math.random() - .5) * 90, t: .4, r: 58, dmg: 62, el: 'light', blind: 1.8, srcP: p }); } }; setTimeout(t, i * 240); }
          break;
        case 'fbDark':
          enemies.forEach(e => { if (e.hp > 0) hitE(e, 150, 'darkness', p, null, null, null, null, null, null, true) });
          for (let i = 0; i < 6; i++) { const a = (i / 6) * Math.PI * 2; fieldFx.push({ type: 'meter', x: pl.x + Math.cos(a) * 110, y: pl.y + Math.sin(a) * 110, t: .5, r: 48, dmg: 0, el: 'darkness', fear: 3.5, srcP: p }); }
          break;
      }
    }

    // ‚îÄ‚îÄ‚îÄ COMBAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function doAoe(x, y, r, dmg, el, p, stun, burn, kb, fear, blind, td = false) {
      enemies.forEach(e => {
        if (e.hp <= 0) return;
        if (Math.sqrt((e.x - x) ** 2 + (e.y - y) ** 2) >= r + e.r) return;
        // Raycast visibility: step from AOE center toward enemy, skip if pillar blocks
        const ddx = e.x - x, ddy = e.y - y, dist = Math.sqrt(ddx * ddx + ddy * ddy) || 1;
        const ux = ddx / dist, uy = ddy / dist;
        let blocked = false;
        for (let d = 10; d < dist - e.r; d += 10) { if (pillHit(x + ux * d, y + uy * d, 4)) { blocked = true; break; } }
        if (blocked) return;
        hitE(e, dmg, el, p, burn, null, null, kb, stun, null, td);
        if (fear) e.fearT = Math.max(e.fearT || 0, fear);
        if (blind && 'blindT' in e) e.blindT = Math.max(e.blindT || 0, blind);
      });
    }
    function hitE(e, rawDmg, atkEl, srcP, burn, poison, slow, kb, stun, healHit, trueDmg = false) {
      if (e.hp <= 0) return;
      // ‚îÄ‚îÄ Elemental Absorption: same-element heals instead of damages ‚îÄ‚îÄ
      if (!trueDmg && atkEl === e.element && !e.friendly) {
        const absorbAmt = Math.round(rawDmg * 0.5);
        e.hp = Math.min(e.maxHp, e.hp + absorbAmt);
        spawnFT(e.x, e.y - 18, 'ABSORBIERT +' + absorbAmt, '#4ade80', 'bold 13px Rajdhani');
        emitP(e.x, e.y, '#4ade80', 10, 60);
        return;
      }
      // ‚îÄ‚îÄ Rage buff: +40% dmg ‚îÄ‚îÄ
      if (srcP !== null && srcP !== undefined && players[srcP]?._rageBuff > 0) rawDmg = Math.round(rawDmg * 1.4);
      let fd = trueDmg ? rawDmg : rawDmg * getEff(atkEl, e.element);
      if (e._curseDur > 0) fd *= (1 + e._curseDR);
      if (srcP !== null && srcP !== undefined && loadouts[srcP]?.passive?.pid === 'exek' && e.hp / e.maxHp < .15) fd *= 1.8;
      // brand passive: elemental crits apply burn
      const ef = trueDmg ? 1 : getEff(atkEl, e.element);
      if (ef >= 2 && srcP !== null && loadouts[srcP]?.passive?.pid === 'brand') {
        if (!burn) burn = { d: 12, dur: 3 };
        else burn = { d: burn.d * 1.5, dur: burn.dur || 3 };
      }
      e.hp -= fd; e.hitFlash = .12; doShake(3, .1);
      if (ef >= 2) spawnFT(e.x, e.y - 18, 'CRIT! ' + Math.round(fd), '#ff4444', 'bold 15px Rajdhani');
      else if (ef <= .5) spawnFT(e.x, e.y - 18, 'Schwach ' + Math.round(fd), '#666', '11px Rajdhani');
      else spawnFT(e.x, e.y - 18, Math.round(fd).toString(), '#f4c542');
      emitP(e.x, e.y, EL[atkEl]?.c || '#fff', 8, 68);
      if (burn) applyBurn(e, burn.d, burn.dur || 3);
      if (poison) { e.poisonT = Math.max(e.poisonT || 0, poison.dur || 4); e.poisonTick = 0; }
      if (slow) { e.slowT = Math.max(e.slowT || 0, slow.dur || 2); e.slowF = Math.min(e.slowF || 1, 1 - (slow.f || .3) + .001); }
      if (stun) e.stunT = Math.max(e.stunT || 0, stun);
      if (kb && srcP !== null) { const pl = players[srcP]; const bl = Math.sqrt((e.x - pl.x) ** 2 + (e.y - pl.y) ** 2) || 1; e.x = clamp(e.x + (e.x - pl.x) / bl * (kb || 0) * .012, PAD + e.r, GW - PAD - e.r); e.y = clamp(e.y + (e.y - pl.y) / bl * (kb || 0) * .012, PAD + e.r, GH - PAD - e.r); }
      if (healHit && srcP !== null) { const pl = players[srcP]; const h = healHit * (pl.healBonus || 1); pl.hp = Math.min(pl.maxHp, pl.hp + h); spawnFT(pl.x, pl.y - 22, '+' + Math.round(h), '#4ade80'); }
      if (srcP !== null && players[srcP]?.lifesteal) { const pl = players[srcP]; pl.hp = Math.min(pl.maxHp, pl.hp + rawDmg * pl.lifesteal); }
      // healMark: hitting a marked enemy heals the marker
      if (e._healMarkT > 0 && e._healMarkP !== undefined) {
        const mpl = players[e._healMarkP]; if (mpl?.alive) { mpl.hp = Math.min(mpl.maxHp, mpl.hp + 8 * (mpl.healBonus || 1)); }
      }
      // Catalytic Resonance: check for elemental reactions
      if (e.hp > 0 && srcP !== null && !trueDmg) triggerReaction(e, atkEl, srcP);
      if (e.hp <= 0) { if (!e._dummy) killCount++; onEDeath(e); }
    }
    function applyBurn(e, d, t) { e.burnD = Math.max(e.burnD || 0, d); e.burnT = Math.max(e.burnT || 0, t); e.burnTick = Math.min(e.burnTick || .5, .5); }

    // ‚îÄ‚îÄ‚îÄ CATALYTIC RESONANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function triggerReaction(e, atkEl, srcP) {
      // Prevent reaction spam: cooldown per enemy
      if (e._reactionCD > 0) return;
      let reacted = false;

      // ‚îÄ‚îÄ FIRE-BASIS: enemy has Burn ‚îÄ‚îÄ
      if (e.burnT > 0 && atkEl !== 'fire') {
        if (atkEl === 'water') {
          // DAMPF-EXPLOSION: AoE blind
          e.burnT = 0; e.burnD = 0;
          doAoe(e.x, e.y, 90, 25, 'water', srcP); enemies.forEach(en => { if (en.hp > 0 && Math.sqrt((en.x - e.x) ** 2 + (en.y - e.y) ** 2) < 90) en.blindT = Math.max(en.blindT || 0, 3); });
          spawnFT(e.x, e.y - 38, 'üí® DAMPF!', '#90caf9', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#b0bec5', 22, 120); doShake(6, .25); reacted = true;
        } else if (atkEl === 'earth') {
          // MAGMA: damage zone
          e.burnT = 0; e.burnD = 0;
          fieldFx.push({ type: 'zone', x: e.x, y: e.y, t: 3, r: 50, el: 'fire', dmg: 15, tick: 0, burn: { d: 10, dur: 2 }, srcP });
          spawnFT(e.x, e.y - 38, 'üåã MAGMA!', '#ff6b1a', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#ff6b1a', 18, 100); reacted = true;
        } else if (atkEl === 'wind') {
          // FEUERSTURM: spread burn to nearby
          const burnD = e.burnD || 12;
          e.burnT = 0; e.burnD = 0;
          enemies.forEach(en => { if (en !== e && en.hp > 0 && Math.sqrt((en.x - e.x) ** 2 + (en.y - e.y) ** 2) < 130) { applyBurn(en, burnD, 4); emitP(en.x, en.y, '#ff6b1a', 6, 50); } });
          spawnFT(e.x, e.y - 38, 'üî• FEUERSTURM!', '#ff4500', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#ff4500', 20, 130); reacted = true;
        } else if (atkEl === 'nature' && e.poisonT > 0) {
          // VERKOHLEN: poison explodes
          const poisonBurst = Math.min(120, (e.poisonT * 9) * 20); e.poisonT = 0; e.burnT = 0; e.burnD = 0;
          hitE(e, poisonBurst, 'fire', srcP, null, null, null, null, null, null, true);
          spawnFT(e.x, e.y - 38, 'üí• VERKOHLUNG ' + Math.round(poisonBurst) + '!', '#a3e635', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#a3e635', 24, 140); doShake(8, .35); reacted = true;
        } else if (atkEl === 'light') {
          // SONNENSTICH: stun
          e.burnT = 0; e.burnD = 0;
          e.stunT = Math.max(e.stunT || 0, 1.5);
          spawnFT(e.x, e.y - 38, '‚òÄ SONNENSTICH!', '#fde68a', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#fde68a', 14, 90); reacted = true;
        } else if (atkEl === 'darkness') {
          // H√ñLLENFEUER: true damage
          e.burnT = 0; e.burnD = 0;
          hitE(e, 45, 'darkness', srcP, null, null, null, null, null, null, true);
          spawnFT(e.x, e.y - 38, 'üñ§ H√ñLLENFEUER 45!', '#a855f7', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#7c3aed', 16, 110); reacted = true;
        }
      }

      // ‚îÄ‚îÄ WATER-BASIS: enemy has Slow ‚îÄ‚îÄ
      if (!reacted && e.slowT > 0 && atkEl !== 'water') {
        if (atkEl === 'earth') {
          // SCHLAMM: root
          e.slowT = 0; e.slowF = 1;
          e.stunT = Math.max(e.stunT || 0, 2);
          spawnFT(e.x, e.y - 38, 'üü§ SCHLAMM-ROOT!', '#a16207', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#92400e', 14, 80); reacted = true;
        } else if (atkEl === 'wind') {
          // SCHOCKFROST: freeze
          e.slowT = 0; e.slowF = 1;
          e.frozenT = Math.max(e.frozenT || 0, 2); e.stunT = Math.max(e.stunT || 0, 2);
          spawnFT(e.x, e.y - 38, '‚ùÑ SCHOCKFROST!', '#7dd3fc', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#7dd3fc', 18, 100); reacted = true;
        } else if (atkEl === 'nature') {
          // BL√úTE: heal orb
          e.slowT = 0; e.slowF = 1;
          lootOrbs.push({ x: e.x, y: e.y, r: 6, life: 8, type: 'heal', val: 15 });
          spawnFT(e.x, e.y - 38, 'üå∏ BL√úTE!', '#4ade80', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#4ade80', 12, 70); reacted = true;
        } else if (atkEl === 'light') {
          // REFRAKTION: chain to 2 nearby enemies
          e.slowT = 0; e.slowF = 1;
          let chained = 0;
          enemies.forEach(en => { if (en !== e && en.hp > 0 && chained < 2 && Math.sqrt((en.x - e.x) ** 2 + (en.y - e.y) ** 2) < 150) { hitE(en, 30, 'light', srcP); emitP(en.x, en.y, '#fde68a', 8, 60); chained++; } });
          spawnFT(e.x, e.y - 38, '‚ú® REFRAKTION √ó' + (chained + 1) + '!', '#fde68a', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#fde68a', 14, 90); reacted = true;
        } else if (atkEl === 'darkness') {
          // TIEFSEE: pull zone
          e.slowT = 0; e.slowF = 1;
          fieldFx.push({ type: 'zone', x: e.x, y: e.y, t: 2.5, r: 70, el: 'darkness', dmg: 5, tick: 0, slow: { f: .8 }, srcP, _pull: true });
          spawnFT(e.x, e.y - 38, 'üåä TIEFSEE!', '#6366f1', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#4338ca', 16, 100); reacted = true;
        } else if (atkEl === 'fire') {
          // DAMPF (reverse): fire hits slowed target
          e.slowT = 0; e.slowF = 1;
          doAoe(e.x, e.y, 90, 25, 'fire', srcP); enemies.forEach(en => { if (en.hp > 0 && Math.sqrt((en.x - e.x) ** 2 + (en.y - e.y) ** 2) < 90) en.blindT = Math.max(en.blindT || 0, 3); });
          spawnFT(e.x, e.y - 38, 'üí® DAMPF!', '#90caf9', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#b0bec5', 22, 120); doShake(6, .25); reacted = true;
        }
      }

      // ‚îÄ‚îÄ EARTH-BASIS: enemy has Stun ‚îÄ‚îÄ
      if (!reacted && e.stunT > 0 && atkEl !== 'earth') {
        if (atkEl === 'wind') {
          // SANDSTURM: blind
          enemies.forEach(en => { if (en.hp > 0 && Math.sqrt((en.x - e.x) ** 2 + (en.y - e.y) ** 2) < 120) en.blindT = Math.max(en.blindT || 0, 2.5); });
          spawnFT(e.x, e.y - 38, 'üèú SANDSTURM!', '#d4a76a', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#d4a76a', 18, 110); reacted = true;
        } else if (atkEl === 'nature') {
          // √úBERWUCHERUNG: curse + slow
          e._curseDR = .3; e._curseDur = 3; e.slowT = 3; e.slowF = .6;
          spawnFT(e.x, e.y - 38, 'üåø √úBERWUCHERUNG!', '#4ade80', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#4ade80', 14, 90); reacted = true;
        } else if (atkEl === 'light') {
          // KRISTALLISATION: shield orb
          lootOrbs.push({ x: e.x, y: e.y, r: 6, life: 8, type: 'shield', val: 25 });
          spawnFT(e.x, e.y - 38, 'üíé KRISTALL!', '#93c5fd', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#93c5fd', 14, 80); reacted = true;
        } else if (atkEl === 'darkness') {
          // BEGR√ÑBNIS: execute or big damage
          if (e.hp / e.maxHp < .2) {
            hitE(e, 9999, 'darkness', srcP, null, null, null, null, null, null, true);
            spawnFT(e.x, e.y - 38, '‚ö∞ BEGR√ÑBNIS!', '#7c3aed', 'bold 16px Rajdhani'); doShake(14, .6);
          } else {
            hitE(e, 60, 'earth', srcP, null, null, null, null, .5);
            spawnFT(e.x, e.y - 38, '‚ö∞ BEGR√ÑBNIS 60!', '#7c3aed', 'bold 14px Rajdhani');
          }
          emitP(e.x, e.y, '#7c3aed', 18, 120); reacted = true;
        }
      }

      // ‚îÄ‚îÄ NATURE-BASIS: enemy has Poison ‚îÄ‚îÄ
      if (!reacted && e.poisonT > 0 && atkEl !== 'nature') {
        if (atkEl === 'light') {
          // PHOTOSYNTHESE: CDR for player
          e.poisonT = 0;
          const pl = players[srcP]; if (pl?.alive) { for (const k of ['lmb', 'rmb', 'q', 'e', 'r', 'dash']) pl.cds[k] = Math.max(0, pl.cds[k] - 1); }
          spawnFT(e.x, e.y - 38, 'üå± PHOTOSYNTHESE!', '#4ade80', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#fde68a', 14, 80); reacted = true;
        } else if (atkEl === 'darkness') {
          // F√ÑULNIS: damage-taken debuff
          e.poisonT = 0;
          e._curseDR = .25; e._curseDur = 6;
          spawnFT(e.x, e.y - 38, 'üíÄ F√ÑULNIS +25%!', '#a855f7', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#6b21a8', 14, 90); reacted = true;
        } else if (atkEl === 'wind') {
          // SPORENWOLKE: poison zone
          e.poisonT = 0;
          fieldFx.push({ type: 'zone', x: e.x, y: e.y, t: 4, r: 80, el: 'nature', dmg: 5, tick: 0, poison: { d: 6, dur: 3 }, srcP });
          spawnFT(e.x, e.y - 38, 'üçÑ SPORENWOLKE!', '#4ade80', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#4ade80', 16, 100); reacted = true;
        }
      }

      // ‚îÄ‚îÄ WIND reactions on stunned/neutral ‚îÄ‚îÄ
      if (!reacted && atkEl === 'wind') {
        if (e.blindT > 0) {
          // Already blinded ‚Äî skip wind reactions
        } else if (e.stunT > 0) {
          // POLARLICHT: blind + knockback (wind hits stunned)
          const pl = players[srcP];
          if (pl) { const bl = Math.sqrt((e.x - pl.x) ** 2 + (e.y - pl.y) ** 2) || 1; e.x = clamp(e.x + (e.x - pl.x) / bl * 250 * .012, PAD + e.r, GW - PAD - e.r); e.y = clamp(e.y + (e.y - pl.y) / bl * 250 * .012, PAD + e.r, GH - PAD - e.r); }
          e.blindT = Math.max(e.blindT || 0, 2);
          spawnFT(e.x, e.y - 38, 'üåå POLARLICHT!', '#7dd3fc', 'bold 14px Rajdhani'); emitP(e.x, e.y, '#7dd3fc', 16, 110); reacted = true;
        }
      }

      // ‚îÄ‚îÄ LIGHT + DARKNESS: ECLIPSE ‚îÄ‚îÄ
      if (!reacted) {
        const hasLight = (e.blindT > 0 || e.stunT > 0) && atkEl === 'darkness';
        const hasDark = (e._curseDur > 0 || e.fearT > 0) && atkEl === 'light';
        if (hasLight || hasDark) {
          const eclipseDmg = Math.min(300, e.maxHp * .15);
          doAoe(e.x, e.y, 200, eclipseDmg, 'light', srcP);
          doShake(18, .7); emitP(e.x, e.y, '#e879f9', 35, 200);
          spawnFT(e.x, e.y - 38, 'üåë ECLIPSE ' + Math.round(eclipseDmg) + '!', '#e879f9', 'bold 16px Rajdhani');
          reacted = true;
        }
      }

      // ‚îÄ‚îÄ VACUUM: wind + darkness on any enemy ‚îÄ‚îÄ
      if (!reacted && atkEl === 'darkness' && e.slowT > 0) {
        // Already handled in water-basis
      }

      if (reacted) { e._reactionCD = .5; emitP(e.x, e.y, '#fff', 6, 40); }
    }
    function hitPl(pl, rawDmg) {
      if (pl.iframes > 0 || pl.invul > 0) return;
      if (pl.dodge > 0 && Math.random() < pl.dodge) { emitP(pl.x, pl.y, '#4fc3f7', 5, 48); return; }
      if (pl.reflectT > 0) { pl.reflectT = 0; emitP(pl.x, pl.y, '#90caf9', 8, 58); return; }
      let dmg = rawDmg * _lvScale * (1 - (pl.dmgReduce || 0));
      if (pl.shield > 0) { pl.shield = Math.max(0, pl.shield - dmg); emitP(pl.x, pl.y, '#42a5f5', 5, 50); return; }
      if (pl.thorns) { const t = nearE(pl.x, pl.y); if (t) hitE(t, pl.thorns, 'earth', null); }
      pl.hp -= dmg; pl.iframes = .5; doShake(7, .22); spawnFT(pl.x, pl.y - 22, '-' + Math.round(dmg), '#f87171');
      if (pl.hp <= 0) { pl.hp = 0; pl.alive = false; }
    }
    function onEDeath(e) {
      // Training dummies: reset HP instead of dying
      if (e._dummy) { e.hp = e.maxHp; e.burnT = 0; e.poisonT = 0; e.stunT = 0; e.slowT = 0; e.slowF = 1; e.fearT = 0; e.blindT = 0; e.frozenT = 0; e._silenceT = 0; e._curseDur = 0; e._healMarkT = 0; spawnFT(e.x, e.y - 22, 'DUMMY RESET', '#4a6375'); emitP(e.x, e.y, '#4a6375', 10, 60); return; }
      emitP(e.x, e.y, EL[e.element].c, 30 + e.r, 165); doShake(12, .55);
      if (e.type === 'guardian') spawnFT(e.x, e.y - 20, 'W√ÑCHTER BESIEGT', '#f4c542');
      if (e.type === 'minion') spawnFT(e.x, e.y - 14, 'x', '#888');
      // ‚îÄ‚îÄ Buff orb drop (30% chance on minion/guardian death) ‚îÄ‚îÄ
      if ((e.type === 'minion' || e.type === 'guardian') && Math.random() < 0.3) {
        const buffTypes = ['rage', 'haste', 'focus', 'vita'];
        const bt = rndFrom(buffTypes);
        const bColors = { rage: '#ef4444', haste: '#3b82f6', focus: '#eab308', vita: '#22c55e' };
        const bEmojis = { rage: 'üî•', haste: '‚ö°', focus: 'üéØ', vita: 'üíö' };
        lootOrbs.push({ x: e.x, y: e.y, r: 7, life: 12, type: bt });
        spawnFT(e.x, e.y - 28, bEmojis[bt], bColors[bt]);
      }
      // asche passive: on-kill explosion
      for (const pl of players) {
        if (!pl.alive) continue;
        if (loadouts[pl.id]?.passive?.pid === 'asche') {
          doAoe(e.x, e.y, 55, 18, 'fire', pl.id, null, { d: 8, dur: 2 });
          emitP(e.x, e.y, '#ff6b1a', 14, 100);
        }
      }
    }

    // ‚îÄ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loop(ts) { if (!running) return; const dt = Math.min((ts - lastT) / 1000, .05); lastT = ts; update(dt); render(); animId = requestAnimationFrame(loop); }

    function update(dt) {
      levelTimer += dt;
      updMove(0, dt); updMove(1, dt);
      // P2 AI auto-attack
      if (loadouts[1]?.ai) {
        p2autoT -= dt;
        if (players[1]?.alive && p2autoT <= 0) {
          const lo = loadouts[1], pl = players[1];
          const sk = lo.activeEl === 'A' ? lo.lmbA : lo.lmbB;
          if (pl.cds.lmb <= 0 && sk) { useLMB(1); p2autoT = sk.cd * cdM(1); } else p2autoT = .28;
          if (pl.cds.q <= 0 && Math.random() < .025) useSlot(1, 'q');
          if (pl.cds.e <= 0 && Math.random() < .02) useSlot(1, 'e');
          if (pl.cds.r <= 0 && loadouts[1].fusion && Math.random() < .006) useFusion(1);
        }
        // P2 IJKL
        if (keys['o'] && players[1]?.alive) { players[1].chargeHeld = true; players[1].chargeT = (players[1].chargeT || 0) + dt; }
        if (!keys['o'] && players[1]?.chargeHeld) releaseCharge(1);
      }
      players.forEach(pl => {
        if (!pl.alive) return;
        // Tick down teamCDR buff
        if (pl.teamCDRBuff && pl.teamCDRBuff.t > 0) { pl.teamCDRBuff.t -= dt; if (pl.teamCDRBuff.t <= 0) pl.teamCDRBuff = null; }
        // ‚îÄ‚îÄ Tick down loot buff timers ‚îÄ‚îÄ
        if (pl._rageBuff > 0) pl._rageBuff -= dt;
        if (pl._hasteBuff > 0) pl._hasteBuff -= dt;
        if (pl._focusBuff > 0) pl._focusBuff -= dt;
        const cdrMult = (pl.teamCDRBuff ? (1 + pl.teamCDRBuff.f) : 1) * (pl._focusBuff > 0 ? 2 : 1);
        for (const k of ['lmb', 'rmb', 'q', 'e', 'r', 'dash']) if (pl.cds[k] > 0) pl.cds[k] = Math.max(0, pl.cds[k] - dt * cdrMult);
        if (pl.chargeHeld) pl.chargeT += dt;
      });
      enemies.forEach(e => { if (e.hp > 0) updEnemy(e, dt); });
      updProjs(dt); updFieldFx(dt); updPillars(dt); updParts(dt); updAmbient(dt); updCrates(dt); updLoot(dt);
      if (shakeT > 0) { shakeT -= dt; shakeX = (Math.random() - .5) * shakeA; shakeY = (Math.random() - .5) * shakeA; } else { shakeX = shakeY = 0; }
      if (ann.t > 0) ann.t -= dt;
      // ‚îÄ Intermittent Hazard Timer ‚îÄ
      if (activeArenaMod && (activeArenaMod.id === 'slippery')) {
        hazardTimer += dt;
        if (hazardActive && hazardTimer >= 6) { hazardActive = false; hazardTimer = 0; }
        else if (!hazardActive && hazardTimer >= 12) { hazardActive = true; hazardTimer = 0; showAnn(activeArenaMod.emoji + ' ' + activeArenaMod.name + ' AKTIV!', 1.5); }
      } else { hazardActive = activeArenaMod != null; }
      for (let i = floats.length - 1; i >= 0; i--) { floats[i].y -= 44 * dt; floats[i].t -= dt; if (floats[i].t <= 0) floats.splice(i, 1); }
      updPhase(dt);
      // ‚îÄ Arena Mod Ticks ‚îÄ
      if (activeArenaMod && gamePhase === 2) {
        arenaTick += dt;
        if (activeArenaMod.id === 'firefields' && arenaTick > 8) {
          arenaTick = 0;
          // Spawn 2-3 telegraphed fire zones at random safe spots
          for (let i = 0; i < 2 + Math.floor(currentLevel * .3); i++) {
            const sp = safePos(55);
            fieldFx.push({ type: 'meter', x: sp.x, y: sp.y, t: 1.2, r: 55, dmg: 0, el: 'fire', burn: { d: 12, dur: 3 }, srcP: null });
            // After meter fires, add lingering zone
            setTimeout(() => { if (running) fieldFx.push({ type: 'zone', x: sp.x, y: sp.y, t: 4, r: 55, el: 'fire', dmg: 10, tick: 0, burn: { d: 10, dur: 2 }, srcP: null }); }, 1250);
          }
        }
        if (activeArenaMod.id === 'shockwave' && arenaTick > 10) {
          arenaTick = 0;
          const cx = PAD + 80 + Math.random() * (GW - PAD * 2 - 160);
          const cy = PAD + 80 + Math.random() * (GH - PAD * 2 - 160);
          fieldFx.push({ type: 'meter', x: cx, y: cy, t: .8, r: 110, dmg: 22, el: 'earth', stun: .7, srcP: null });
          showAnn('üí´ SCHOCKWELLE!', 1.5);
        }
      }
      if (gamePhase === 2 && enemies.filter(e => e.hp > 0 && !e.friendly).length === 0) endLevel();
      if (players.every(p => !p.alive)) endGame(false);
    }

    function updPhase(dt) {
      if (gamePhase === 0) {
        if (enemies.filter(e => e.type === 'guardian').every(e => e.hp <= 0) && enemies.filter(e => e.type === 'guardian').length > 0) {
          gamePhase = 1; phaseCD = 3;
          const lv = LEVELS[currentLevel]; const bd = BOSS_DEFS[lv.boss];
          showAnn(`${bd.emoji} ${bd.name.toUpperCase()} IN 3s!`, 4);
        }
      } else if (gamePhase === 1) { phaseCD -= dt; if (phaseCD <= 0) { gamePhase = 2; spawnBoss(); const bd = BOSS_DEFS[LEVELS[currentLevel].boss]; const ax = activeAffixes.map(a => a.emoji + a.name).join(' ¬∑ '); const mx2 = activeArenaMod ? (' + ' + activeArenaMod.emoji + activeArenaMod.name) : ''; showAnn(`${bd.emoji} ${bd.name}${ax ? ' ‚Äî ' + ax : ''}${mx2}`, 5); } }
    }

    function updMove(p, dt) {
      const pl = players[p]; if (!pl?.alive) return;
      // ‚îÄ Tick dmgBuff ‚îÄ
      if (pl.dmgBuff && pl.dmgBuff.t > 0) { pl.dmgBuff.t -= dt; if (pl.dmgBuff.t <= 0) pl.dmgBuff = null; }
      // ‚îÄ Tick selfDot (√úberhitzung) ‚îÄ
      if (pl.selfDot && pl.selfDot.t > 0) { pl.selfDot.t -= dt; pl.hp -= pl.selfDot.d * dt; if (pl.selfDot.t <= 0) pl.selfDot = null; }
      // ‚îÄ CC: stun blocks everything; immobileT blocks movement but not skills ‚îÄ
      if ((pl.stunT || 0) > 0) { pl.stunT -= dt; return; }
      if ((pl.immobileT || 0) > 0) {
        pl.immobileT -= dt;
        // Still tick iframes/invul/buffs but no movement
        if (pl.iframes > 0) pl.iframes -= dt; if (pl.invul > 0) pl.invul -= dt;
        if (pl.hpRegen) pl.hp = Math.min(pl.maxHp, pl.hp + pl.hpRegen * dt);
        pl.hp = Math.min(pl.maxHp, pl.hp); if (pl.hp <= 0 && pl.alive) { pl.hp = 0; pl.alive = false; }
        return;
      }
      let dx = 0, dy = 0;
      if (p === 0) { if (keys['a'] || keys['ArrowLeft']) dx -= 1; if (keys['d'] || keys['ArrowRight']) dx += 1; if (keys['w'] || keys['ArrowUp']) dy -= 1; if (keys['s'] || keys['ArrowDown']) dy += 1; }
      else if (!loadouts[1]?.ai) { if (keys['j']) dx -= 1; if (keys['l']) dx += 1; if (keys['i']) dy -= 1; if (keys['k']) dy += 1; }
      else {
        const t = nearE(pl.x, pl.y); if (t) { const ddx = t.x - pl.x, ddy = t.y - pl.y, dl = Math.sqrt(ddx * ddx + ddy * ddy) || 1; if (dl > 80) { dx = ddx / dl; dy = ddy / dl; } else if (dl < 40) { dx = -ddx / dl * 0.5; dy = -ddy / dl * 0.5; } }
      }
      if (dx && dy) { dx *= .707; dy *= .707; }
      const mov = !!(dx || dy);
      if (mov) pl.staticT = Math.min((pl.staticT || 0) + dt, 1); else pl.staticT = Math.max(0, (pl.staticT || 0) - dt * .5);
      let spd = pl.spd * (pl.speedBuffT > 0 ? 1.5 : 1) * (pl._hasteBuff > 0 ? 1.35 : 1); if (pl.speedBuffT > 0) pl.speedBuffT -= dt;
      // ‚îÄ v1.4: Enforce 35% minimum speed floor ‚îÄ
      spd = Math.max(pl.spd * 0.35, spd);
      // ‚îÄ Slippery floor mod (only when hazard active) ‚îÄ
      if (activeArenaMod?.id === 'slippery' && hazardActive) {
        const a = 0.92, ta = 1 - a;
        driftVx[p] = driftVx[p] * a + dx * spd * dt * ta * 2.4;
        driftVy[p] = driftVy[p] * a + dy * spd * dt * ta * 2.4;
        const sdx = driftVx[p] * dt, sdy = driftVy[p] * dt;
        const snx = pl.x + sdx, sny = pl.y + sdy;
        if (!pillHit(snx, sny, pl.r)) { pl.x = clamp(snx, PAD + pl.r, GW - PAD - pl.r); pl.y = clamp(sny, PAD + pl.r, GH - PAD - pl.r); }
        else { if (!pillHit(pl.x + sdx, pl.y, pl.r)) pl.x = clamp(pl.x + sdx, PAD + pl.r, GW - PAD - pl.r); if (!pillHit(pl.x, pl.y + sdy, pl.r)) pl.y = clamp(pl.y + sdy, PAD + pl.r, GH - PAD - pl.r); }
      } else {
        const nx = pl.x + dx * spd * dt, ny = pl.y + dy * spd * dt;
        if (!pillHit(nx, ny, pl.r)) { pl.x = clamp(nx, PAD + pl.r, GW - PAD - pl.r); pl.y = clamp(ny, PAD + pl.r, GH - PAD - pl.r); }
        else { const nx2 = pl.x + dx * spd * dt; if (!pillHit(nx2, pl.y, pl.r)) pl.x = clamp(nx2, PAD + pl.r, GW - PAD - pl.r); const ny2 = pl.y + dy * spd * dt; if (!pillHit(pl.x, ny2, pl.r)) pl.y = clamp(ny2, PAD + pl.r, GH - PAD - pl.r); }
      }
      if (pl.iframes > 0) pl.iframes -= dt; if (pl.invul > 0) pl.invul -= dt; if (pl.reflectT > 0) pl.reflectT -= dt;
      if (pl.photoRegen && !mov) pl.hp = Math.min(pl.maxHp, pl.hp + pl.photoRegen * dt);
      if (pl.hpRegen) pl.hp = Math.min(pl.maxHp, pl.hp + pl.hpRegen * dt);
      if (pl.burnT > 0) { pl.burnT -= dt; pl.burnTick -= dt; if (pl.burnTick <= 0) { pl.hp -= pl.burnD || 0; pl.burnTick = .5; emitP(pl.x, pl.y - 8, '#ff6b1a', 3, 28); } }
      if (pl.poisonT > 0) { pl.poisonT -= dt; pl.poisonTick -= dt; if (pl.poisonTick <= 0) { pl.hp -= 5; pl.poisonTick = .4; emitP(pl.x, pl.y - 8, '#4ade80', 2, 24); } }
      pl.hp = Math.min(pl.maxHp, pl.hp); if (pl.hp <= 0 && pl.alive) { pl.hp = 0; pl.alive = false; }
    }

    function updEnemy(e, dt) {
      if (e.frozenT > 0) { e.frozenT -= dt; return; }
      if (e.stunT > 0) { e.stunT -= dt; return; }
      // Tick down silence timer
      if (e._silenceT > 0) e._silenceT -= dt;
      // Tick down heal mark timer
      if (e._healMarkT > 0) e._healMarkT -= dt;
      // Tick down reaction cooldown
      if (e._reactionCD > 0) e._reactionCD -= dt;
      // ‚îÄ Friendly minion lifetime ‚îÄ
      if (e.friendly) {
        e._minionTimer = (e._minionTimer || 10) - dt;
        if (e._minionTimer <= 0 || e.hp <= 0) { const i = enemies.indexOf(e); if (i >= 0) enemies.splice(i, 1); return; }
        return; // friendly minions don't attack or move on their own
      }
      const alive = players.filter(p => p.alive); if (!alive.length) return;
      // ‚îÄ Taunt: check for isTaunt friendly minions within 400px ‚îÄ
      const tauntTargets = enemies.filter(em => em.friendly && em.isTaunt && em.hp > 0 && Math.sqrt((em.x - e.x) ** 2 + (em.y - e.y) ** 2) < 400);
      let tgt;
      if (tauntTargets.length > 0) {
        // Force target the nearest taunt minion
        tgt = tauntTargets.sort((a, b) => (a.x - e.x) ** 2 + (a.y - e.y) ** 2 - (b.x - e.x) ** 2 - (b.y - e.y) ** 2)[0];
      } else {
        tgt = alive.sort((a, b) => (a.x - e.x) ** 2 + (a.y - e.y) ** 2 - (b.x - e.x) ** 2 - (b.y - e.y) ** 2)[0];
      }
      const isFear = (e.fearT || 0) > 0; if (isFear) e.fearT -= dt;
      // Speed from type/phase
      const phIdx = e.type === 'boss' ? getBossPhase() : 0;
      const bd = e.bossData;
      let spd = e.type === 'boss' ? (bd?.phases[phIdx]?.spd || e.spd) : e.type === 'minion' ? 148 : e.spd;
      spd *= (e.slowT > 0 ? e.slowF : 1);
      if ((e.blindT || 0) > 0) { e.blindT -= dt; spd *= .4; }
      // ‚îÄ‚îÄ‚îÄ BOSS CHARGE ‚îÄ‚îÄ‚îÄ
      if (e.type === 'boss') {
        // Rasend affix: speed already boosted, also more frequent specials
        const rasendMult = e._rasend ? 1.4 : 1;
        e.chargeCD -= dt * rasendMult;
        if (!e.charging && e.chargeCD <= 0 && phIdx >= 1) {
          e.charging = true; const dl = Math.sqrt((tgt.x - e.x) ** 2 + (tgt.y - e.y) ** 2) || 1;
          e.chargeDx = (tgt.x - e.x) / dl; e.chargeDy = (tgt.y - e.y) / dl;
          e.chargeRemain = .52; e.chargeCD = (bd?.phases[phIdx]?.chargeCD || 7);
          emitP(e.x, e.y, EL[e.element].c, 15, 120, e.chargeDx, e.chargeDy);
          spawnFT(e.x, e.y - 62, '‚ö° CHARGE!', EL[e.element].c);
        }
        if (e.charging) {
          const cx = e.x + e.chargeDx * 520 * dt, cy = e.y + e.chargeDy * 520 * dt;
          if (!pillHit(cx, cy, e.r)) { e.x = clamp(cx, PAD + e.r, GW - PAD - e.r); e.y = clamp(cy, PAD + e.r, GH - PAD - e.r); }
          else { e.charging = false; doShake(6, .2); }
          e.chargeRemain -= dt; if (e.chargeRemain <= 0) { e.charging = false; doShake(8, .3); emitP(e.x, e.y, EL[e.element].c, 18, 100); }
          players.forEach(pl => { if (!pl.alive || pl.iframes > 0) return; if (Math.sqrt((pl.x - e.x) ** 2 + (pl.y - e.y) ** 2) < pl.r + e.r + 4) hitPl(pl, 28); });
        }
        // ‚îÄ‚îÄ‚îÄ BOSS SPECIAL ATTACKS ‚îÄ‚îÄ‚îÄ
        e.specialCD -= dt * rasendMult;
        if (e.specialCD <= 0 && !e.charging && !(e._reflektT > 0) && !(e._silenceT > 0)) {
          e.specialCD = (e._rasend ? 4 : 5.5) + Math.random() * 3;
          let atks = bd?.specialAtks || [];
          let atk = atks[e.specialIdx % atks.length]; e.specialIdx++;
          // ‚îÄ‚îÄ‚îÄ AVATAR SYSTEM: use sub-element attacks in later phases ‚îÄ‚îÄ‚îÄ
          let useEl = e.element;
          if (phIdx >= 2 && e._subEl2 && Math.random() < 0.25) {
            const subBd = BOSS_DEFS[e._subEl2];
            if (subBd?.specialAtks?.length) {
              atk = rndFrom(subBd.specialAtks); useEl = e._subEl2;
            }
          } else if (phIdx >= 1 && e._subEl1 && Math.random() < 0.30) {
            const subBd = BOSS_DEFS[e._subEl1];
            if (subBd?.specialAtks?.length) {
              atk = rndFrom(subBd.specialAtks); useEl = e._subEl1;
            }
          }
          // Temporarily swap element for correct colors in the attack
          const origEl = e.element;
          e.element = useEl;
          doBossSpecial(e, tgt, atk, phIdx);
          e.element = origEl;
        }
        // ‚îÄ‚îÄ‚îÄ REFLEKTOR AFFIX ‚îÄ‚îÄ‚îÄ
        if (e._reflektor) {
          e._reflektCD -= dt; e._reflektT = Math.max(0, (e._reflektT || 0) - dt);
          if (e._reflektCD <= 0 && e._reflektT <= 0) {
            e._reflektCD = 20; e._reflektT = 4;
            showAnn('üõ° REFLEKTOR AKTIV ‚Äî 4s!', 3);
            emitP(e.x, e.y, '#42a5f5', 30, 160);
            spawnFT(e.x, e.y - 70, 'SCHILD', EL[e.element].c);
          }
        }
        // ‚îÄ‚îÄ‚îÄ SPLITTER AFFIX ‚îÄ‚îÄ‚îÄ
        if (e._splitter) {
          e._splitterCD -= dt;
          if (e._splitterCD <= 0) { e._splitterCD = 10; bossSpawnMinions(e, 2 + phIdx); }
        }
        // ‚îÄ‚îÄ‚îÄ PHASE ORB RING (P3) ‚îÄ‚îÄ‚îÄ
        if (phIdx === 2) { e.orbRingCD -= dt; if (e.orbRingCD <= 0) { e.orbRingCD = 4.5; spawnOrbRing(e, tgt); } }
        // ‚îÄ‚îÄ‚îÄ MINION SPAWNS ‚îÄ‚îÄ‚îÄ
        if (e.mSpawns && e.mSpawns.length > 0) {
          for (let i = e.mSpawns.length - 1; i >= 0; i--) {
            if (e.hp < e.mSpawns[i]) { e.mSpawns.splice(i, 1); bossSpawnMinions(e, phIdx + 2); }
          }
        }
        e.minionCD -= dt;
        if (phIdx === 2 && e.minionCD <= 0) { e.minionCD = 14; bossSpawnMinions(e, 2); }
        // ‚îÄ‚îÄ‚îÄ PHASE TRANSITIONS ‚îÄ‚îÄ‚îÄ
        const prevPhase = e.phase; e.phase = phIdx;
        if (phIdx !== prevPhase) {
          doShake(24, .95); emitP(e.x, e.y, '#fff', 55, 230);
          e._healUses = 0; // reset nature boss heal counter
          // Avatar system announcement
          let pName = 'Phase 1';
          if (phIdx === 1) {
            pName = `Phase 2 ‚Äî +${EL[e._subEl1]?.e || ''} ${EL[e._subEl1]?.n || ''}!`;
          } else if (phIdx === 2) {
            pName = `Phase 3 ‚Äî ENRAGE! +${EL[e._subEl2]?.e || ''} ${EL[e._subEl2]?.n || ''}!`;
          }
          showAnn(`üíÄ ${bd?.name || 'BOSS'} ‚Äî ${pName}`, 4);
        }
        // ‚îÄ‚îÄ‚îÄ ANTI-STUCK ‚îÄ‚îÄ‚îÄ
        e._stuckTimer = (e._stuckTimer || 0) + dt;
        if (e._stuckTimer >= 2) {
          const dx2 = e.x - (e._stuckCheckX || e.x), dy2 = e.y - (e._stuckCheckY || e.y);
          const moved = Math.sqrt(dx2 * dx2 + dy2 * dy2);
          e._stuckCheckX = e.x; e._stuckCheckY = e.y; e._stuckTimer = 0;
          // Only teleport if boss is far from all players (>200px)
          const alivePlayers = players.filter(p => p.alive);
          const nearestDist = alivePlayers.length > 0 ? Math.min(...alivePlayers.map(p => Math.sqrt((p.x - e.x) ** 2 + (p.y - e.y) ** 2))) : 0;
          if (moved < 20 && !e.stunT && !e.frozenT && nearestDist > 200) {
            const np = safePos(e.r + 8);
            emitP(e.x, e.y, EL[e.element].c, 30, 180);
            e.x = np.x; e.y = np.y;
            emitP(e.x, e.y, EL[e.element].c, 30, 180);
            spawnFT(e.x, e.y - 68, '‚ö° REPOSITION', EL[e.element].c);
          }
        }
      }
      // ‚îÄ‚îÄ‚îÄ MOVEMENT (with pillar avoidance) ‚îÄ‚îÄ‚îÄ
      if (!e.charging) {
        let tdx = isFear ? (e.x - tgt.x) : (tgt.x - e.x), tdy = isFear ? (e.y - tgt.y) : (tgt.y - e.y);
        const dist = Math.sqrt(tdx * tdx + tdy * tdy) || 1;
        let sx = 0, sy = 0;
        for (const pl of pillars) { const cx = pl.x + pl.w / 2, cy = pl.y + pl.h / 2, dx = e.x - cx, dy = e.y - cy, d = Math.sqrt(dx * dx + dy * dy) || 1, minD = e.r + Math.max(pl.w, pl.h) * .6 + 18; if (d < minD) { sx += dx / d * (minD - d); sy += dy / d * (minD - d); } }
        // Wander offset to prevent getting stuck
        const wander = e.type === 'boss' ? 0.18 : 0.06;
        const ws = e._wseed || 0;
        const wx = (Math.sin(Date.now() * .0008 + ws) * wander);
        const wy = (Math.cos(Date.now() * .0011 + ws) * wander);
        const mvx = (tdx / dist) * spd * dt + sx * .22 + wx * spd * dt;
        const mvy = (tdy / dist) * spd * dt + sy * .22 + wy * spd * dt;
        const nx = e.x + mvx, ny = e.y + mvy;
        if (!pillHit(nx, ny, e.r)) { e.x = clamp(nx, PAD + e.r, GW - PAD - e.r); e.y = clamp(ny, PAD + e.r, GH - PAD - e.r); }
        else { const nx2 = e.x + mvx; if (!pillHit(nx2, e.y, e.r)) e.x = clamp(nx2, PAD + e.r, GW - PAD - e.r); const ny2 = e.y + mvy; if (!pillHit(e.x, ny2, e.r)) e.y = clamp(ny2, PAD + e.r, GH - PAD - e.r); }
      }
      // ‚îÄ‚îÄ‚îÄ NORMAL ATTACK ‚îÄ‚îÄ‚îÄ
      e.atkT -= dt;
      if (e.atkT <= 0 && !(e.blindT > 0) && !(e._silenceT > 0)) {
        const phIdx2 = e.type === 'boss' ? getBossPhase() : 0;
        const bd2 = e.bossData;
        e.atkT = e.type === 'boss' ? (phIdx2 === 0 ? 2.4 : phIdx2 === 1 ? 1.7 : 1.1) : e.type === 'minion' ? 1.5 : 2.8;
        eAtk(e, tgt, phIdx2);
      }
      if (e.slowT > 0) e.slowT -= dt;
      if (e._curseDur > 0) e._curseDur -= dt; else e._curseDR = 0;
      if (e.burnT > 0) { e.burnT -= dt; e.burnTick -= dt; if (e.burnTick <= 0) { e.hp -= e.burnD || 0; e.burnTick = .5; emitP(e.x + (Math.random() - .5) * 30, e.y + (Math.random() - .5) * 20, '#ff6b1a', 2, 34); if (e.hp <= 0) onEDeath(e); } }
      if (e.poisonT > 0) { e.poisonT -= dt; e.poisonTick -= dt; if (e.poisonTick <= 0) { e.hp -= 9; e.poisonTick = .35; if (e.hp <= 0) onEDeath(e); } }
      if (e.hitFlash > 0) e.hitFlash -= dt;
      e.angle += dt * (e.type === 'boss' ? getBossPhase() === 2 ? 3.2 : 1.8 : e.type === 'minion' ? 4 : 1.5);
      // Contact damage: hit players AND friendly taunt minions
      players.forEach(pl => { if (!pl.alive || pl.iframes > 0) return; if (Math.sqrt((pl.x - e.x) ** 2 + (pl.y - e.y) ** 2) < pl.r + e.r) hitPl(pl, e.type === 'minion' ? 11 : 19); });
      enemies.forEach(em => {
        if (!em.friendly || !em.isTaunt || em.hp <= 0) return;
        if (Math.sqrt((em.x - e.x) ** 2 + (em.y - e.y) ** 2) < em.r + e.r) {
          em.hp -= (e.type === 'minion' ? 8 : 14);
          if (em.hp <= 0) { const ei = enemies.indexOf(em); if (ei >= 0) enemies.splice(ei, 1); }
          emitP(em.x, em.y, '#4ade80', 4, 45);
        }
      });
    }

    // ‚îÄ‚îÄ‚îÄ BOSS SPECIAL ATTACKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function doBossSpecial(e, tgt, atk, phase) {
      const el = e.element, E = EL[el];
      if (!atk) return;
      switch (atk) {
        // FIRE BOSS
        case 'fireBreath':
          for (let i = 0; i < 8; i++) { const a = Math.atan2(tgt.y - e.y, tgt.x - e.x) + (i - 3.5) * .22; spP({ x: e.x, y: e.y, vx: Math.cos(a) * 340, vy: Math.sin(a) * 340, r: 10, color: '#ff6b1a', glow: '#ff4500', dmg: 16, team: 'e', el, burn: { d: 12, dur: 3 } }); }
          break;
        case 'meteors':
          for (let i = 0; i < 3 + phase; i++) { const mx2 = tgt.x + (Math.random() - .5) * 180, my2 = tgt.y + (Math.random() - .5) * 180; fieldFx.push({ type: 'meter', x: mx2, y: my2, t: .9, r: 55, dmg: 55, el, burn: { d: 15, dur: 3 }, srcP: null }); }
          break;
        case 'firePillar':
          fieldFx.push({ type: 'zone', x: tgt.x, y: tgt.y, t: 4, r: 50, el, dmg: 20, tick: 0, burn: { d: 12, dur: 2 }, srcP: null });
          break;
        case 'flameRing':
          for (let i = 0; i < 12; i++) { const a = (i / 12) * Math.PI * 2; spP({ x: e.x, y: e.y, vx: Math.cos(a) * 240, vy: Math.sin(a) * 240, r: 8, color: '#ff6b1a', glow: '#ff4500', dmg: 14, team: 'e', el, burn: { d: 8, dur: 2 } }); }
          break;
        // WATER BOSS
        case 'tidalWave':
          for (let i = 0; i < 6; i++) { const a = Math.atan2(tgt.y - e.y, tgt.x - e.x) + (i - 2.5) * .18; spP({ x: e.x, y: e.y, vx: Math.cos(a) * 310, vy: Math.sin(a) * 310, r: 16, color: '#42a5f5', glow: '#1e88e5', dmg: 22, team: 'e', el, slow: { f: .4, dur: 2 } }); }
          break;
        case 'waterPrison':
          fieldFx.push({ type: 'zone', x: tgt.x, y: tgt.y, t: 3.5, r: 65, el, dmg: 14, tick: 0, slow: { f: .7 }, srcP: null });
          break;
        case 'healSelf':
          if (e.hp < e.maxHp * .7) { e.hp = Math.min(e.maxHp, e.hp + e.maxHp * .08); spawnFT(e.x, e.y - 60, '+' + Math.round(e.maxHp * .08) + ' HEAL', '#42a5f5'); }
          break;
        case 'vortex':
          players.forEach(pl => { if (!pl.alive) return; const dx = e.x - pl.x, dy = e.y - pl.y, dl = Math.sqrt(dx * dx + dy * dy) || 1; pl.x = clamp(pl.x + dx / dl * 90, PAD + pl.r, GW - PAD - pl.r); pl.y = clamp(pl.y + dy / dl * 90, PAD + pl.r, GH - PAD - pl.r); hitPl(pl, 16); });
          break;
        // EARTH BOSS
        case 'groundSlam':
          doAoe(e.x, e.y, 140, 45, el, null, 2, null, 120); doShake(16, .6);
          for (let i = 0; i < 8; i++) { const a = (i / 8) * Math.PI * 2; fieldFx.push({ type: 'meter', x: e.x + Math.cos(a) * 100, y: e.y + Math.sin(a) * 100, t: .6, r: 30, dmg: 35, el, stun: .8, srcP: null }); }
          break;
        case 'rockSpikes':
          for (let i = 0; i < 5 + phase; i++) { const a = Math.atan2(tgt.y - e.y, tgt.x - e.x) + (i - 2) * .3; spP({ x: e.x, y: e.y, vx: Math.cos(a) * 280, vy: Math.sin(a) * 280, r: 13, color: '#a3a86e', glow: '#8d9234', dmg: 28, team: 'e', el, stun: .6 }); }
          break;
        case 'stoneWalls':
          for (let i = 0; i < 2; i++) { const angle = Math.random() * Math.PI; pillars.push({ x: tgt.x + Math.cos(angle) * 30 - 8, y: tgt.y + Math.sin(angle) * 30 - 50, w: 16, h: 100, hp: 150, maxHp: 150, el, temp: true, life: 8 }); }
          break;
        case 'quakeShockwave':
          emitP(e.x, e.y, '#a3a86e', 40, 200); doShake(20, .8);
          players.forEach(pl => { if (!pl.alive) return; const dx = pl.x - e.x, dy = pl.y - e.y, dl = Math.sqrt(dx * dx + dy * dy) || 1; pl.x = clamp(pl.x + dx / dl * 160, PAD + pl.r, GW - PAD - pl.r); pl.y = clamp(pl.y + dy / dl * 160, PAD + pl.r, GH - PAD - pl.r); hitPl(pl, 22); });
          break;
        // WIND BOSS
        case 'windBarrage':
          for (let i = 0; i < 10 + phase * 3; i++) { const a = (i / (10 + phase * 3)) * Math.PI * 2; spP({ x: e.x, y: e.y, vx: Math.cos(a) * 400, vy: Math.sin(a) * 400, r: 7, color: '#4fc3f7', glow: '#29b6f6', dmg: 12, team: 'e', el, pierce: true }); }
          break;
        case 'tornadoSpin':
          fieldFx.push({ type: 'tornado', x: e.x, y: e.y, t: 4, r: 85, el, dmg: 12, vx: (Math.random() - .5) * 60, vy: (Math.random() - .5) * 60, angle: 0, tick: 0, srcP: null });
          break;
        case 'vacuum':
          players.forEach(pl => { if (!pl.alive) return; const dx = e.x - pl.x, dy = e.y - pl.y, dl = Math.sqrt(dx * dx + dy * dy) || 1; pl.x = clamp(pl.x + dx / dl * 130, PAD + pl.r, GW - PAD - pl.r); pl.y = clamp(pl.y + dy / dl * 130, PAD + pl.r, GH - PAD - pl.r); });
          break;
        case 'airBurst':
          doAoe(tgt.x, tgt.y, 90, 35, el, null, null, null, 200); fieldFx.push({ type: 'meter', x: tgt.x, y: tgt.y, t: .5, r: 80, dmg: 40, el, srcP: null });
          break;
        // NATURE BOSS
        case 'rootCage':
          players.forEach(pl => {
            if (!pl.alive) return;
            fieldFx.push({ type: 'meter', x: pl.x, y: pl.y, t: .8, r: 55, dmg: 15, el, stun: 2.5, srcP: null });
            spawnFT(pl.x, pl.y - 28, '‚ö† WURZEL!', '#4ade80');
          }); break;
        case 'sporeBurst':
          for (let i = 0; i < 12; i++) { const a = (i / 12) * Math.PI * 2; spP({ x: e.x + Math.cos(a) * e.r, y: e.y + Math.sin(a) * e.r, vx: Math.cos(a) * 200, vy: Math.sin(a) * 200, r: 9, color: '#4ade80', glow: '#16a34a', dmg: 14, team: 'e', el, poison: { d: 8, dur: 4 } }); }
          break;
        case 'natureSeal':
          players.forEach(pl => { if (!pl.alive) return; pl.cds.r = Math.max(pl.cds.r, 8); spawnFT(pl.x, pl.y - 28, 'FUSION GESPERRT 8s', '#4ade80'); });
          break;
        case 'healing':
          e._healUses = (e._healUses || 0) + 1;
          if (e._healUses > 3) { spawnFT(e.x, e.y - 60, 'HEILKRAFT ERSCH√ñPFT', '#666'); break; }
          e.hp = Math.min(e.maxHp, e.hp + e.maxHp * .06); spawnFT(e.x, e.y - 60, '+NATUR-HEILUNG', '#4ade80'); emitP(e.x, e.y, '#4ade80', 20, 80);
          break;
        // LIGHT BOSS
        case 'solarFlare':
          doAoe(e.x, e.y, 180, 38, el, null, null, null, null, null, 3.5); doShake(12, .5);
          break;
        case 'blindPulse':
          for (let i = 0; i < 12; i++) { const a = (i / 12) * Math.PI * 2; spP({ x: e.x, y: e.y, vx: Math.cos(a) * 320, vy: Math.sin(a) * 320, r: 10, color: '#fde68a', glow: '#f59e0b', dmg: 15, team: 'e', el, blind: 1.8 }); }
          showAnn('‚òÄ LICHTPULS ‚Äî AUSWEICHEN!', 1.5); break;
        case 'holyBeam': { const a = Math.atan2(tgt.y - e.y, tgt.x - e.x); for (let i = 0; i < 3; i++)setTimeout(() => { if (!running) return; spP({ x: e.x, y: e.y, vx: Math.cos(a) * 600, vy: Math.sin(a) * 600, r: 12, color: '#fde68a', glow: '#f59e0b', dmg: 28, team: 'e', el, pierce: true, blind: 1.5 }); }, i * 180); break; }
        case 'reviveMinions':
          const dead = enemies.filter(en => en.type === 'minion' && en.hp <= 0);
          dead.slice(0, 2).forEach(m => { m.hp = m.maxHp * .5; emitP(m.x, m.y, '#fde68a', 12, 68); });
          if (dead.length === 0) bossSpawnMinions(e, 1);
          break;
        // DARKNESS BOSS
        case 'shadowBeam': { const bx = e.x, by = e.y, a2 = Math.atan2(tgt.y - by, tgt.x - bx); for (let i = 0; i < 4; i++)setTimeout(() => { if (!running) return; spP({ x: bx, y: by, vx: Math.cos(a2 + (i - .5) * .12) * 520, vy: Math.sin(a2 + (i - .5) * .12) * 520, r: 10, color: '#a855f7', glow: '#7e22ce', dmg: 24, team: 'e', el, throughWalls: true }); }, i * 80); break; }
        case 'fearShout':
          showAnn('üëÅ ANGST-SCHREI ‚Äî AUSWEICHEN!', 1.5);
          for (let i = 0; i < 10; i++) { const a = (i / 10) * Math.PI * 2; spP({ x: e.x, y: e.y, vx: Math.cos(a) * 260, vy: Math.sin(a) * 260, r: 12, color: '#a855f7', glow: '#7e22ce', dmg: 18, team: 'e', el, stun: 2.2 }); }
          doShake(10, .4); break;
        case 'voidPortal':
          for (let i = 0; i < 6; i++) { const a = (i / 6) * Math.PI * 2, ox = GW / 2 + Math.cos(a) * 200, oy = GH / 2 + Math.sin(a) * 180; spP({ x: ox, y: oy, vx: (tgt.x - ox) / 2.8, vy: (tgt.y - oy) / 2.8, r: 10, color: '#a855f7', glow: '#7e22ce', dmg: 18, team: 'e', el, throughWalls: true }); }
          break;
        case 'lifeSteal':
          players.forEach(pl => { if (!pl.alive) return; const dmg = Math.min(pl.hp * .14, 25); pl.hp -= dmg; if (pl.hp <= 0) pl.alive = false; e.hp = Math.min(e.maxHp, e.hp + dmg * 2); spawnFT(e.x, e.y - 55, '+LIFESTEAL', '#a855f7'); });
          break;
      }
    }

    function bossSpawnMinions(boss, count) {
      showAnn('‚ö† VERST√ÑRKUNG!', 2); doShake(16, .6);
      for (let j = 0; j < count; j++) { const a = (j / count) * Math.PI * 2; spawnMinion(boss.x + Math.cos(a) * 95, boss.y + Math.sin(a) * 95); }
    }

    // ‚îÄ‚îÄ‚îÄ ENEMY NORMAL ATTACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function eAtk(e, tgt, phIdx) {
      const dx = tgt.x - e.x, dy = tgt.y - e.y, l = Math.sqrt(dx * dx + dy * dy) || 1;
      const bd = e.bossData;
      const pattern = bd?.phases[phIdx]?.atkPattern || 'spread3';
      // ‚îÄ‚îÄ Avatar system: chance to use sub-element for normal attacks ‚îÄ‚îÄ
      let atkEl = e.element;
      if (e.type === 'boss') {
        if (phIdx >= 2 && e._subEl2 && Math.random() < 0.15) atkEl = e._subEl2;
        else if (phIdx >= 1 && e._subEl1 && Math.random() < 0.25) atkEl = e._subEl1;
      }
      const col = EL[atkEl].c, glow = EL[atkEl].g;
      let cnt = 1, spr = 0, spd2 = 270, dmg = 16, extraBurn = null, extraPoison = null, extraSlow = null;
      if (e.type === 'boss') {
        // Parse pattern string
        if (pattern.includes('spread')) cnt = parseInt(pattern.match(/spread(\d+)/)?.[1] || '3');
        if (pattern.includes('fast')) cnt = parseInt(pattern.match(/fast(\d+)/)?.[1] || '5');
        if (pattern.includes('laser')) cnt = parseInt(pattern.match(/laser(\d+)/)?.[1] || '3');
        if (pattern.includes('poison')) cnt = parseInt(pattern.match(/poison(\d+)/)?.[1] || '3');
        if (pattern.includes('shadow')) cnt = parseInt(pattern.match(/shadow(\d+)/)?.[1] || '3');
        if (pattern.includes('homing')) cnt = parseInt(pattern.match(/homing(\d+)/)?.[1] || '3');
        if (pattern.includes('boulder')) cnt = 3;
        spr = cnt > 1 ? .28 : 0; spd2 = e.element === 'wind' ? 420 : e.element === 'light' ? 480 : 275;
        dmg = phIdx === 0 ? 19 : phIdx === 1 ? 16 : 13;
        if (e.element === 'fire') extraBurn = { d: 8, dur: 2 };
        if (e.element === 'nature') extraPoison = { d: 6, dur: 3 };
        if (e.element === 'water') extraSlow = { f: .3, dur: 2 };
      } else if (e.type === 'minion') { cnt = 1; spd2 = 295; dmg = 12; }
      for (let i = 0; i < cnt; i++) {
        const a = Math.atan2(dy, dx) + (cnt > 1 ? (i - (cnt - 1) / 2) * spr : 0);
        spP({ x: e.x, y: e.y, vx: Math.cos(a) * spd2, vy: Math.sin(a) * spd2, r: cnt > 4 ? 7 : 9, color: col, glow, dmg, team: 'e', el: atkEl, burn: extraBurn, poison: extraPoison, slow: extraSlow, homing: pattern.includes('homing') && i < 2 });
      }
      // Extra patterns
      if (pattern.includes('fire') && e.type === 'boss') { for (let i = 0; i < 4; i++) { const a2 = (i / 4) * Math.PI * 2; spP({ x: e.x, y: e.y, vx: Math.cos(a2) * 200, vy: Math.sin(a2) * 200, r: 8, color: col, glow, dmg: 11, team: 'e', el: atkEl, burn: { d: 10, dur: 2 } }); } }
      if (pattern.includes('wave') && e.type === 'boss') { for (let i = 0; i < 8; i++) { const a2 = Math.atan2(dy, dx) + (i - 3.5) * .2; spP({ x: e.x, y: e.y, vx: Math.cos(a2) * 320, vy: Math.sin(a2) * 320, r: 14, color: col, glow, dmg: 18, team: 'e', el: atkEl, slow: { f: .4, dur: 2 } }); } }
      if (pattern.includes('roots')) { players.forEach(pl => { if (!pl.alive) return; if (Math.sqrt((pl.x - e.x) ** 2 + (pl.y - e.y) ** 2) < 200) pl.stunT = Math.max(pl.stunT || 0, .8); }); }
      if (pattern.includes('meteor')) { const mx2 = tgt.x + (Math.random() - .5) * 120, my2 = tgt.y + (Math.random() - .5) * 120; fieldFx.push({ type: 'meter', x: mx2, y: my2, t: 1.1, r: 50, dmg: 55, el: atkEl, burn: extraBurn, srcP: null }); }
      if (pattern.includes('blind')) { players.forEach(pl => { if (pl.alive && Math.random() < .35) pl.stunT = Math.max(pl.stunT || 0, 1.2); }); }
      if (pattern.includes('fear')) { if (Math.random() < .25) players.forEach(pl => { if (pl.alive) pl.stunT = Math.max(pl.stunT || 0, 1.5); }); }
      if (pattern.includes('drain')) { players.forEach(pl => { if (!pl.alive) return; const d2 = Math.min(8, pl.hp * .06); pl.hp -= d2; e.hp = Math.min(e.maxHp, e.hp + d2 * 1.5); }); }
      if (pattern.includes('curse')) { if (Math.random() < .2) players.forEach(pl => { if (pl.alive) { pl.burnT = 3; pl.burnD = 8; pl.burnTick = .5; spawnFT(pl.x, pl.y - 20, 'FLUCH', '#a855f7'); } }); }
      if (pattern.includes('portal')) { for (let i = 0; i < 3; i++) { const ox = PAD + 80 + Math.random() * (GW - PAD * 2 - 160), oy = PAD + 80 + Math.random() * (GH - PAD * 2 - 160); spP({ x: ox, y: oy, vx: (tgt.x - ox) / 3, vy: (tgt.y - oy) / 3, r: 9, color: '#a855f7', glow: '#7e22ce', dmg: 16, team: 'e', el: atkEl, throughWalls: true }); } }
      if (pattern.includes('ring') && e.type === 'boss') { spawnOrbRing(e, tgt); }
      if (pattern.includes('tidal')) { for (let i = 0; i < 3; i++)setTimeout(() => { if (!running || e.hp <= 0) return; for (let j = 0; j < 6; j++) { const a2 = (j / 6) * Math.PI * 2; spP({ x: e.x, y: e.y, vx: Math.cos(a2) * 350, vy: Math.sin(a2) * 350, r: 10, color: '#42a5f5', glow: '#1e88e5', dmg: 16, team: 'e', el: atkEl }); } }, i * 400); }
      if (pattern.includes('fullBlast')) { for (let i = 0; i < 16; i++) { const a2 = (i / 16) * Math.PI * 2; spP({ x: e.x, y: e.y, vx: Math.cos(a2) * 320, vy: Math.sin(a2) * 320, r: 9, color: '#fde68a', glow: '#f59e0b', dmg: 20, team: 'e', el: atkEl, pierce: true }); } }
      if (pattern.includes('heal')) { e.hp = Math.min(e.maxHp, e.hp + e.maxHp * .04); }
    }

    function spawnOrbRing(e, tgt) {
      for (let i = 0; i < 5; i++) { const a = (i / 5) * Math.PI * 2 + e.angle; const ox = e.x + Math.cos(a) * 115, oy = e.y + Math.sin(a) * 115; spP({ x: ox, y: oy, vx: (tgt.x - ox) / 2.8, vy: (tgt.y - oy) / 2.8, r: 9, color: EL[e.element].c, glow: EL[e.element].g, dmg: 14, team: 'e', el: e.element, life: 3.5 }); }
    }

    // ‚îÄ‚îÄ‚îÄ PROJECTILES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updProjs(dt) {
      for (let i = projs.length - 1; i >= 0; i--) {
        const p = projs[i];
        if (p.homing && p.team === 'e') { const t = players.filter(pl => pl.alive)[0]; if (t) { const ddx = t.x - p.x, ddy = t.y - p.y, dl = Math.sqrt(ddx * ddx + ddy * ddy) || 1; p.vx += (ddx / dl * 3.5 - p.vx * .06) * dt * 55; p.vy += (ddy / dl * 3.5 - p.vy * .06) * dt * 55; } }
        if (p.homing && p.team === 'p') { const t = nearE(p.x, p.y); if (t) { const ddx = t.x - p.x, ddy = t.y - p.y, dl = Math.sqrt(ddx * ddx + ddy * ddy) || 1; p.vx += (ddx / dl * 3 - p.vx * .06) * dt * 58; p.vy += (ddy / dl * 3 - p.vy * .06) * dt * 58; } }
        // Arc (grenade) physics: gravity pulls projectile down
        if (p._arc) p.vy += 420 * dt;
        // Boomerang: after half-life, reverse velocity toward origin
        if (p._boomerang && !p._reversed && p.life < p._maxLife * .5) { p._reversed = true; p.vx = -p.vx * .85; p.vy = -p.vy * .85; }
        p.x += p.vx * dt; p.y += p.vy * dt; p.life -= dt;
        // rangeMult: distance-based damage scaling (Schatten-Bolzen)
        if (p._rangeMult && p._originX !== undefined) {
          const dist2 = Math.sqrt((p.x - p._originX) ** 2 + (p.y - p._originY) ** 2);
          p.dmg = p._baseDmg * (1 + (p._rangeMult - 1) * Math.min(1, dist2 / 400));
        }
        // pulseAoe: periodic AoE damage while flying (Licht-Orb)
        if (p._pulseAoe && p.team === 'p') {
          p._pulseTick = (p._pulseTick || 0) - dt;
          if (p._pulseTick <= 0) { p._pulseTick = .3; doAoe(p.x, p.y, p._pulseAoe, p.dmg * .25, p.el, p.srcP); emitP(p.x, p.y, p.color, 3, 30); }
        }
        if (p.life <= 0 || p.x < -80 || p.x > GW + 80 || p.y < -80 || p.y > GH + 80) { projs.splice(i, 1); continue; }
        // Wind Wall: delete enemy projectiles that pass through
        if (p.team === 'e') { let wBlocked = false; for (const ww of fieldFx) { if (ww.type !== 'windwall') continue; if (p.x > ww.x && p.x < ww.x + ww.w && p.y > ww.y && p.y < ww.y + ww.h) { projs.splice(i, 1); emitP(p.x, p.y, '#4fc3f7', 5, 45); wBlocked = true; break; } } if (wBlocked) continue; }
        if (!p.throughWalls) {
          let blk = false;
          for (const pl2 of pillars) {
            if (p.x > pl2.x - p.r && p.x < pl2.x + pl2.w + p.r && p.y > pl2.y - p.r && p.y < pl2.y + pl2.h + p.r) {
              if (p.bounce && !p._bounced) { p.vx *= -.85; p.vy *= -.85; p._bounced = true; }
              else { if (pl2.temp && pl2.hp !== undefined) { pl2.hp -= (p.dmg || 20); if (pl2.hp <= 0) { const pi = pillars.indexOf(pl2); if (pi >= 0) pillars.splice(pi, 1); } } projs.splice(i, 1); blk = true; }
              break;
            }
          }
          if (blk) continue;
        }
        // Projectile ‚Üí Crate collision (player projectiles only)
        if (p.team === 'p') {
          let crateHit = false;
          for (const cr of crates) {
            if (p.x > cr.x - p.r && p.x < cr.x + cr.w + p.r && p.y > cr.y - p.r && p.y < cr.y + cr.h + p.r) {
              cr.hp -= p.dmg || 15;
              emitP(p.x, p.y, '#a16207', 4, 40);
              if (!p.pierce) { projs.splice(i, 1); crateHit = true; }
              break;
            }
          }
          if (crateHit) continue;
        }
        if (p.team === 'p') {
          let hit = false;
          for (const e of enemies) {
            if (e.hp <= 0 || e.friendly) continue; // skip friendly minions
            if (Math.sqrt((p.x - e.x) ** 2 + (p.y - e.y) ** 2) < e.r + p.r) {
              // Reflektor affix: reflect proj back
              if (e._reflektT > 0 && !p.isFusion) {
                p.team = 'e'; p.vx = -p.vx; p.vy = -p.vy; p.srcP = null;
                emitP(p.x, p.y, '#42a5f5', 8, 60);
                hit = false; break;
              }
              // Banish projectile
              if (p._banishDur) {
                e.stunT = Math.max(e.stunT || 0, p._banishDur);
                e.invul = (e.invul || 0) + p._banishDur;
                hitE(e, p.dmg || 25, p.el, p.srcP);
                spawnFT(e.x, e.y - 28, 'BANISH ' + p._banishDur + 's', '#a855f7');
                projs.splice(i, 1); hit = true; break;
              }
              if (p.isFusion) onFusionHit(p, e); else hitE(e, p.dmg, p.el, p.srcP, p.burn, p.poison, p.slow, null, p.stun, p.healHit);
              if (p.fear && e.hp > 0) e.fearT = Math.max(e.fearT || 0, p.fear);
              if (p.aoe) doAoe(p.x, p.y, p.aoe, p.dmg * .6, p.el, p.srcP, null, p.burn);
              // Bomb: stick to enemy, explode after delay
              if (p._bomb && e.hp > 0) { const bm = p._bomb; setTimeout(() => { if (!running || e.hp <= 0) return; doAoe(e.x, e.y, bm.r || 70, (bm.burn?.d || 15) * 5, p.el, p.srcP, null, bm.burn); emitP(e.x, e.y, '#ff6b1a', 22, 140); doShake(10, .4); spawnFT(e.x, e.y - 22, 'üí• BOMBE!', '#ff6b1a'); }, (bm.delay || 3) * 1000); }
              // poisonZ: leave poison zone on impact
              if (p._poisonZ) fieldFx.push({ type: 'zone', x: p.x, y: p.y, t: 4, r: 45, el: p.el, dmg: 6, tick: 0, poison: { d: 7, dur: 3 }, srcP: p.srcP });
              // healMark: mark enemy so hits on it heal the attacker
              if (p._healMark && e.hp > 0) { e._healMarkT = p._healMark; e._healMarkP = p.srcP; spawnFT(e.x, e.y - 22, 'ü©∏ MARKIERT ' + p._healMark + 's', '#4ade80'); }
              // silence: block enemy attacks
              if (p._silence && e.hp > 0) { e._silenceT = Math.max(e._silenceT || 0, p._silence); spawnFT(e.x, e.y - 22, 'üîá STILLE ' + p._silence + 's', '#a855f7'); }
              // Hook: pull player to enemy on hit
              if (p._hook && p.srcP !== null && e.hp > 0) {
                const pl = players[p.srcP]; if (pl?.alive) {
                  const ddx = e.x - pl.x, ddy = e.y - pl.y, dl = Math.sqrt(ddx * ddx + ddy * ddy) || 1;
                  pl.x = clamp(e.x - ddx / dl * 55, PAD + pl.r, GW - PAD - pl.r);
                  pl.y = clamp(e.y - ddy / dl * 55, PAD + pl.r, GH - PAD - pl.r);
                  pl.iframes = .3; if (p._hookRoot) e.stunT = Math.max(e.stunT || 0, p._hookRoot);
                  spawnFT(e.x, e.y - 22, 'ü™ù HOOK!', p.color);
                }
                projs.splice(i, 1); hit = true; break;
              }
              // Swap: swap player + enemy positions
              if (p._swap && p.srcP !== null && e.hp > 0) {
                const pl = players[p.srcP]; if (pl?.alive) {
                  const ox = pl.x, oy = pl.y;
                  pl.x = clamp(e.x, PAD + pl.r, GW - PAD - pl.r); pl.y = clamp(e.y, PAD + pl.r, GH - PAD - pl.r);
                  e.x = ox; e.y = oy; pl.iframes = .5;
                  spawnFT(pl.x, pl.y - 28, 'TAUSCH!', p.color); emitP(ox, oy, p.color, 12, 80); emitP(pl.x, pl.y, p.color, 12, 80);
                }
                projs.splice(i, 1); hit = true; break;
              }
              // Root: stun enemy on hit
              if (p._rootT && e.hp > 0) {
                e.stunT = Math.max(e.stunT || 0, p._rootT);
                spawnFT(e.x, e.y - 28, 'üåø ROOT ' + p._rootT + 's', p.color);
                projs.splice(i, 1); hit = true; break;
              }
              // Teleport behind: teleport player behind enemy
              if (p._tpBehind && p.srcP !== null && e.hp > 0) {
                const pl = players[p.srcP]; if (pl?.alive) {
                  pl.x = clamp(e.x + (e.x > pl.x ? -50 : 50), PAD + pl.r, GW - PAD - pl.r);
                  pl.y = clamp(e.y + (e.y > pl.y ? -50 : 50), PAD + pl.r, GH - PAD - pl.r);
                  pl.iframes = .5; pl.critBuff = p._critBuff || 2; pl.stealthCrit = true;
                  spawnFT(pl.x, pl.y - 28, 'üó° BACKSTAB!', p.color); emitP(pl.x, pl.y, p.color, 14, 100);
                }
                projs.splice(i, 1); hit = true; break;
              }
              // Curse: apply damage-taken debuff
              if (p._curseE && e.hp > 0) {
                e._curseDR = p._curseE.dr || .5; e._curseDur = p._curseE.dur || 6;
                spawnFT(e.x, e.y - 28, '‚ò† FLUCH -' + Math.round((p._curseE.dr || .5) * 100) + '%', p.color);
                projs.splice(i, 1); hit = true; break;
              }
              if (!p.pierce) { projs.splice(i, 1); hit = true; break; }
            }
          }
        } else {
          // Enemy projs hit players AND taunt minions
          let projHit = false;
          for (const pl2 of players) {
            if (!pl2.alive || pl2.iframes > 0 || pl2.invul > 0) continue;
            if (Math.sqrt((p.x - pl2.x) ** 2 + (p.y - pl2.y) ** 2) < pl2.r + p.r) {
              hitPl(pl2, p.dmg);
              if (p.blind && pl2.alive) pl2.stunT = Math.max(pl2.stunT || 0, p.blind);
              if (p.stun && pl2.alive) pl2.stunT = Math.max(pl2.stunT || 0, p.stun);
              const idx = projs.indexOf(p); if (idx >= 0) projs.splice(idx, 1);
              projHit = true; break;
            }
          }
          if (!projHit) {
            // Also check taunt minions ‚Äî they intercept enemy projectiles
            for (const em of enemies) {
              if (!em.friendly || !em.isTaunt || em.hp <= 0) continue;
              if (Math.sqrt((p.x - em.x) ** 2 + (p.y - em.y) ** 2) < em.r + p.r) {
                em.hp -= p.dmg || 10;
                if (em.hp <= 0) { const ei = enemies.indexOf(em); if (ei >= 0) enemies.splice(ei, 1); }
                emitP(em.x, em.y, '#4ade80', 5, 50);
                const idx = projs.indexOf(p); if (idx >= 0) projs.splice(idx, 1);
                break;
              }
            }
          }
        }
      }
    }

    function updFieldFx(dt) {
      for (let i = fieldFx.length - 1; i >= 0; i--) {
        const ef = fieldFx[i]; ef.t -= dt;
        if (typeof ef.followP === 'number' && players[ef.followP]?.alive) { ef.x = players[ef.followP].x; ef.y = players[ef.followP].y; }
        if (ef.type === 'tornado') { ef.angle += dt * 5.5; ef.x += (ef.vx || 0) * dt; ef.y += (ef.vy || 0) * dt; if (ef.x < PAD + ef.r) ef.vx = Math.abs(ef.vx || 0); if (ef.x > GW - PAD - ef.r) ef.vx = -Math.abs(ef.vx || 0); if (ef.y < PAD + ef.r) ef.vy = Math.abs(ef.vy || 0); if (ef.y > GH - PAD - ef.r) ef.vy = -Math.abs(ef.vy || 0); }
        if (ef.type === 'meter') { if (ef.t <= 0) { doAoe(ef.x, ef.y, ef.r, ef.dmg, ef.el, ef.srcP, ef.stun, ef.burn, null, ef.fear, ef.blind); emitP(ef.x, ef.y, EL[ef.el]?.c || '#ff4500', 28, 155); doShake(12, .5); fieldFx.splice(i, 1); } continue; }
        if (ef.type === 'windwall') { if (ef.t <= 0) fieldFx.splice(i, 1); continue; }
        ef.tick = (ef.tick || 0) - dt;
        if (ef.tick <= 0) {
          ef.tick = .4;
          if ((ef.dmg || 0) > 0) { enemies.forEach(e => { if (e.hp <= 0) return; if (Math.sqrt((e.x - ef.x) ** 2 + (e.y - ef.y) ** 2) < (ef.r || 80) + e.r) { hitE(e, ef.dmg, ef.el, ef.srcP ?? null, ef.burn, ef.poison, ef.slow); if (ef.type === 'tornado') { e.x = clamp(e.x + (ef.x - e.x) * .06, PAD + e.r, GW - PAD - e.r); e.y = clamp(e.y + (ef.y - e.y) * .06, PAD + e.r, GH - PAD - e.r); } if (ef._pull) { e.x = clamp(e.x + (ef.x - e.x) * .12, PAD + e.r, GW - PAD - e.r); e.y = clamp(e.y + (ef.y - e.y) * .12, PAD + e.r, GH - PAD - e.r); } } }); }
          if ((ef.healTick || 0) > 0) players.forEach(pl2 => { if (pl2.alive) pl2.hp = Math.min(pl2.maxHp, pl2.hp + (ef.healTick || 0) * (pl2.healBonus || 1)); });
          if (ef.healZ) players.forEach(pl2 => { if (pl2.alive) pl2.hp = Math.min(pl2.maxHp, pl2.hp + (ef.healZ.a || 0) * (pl2.healBonus || 1)); });
        }
        if (ef.t <= 0) fieldFx.splice(i, 1);
      }
    }
    function updPillars(dt) { for (let i = pillars.length - 1; i >= 0; i--) { const p = pillars[i]; if (p.temp) { p.life -= dt; if (p.life <= 0 || (p.hp !== undefined && p.hp <= 0)) pillars.splice(i, 1); } } }
    function updParts(dt) { for (let i = parts.length - 1; i >= 0; i--) { const p = parts[i]; p.x += p.vx * dt; p.y += p.vy * dt; p.vy += 55 * dt; p.vx *= .97; p.life -= dt; if (p.life <= 0) parts.splice(i, 1); } }

    // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function spP(o) { projs.push({ life: 2.8, pierce: false, bounce: false, ...o }); }
    function emitP(x, y, c, n, spd, nx = 0, ny = 0) { for (let i = 0; i < n; i++) { const a = Math.random() * Math.PI * 2, s = spd * (.4 + Math.random() * .8), b = .26; parts.push({ x, y, vx: (Math.cos(a) * (1 - b) + nx * b) * s, vy: (Math.sin(a) * (1 - b) + ny * b) * s, life: .3 + Math.random() * .55, maxLife: .85, c, r: 1.5 + Math.random() * 2.5 }); } }
    function spawnFT(x, y, t, c, f) { floats.push({ x, y, text: t, color: c, t: 1.1, font: f || 'bold 13px Rajdhani,sans-serif' }); }
    function doShake(a, d) { shakeA = a; shakeT = d; }
    function showAnn(txt, dur) { ann = { text: txt, t: dur, max: dur }; }
    function h2r(h) { return parseInt(h.slice(1, 3), 16) + ',' + parseInt(h.slice(3, 5), 16) + ',' + parseInt(h.slice(5, 7), 16); }

    // ‚îÄ‚îÄ‚îÄ LEVEL END ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function endLevel() {
      running = false; removeListeners();
      if (!completedLevels.includes(currentLevel)) completedLevels.push(currentLevel);
      const lv = LEVELS[currentLevel]; const bd = BOSS_DEFS[lv.boss];
      showScreen('levelcomplete');
      document.getElementById('lcBossEmoji').textContent = bd.emoji;
      document.getElementById('lcTitle').textContent = bd.name + ' besiegt!';
      document.getElementById('lcBossName').textContent = lv.name.toUpperCase() + ' ‚Äî ABGESCHLOSSEN';
      document.getElementById('lcStats').innerHTML = `<div class="lc-stat"><b>${killCount}</b>Kills</div><div class="lc-stat"><b>${Math.ceil(levelTimer)}s</b>Zeit</div><div class="lc-stat"><b>${Math.ceil(Math.max(players[0]?.hp || 0, 0))}</b>HP √ºbrig P1</div>`;
      const hasNext = currentLevel < LEVELS.length - 1;
      document.getElementById('btnNext').style.display = hasNext ? 'block' : 'none';
      if (!hasNext) setTimeout(() => { showScreen('win'); document.getElementById('winsub').textContent = `Alle 7 Elemental-Bosse wurden besiegt! Du hast ${killCount} Feinde get√∂tet.`; }, 500);
    }
    function goNextLevel() { currentLevel++; startDraft(); }
    function startDraft() { showScreen('draft'); initDraft(); }
    function endGame(win) {
      running = false; removeListeners(); hideTip();
      if (win) endLevel(); else showScreen('lose');
    }

    // ‚îÄ‚îÄ‚îÄ LEVEL AMBIENT PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let lvAmbient = [];
    function updAmbient(dt) {
      const lv = LEVELS[currentLevel] || LEVELS[0];
      // Spawn ambient particles based on fxLayer
      if (Math.random() < dt * 18) {
        const fx = lv.fxLayer;
        let p = null;
        const rx = PAD + Math.random() * (GW - PAD * 2), ry = PAD + Math.random() * (GH - PAD * 2);
        if (fx === 'fireAsh') p = { x: rx, y: ry, vx: (Math.random() - .5) * 18, vy: -12 - Math.random() * 18, life: .9 + Math.random() * .6, c: '#ff6b1a', r: 1.2 + Math.random() * 1.4, fade: true };
        else if (fx === 'waterDrops') p = { x: rx, y: ry, vx: 0, vy: 22 + Math.random() * 18, life: .4 + Math.random() * .5, c: '#7dd3fc', r: 1 + Math.random() * 1.5, fade: true };
        else if (fx === 'earthDust') p = { x: rx, y: ry, vx: (Math.random() - .5) * 8, vy: -4 - Math.random() * 8, life: 1.2 + Math.random(), c: '#a16207', r: 1.5 + Math.random() * 2, fade: true };
        else if (fx === 'windLines') p = { x: PAD + Math.random() * (GW - PAD * 2), y: PAD + Math.random() * (GH - PAD * 2), vx: 55 + Math.random() * 80, vy: (Math.random() - .5) * 15, life: .18 + Math.random() * .15, c: '#bae6fd', r: 1, fade: true };
        else if (fx === 'naturePollen') p = { x: rx, y: ry, vx: (Math.random() - .5) * 12, vy: -5 - Math.random() * 10, life: 2 + Math.random() * 1.5, c: '#86efac', r: .8 + Math.random() * 1.2, fade: true };
        else if (fx === 'lightMotes') p = { x: rx, y: ry, vx: (Math.random() - .5) * 10, vy: -6 - Math.random() * 12, life: 1.5 + Math.random(), c: '#fde68a', r: 1 + Math.random() * 2, fade: true };
        else if (fx === 'shadowSmoke') p = { x: rx, y: ry, vx: (Math.random() - .5) * 8, vy: -8 - Math.random() * 12, life: 1.8 + Math.random() * 1.5, c: '#a855f7', r: 2 + Math.random() * 3, fade: true };
        if (p) lvAmbient.push(p);
      }
      for (let i = lvAmbient.length - 1; i >= 0; i--) { const p = lvAmbient[i]; p.x += p.vx * dt; p.y += p.vy * dt; p.life -= dt; if (p.life <= 0) lvAmbient.splice(i, 1); }
    }

    // ‚îÄ‚îÄ‚îÄ BREAKABLE CRATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updCrates(dt) {
      // Projectile‚Üícrate collision is in updProjs. Here we handle destroyed crates.
      for (let i = crates.length - 1; i >= 0; i--) {
        if (crates[i].hp <= 0) {
          const c = crates[i];
          emitP(c.x + 16, c.y + 16, '#a16207', 12, 80);
          // Drop loot: 40% buff orb, 30% cd, 30% hp
          const roll = Math.random();
          if (roll < 0.4) {
            const buffTypes = ['rage', 'haste', 'focus', 'vita'];
            const bt = rndFrom(buffTypes);
            const bEmojis = { rage: 'üî•', haste: '‚ö°', focus: 'üéØ', vita: 'üíö' };
            const bColors = { rage: '#ef4444', haste: '#3b82f6', focus: '#eab308', vita: '#22c55e' };
            lootOrbs.push({ x: c.x + 16, y: c.y + 16, r: 7, life: 12, type: bt });
            spawnFT(c.x + 16, c.y, bEmojis[bt], bColors[bt]);
          } else {
            lootOrbs.push({ x: c.x + 16, y: c.y + 16, r: 6, life: 10, type: roll < 0.7 ? 'cd' : 'hp' });
            spawnFT(c.x + 16, c.y, 'üíé', '#60a5fa');
          }
          crates.splice(i, 1);
        }
      }
    }
    function updLoot(dt) {
      for (let i = lootOrbs.length - 1; i >= 0; i--) {
        const o = lootOrbs[i]; o.life -= dt;
        if (o.life <= 0) { lootOrbs.splice(i, 1); continue; }
        for (const pl of players) {
          if (!pl.alive) continue;
          if (Math.sqrt((pl.x - o.x) ** 2 + (pl.y - o.y) ** 2) < pl.r + o.r + 8) {
            if (o.type === 'cd') { pl.cds.r = Math.max(0, pl.cds.r - 2); spawnFT(pl.x, pl.y - 24, 'ULTI -2s', '#60a5fa'); }
            else if (o.type === 'heal' || o.type === 'hp') { pl.hp = Math.min(pl.maxHp, pl.hp + (o.val || 15)); spawnFT(pl.x, pl.y - 24, '+' + (o.val || 15) + ' HP', '#4ade80'); }
            else if (o.type === 'shield') { pl.shield = Math.min((pl.shield || 0) + (o.val || 25), 300); spawnFT(pl.x, pl.y - 24, '+' + (o.val || 25) + ' üõ°', '#93c5fd'); }
            // ‚îÄ‚îÄ Buff orb pickups ‚îÄ‚îÄ
            else if (o.type === 'rage') { pl._rageBuff = 12; spawnFT(pl.x, pl.y - 24, 'üî• WUT +40% DMG 12s', '#ef4444'); emitP(pl.x, pl.y, '#ef4444', 12, 70); }
            else if (o.type === 'haste') { pl._hasteBuff = 12; spawnFT(pl.x, pl.y - 24, '‚ö° HAST +35% SPD 12s', '#3b82f6'); emitP(pl.x, pl.y, '#3b82f6', 12, 70); }
            else if (o.type === 'focus') { pl._focusBuff = 12; spawnFT(pl.x, pl.y - 24, 'üéØ FOKUS 2√óCDR 12s', '#eab308'); emitP(pl.x, pl.y, '#eab308', 12, 70); }
            else if (o.type === 'vita') { pl.hp = Math.min(pl.maxHp, pl.hp + 30); spawnFT(pl.x, pl.y - 24, 'üíö VITA +30 HP', '#22c55e'); emitP(pl.x, pl.y, '#22c55e', 12, 70); }
            else { pl.hp = Math.min(pl.maxHp, pl.hp + 15); spawnFT(pl.x, pl.y - 24, '+15 HP', '#4ade80'); }
            emitP(o.x, o.y, '#60a5fa', 8, 50);
            lootOrbs.splice(i, 1); break;
          }
        }
      }
    }

    // ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function rr(x, y, w, h, r) { ctx.beginPath(); ctx.moveTo(x + r, y); ctx.lineTo(x + w - r, y); ctx.quadraticCurveTo(x + w, y, x + w, y + r); ctx.lineTo(x + w, y + h - r); ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h); ctx.lineTo(x + r, y + h); ctx.quadraticCurveTo(x, y + h, x, y + h - r); ctx.lineTo(x, y + r); ctx.quadraticCurveTo(x, y, x + r, y); ctx.closePath(); }

    function render() {
      const lv = LEVELS[currentLevel] || LEVELS[0];
      const bGlow = lv.borderGlow || '#1a3a55';
      ctx.save(); ctx.translate(shakeX, shakeY);

      // ‚îÄ‚îÄ Background: element-themed gradient ‚îÄ‚îÄ
      const bgGrad = ctx.createRadialGradient(GW / 2, GH / 2, 100, GW / 2, GH / 2, GW * .7);
      bgGrad.addColorStop(0, lv.bg || '#030508');
      bgGrad.addColorStop(1, '#020204');
      ctx.fillStyle = bgGrad; ctx.fillRect(-10, -10, GW + 20, GH + 20);

      // ‚îÄ‚îÄ Grid: element accent color ‚îÄ‚îÄ
      ctx.strokeStyle = lv.gridCol || '#060f18'; ctx.lineWidth = .8; ctx.globalAlpha = .65;
      for (let x = 0; x < GW; x += 64) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, GH); ctx.stroke(); }
      for (let y = 0; y < GH; y += 64) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(GW, y); ctx.stroke(); }
      ctx.globalAlpha = 1;

      // ‚îÄ‚îÄ Ambient FX particles ‚îÄ‚îÄ
      for (const p of lvAmbient) {
        const alpha = Math.max(0, Math.min(.6, p.life * .5));
        ctx.globalAlpha = alpha; ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill();
      }
      ctx.globalAlpha = 1;

      // ‚îÄ‚îÄ Arena border glow (element themed) ‚îÄ‚îÄ
      ctx.strokeStyle = bGlow; ctx.lineWidth = 2.5; ctx.shadowColor = bGlow; ctx.shadowBlur = 22;
      ctx.globalAlpha = .55 + Math.sin(Date.now() * .0008) * .12;
      ctx.strokeRect(PAD, PAD, GW - PAD * 2, GH - PAD * 2);
      ctx.shadowBlur = 0; ctx.globalAlpha = 1;

      // Inner thin border
      ctx.strokeStyle = 'rgba(30,50,70,.8)'; ctx.lineWidth = 1; ctx.strokeRect(PAD + 2, PAD + 2, GW - PAD * 2 - 4, GH - PAD * 2 - 4);

      // ‚îÄ‚îÄ Hazard pulsing inner glow ‚îÄ‚îÄ
      if (hazardActive && activeArenaMod) {
        ctx.save();
        ctx.strokeStyle = activeArenaMod.col || '#f97316';
        ctx.lineWidth = 4;
        ctx.shadowColor = activeArenaMod.col || '#f97316';
        ctx.shadowBlur = 12 + Math.sin(Date.now() * .006) * 8;
        ctx.globalAlpha = .35 + Math.sin(Date.now() * .004) * .15;
        ctx.strokeRect(PAD + 6, PAD + 6, GW - PAD * 2 - 12, GH - PAD * 2 - 12);
        ctx.restore();
      }

      // ‚îÄ‚îÄ Corner runes ‚îÄ‚îÄ
      ctx.font = '16px serif'; ctx.textAlign = 'center'; ctx.globalAlpha = .28 + Math.sin(Date.now() * .0012) * .08;
      ctx.shadowColor = bGlow; ctx.shadowBlur = 8;
      [[PAD + 16, PAD + 22], [GW - PAD - 16, PAD + 22], [GW - PAD - 16, GH - PAD - 10], [PAD + 16, GH - PAD - 10]].forEach(([cx, cy]) => {
        ctx.fillStyle = bGlow; ctx.fillText(lv.cornerSymbol || '‚óÜ', cx, cy);
      });
      ctx.shadowBlur = 0; ctx.globalAlpha = 1; ctx.textAlign = 'left';

      // ‚îÄ‚îÄ Breakable Crates ‚îÄ‚îÄ
      for (const cr of crates) {
        ctx.save();
        const hpFrac = cr.hp / cr.maxHp;
        ctx.fillStyle = `rgb(${140 + 40 * hpFrac}, ${90 + 30 * hpFrac}, 30)`;
        ctx.shadowColor = '#a16207'; ctx.shadowBlur = 6;
        ctx.fillRect(cr.x, cr.y, cr.w, cr.h);
        // Cross detail
        ctx.strokeStyle = '#5c3813'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(cr.x, cr.y); ctx.lineTo(cr.x + cr.w, cr.y + cr.h); ctx.moveTo(cr.x + cr.w, cr.y); ctx.lineTo(cr.x, cr.y + cr.h); ctx.stroke();
        // HP bar below
        if (cr.hp < cr.maxHp) {
          ctx.fillStyle = '#111'; ctx.fillRect(cr.x, cr.y + cr.h + 2, cr.w, 3);
          ctx.fillStyle = '#ef4444'; ctx.fillRect(cr.x, cr.y + cr.h + 2, cr.w * hpFrac, 3);
        }
        ctx.restore();
      }

      // ‚îÄ‚îÄ Loot Orbs (Mana Sparks & Buff Orbs) ‚îÄ‚îÄ
      const _LOOT_COL = { cd: '#60a5fa', hp: '#4ade80', heal: '#4ade80', shield: '#93c5fd', rage: '#ef4444', haste: '#3b82f6', focus: '#eab308', vita: '#22c55e' };
      const _LOOT_EMO = { rage: 'üî•', haste: '‚ö°', focus: 'üéØ', vita: 'üíö' };
      for (const o of lootOrbs) {
        ctx.save();
        const pulse = .6 + Math.sin(Date.now() * .008) * .3;
        ctx.globalAlpha = pulse;
        const oc = _LOOT_COL[o.type] || '#4ade80';
        ctx.fillStyle = oc;
        ctx.shadowColor = oc; ctx.shadowBlur = 16;
        ctx.beginPath(); ctx.arc(o.x, o.y, o.r + Math.sin(Date.now() * .005) * 1.5, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.globalAlpha = .7;
        ctx.beginPath(); ctx.arc(o.x, o.y, o.r * .35, 0, Math.PI * 2); ctx.fill();
        // Show emoji for buff orbs
        if (_LOOT_EMO[o.type]) {
          ctx.globalAlpha = .9; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
          ctx.fillText(_LOOT_EMO[o.type], o.x, o.y - o.r - 4);
        }
        ctx.restore();
      }

      rendFx(); rendPillars(); rendProjs(); rendParts();
      enemies.forEach(e => { if (e.hp > 0) rendEnemy(e); });
      players.forEach(pl => rendPlayer(pl));
      for (const ft of floats) { ctx.save(); ctx.globalAlpha = Math.min(1, ft.t); ctx.font = ft.font; ctx.fillStyle = ft.color; ctx.textAlign = 'center'; ctx.shadowColor = ft.color; ctx.shadowBlur = 8; ctx.fillText(ft.text, ft.x, ft.y); ctx.restore(); }
      ctx.restore();
      rendHUD();
      if (ann.t > 0) { const a = Math.min(1, ann.t / (ann.max * .4)); ctx.save(); ctx.globalAlpha = a; ctx.font = 'bold 22px Cinzel,serif'; ctx.textAlign = 'center'; ctx.fillStyle = '#f4c542'; ctx.shadowColor = '#f4c542'; ctx.shadowBlur = 28; ctx.fillText(ann.text, GW / 2, GH / 2 - 18); ctx.restore(); }
      if (gamePhase === 1 && phaseCD > 0) { ctx.save(); ctx.font = 'bold 52px Cinzel,serif'; ctx.textAlign = 'center'; ctx.fillStyle = '#ef4444'; ctx.shadowColor = '#ef4444'; ctx.shadowBlur = 44; ctx.globalAlpha = .88; ctx.fillText(Math.ceil(phaseCD), GW / 2, GH / 2 + 24); ctx.restore(); }
    }

    function rendFx() {
      for (const ef of fieldFx) {
        ctx.save(); const ec = EL[ef.el]?.c || '#fff';
        if (ef.type === 'meter') {
          const pulse = .35 + Math.sin(Date.now() * .018) * .2;
          const ec2 = EL[ef.el]?.c || '#ff4500';
          // Warning fill
          ctx.globalAlpha = pulse * .28; ctx.fillStyle = ec2; ctx.beginPath(); ctx.arc(ef.x, ef.y, ef.r, 0, Math.PI * 2); ctx.fill();
          // Dashed ring
          ctx.globalAlpha = pulse; ctx.strokeStyle = ec2; ctx.shadowColor = ec2; ctx.shadowBlur = 14; ctx.lineWidth = 2.5;
          ctx.setLineDash([6, 5]); ctx.beginPath(); ctx.arc(ef.x, ef.y, ef.r, 0, Math.PI * 2); ctx.stroke(); ctx.setLineDash([]); ctx.shadowBlur = 0;
          // Countdown text
          ctx.globalAlpha = 1; ctx.font = 'bold 11px "Share Tech Mono"'; ctx.fillStyle = ec2; ctx.textAlign = 'center';
          ctx.fillText('‚ö† ' + ef.t.toFixed(1) + 's', ef.x, ef.y + 4);
        }
        else if (ef.type === 'zone' || ef.type === 'tornado') { const g = ctx.createRadialGradient(ef.x, ef.y, 0, ef.x, ef.y, ef.r || 80); g.addColorStop(0, `rgba(${h2r(ec)},.35)`); g.addColorStop(1, `rgba(${h2r(ec)},0)`); ctx.globalAlpha = .62; ctx.fillStyle = g; ctx.beginPath(); ctx.arc(ef.x, ef.y, ef.r || 80, 0, Math.PI * 2); ctx.fill(); if (ef.type === 'tornado') { for (let j = 0; j < 5; j++) { const a = (ef.angle || 0) + j * (Math.PI * 2 / 5); ctx.strokeStyle = '#ff6b1a'; ctx.lineWidth = 4; ctx.globalAlpha = .88; ctx.beginPath(); ctx.arc(ef.x, ef.y, (ef.r || 80) * .55, a, a + 1.1); ctx.stroke(); } } }
        else if (ef.type === 'windwall') { ctx.globalAlpha = .4; ctx.fillStyle = 'rgba(79,195,247,.28)'; ctx.fillRect(ef.x, ef.y, ef.w, ef.h); ctx.strokeStyle = '#4fc3f7'; ctx.lineWidth = 2; ctx.strokeRect(ef.x, ef.y, ef.w, ef.h); }
        ctx.restore();
      }
    }

    function rendPillars() {
      const lv = LEVELS[currentLevel] || LEVELS[0];
      const bossEl = lv.boss || 'fire';
      const E = EL[bossEl];
      // Element-themed color palette
      const themes = {
        fire: { base: '#2a0800', top: '#1a0500', stroke: '#ff6b1a', glow: '#ff4500', accent: '#ff8c42', detail: 'cracks' },
        water: { base: '#001825', top: '#000d18', stroke: '#42a5f5', glow: '#1e88e5', accent: '#7dd3fc', detail: 'ice' },
        earth: { base: '#1a1508', top: '#120e04', stroke: '#a3a86e', glow: '#8b9a4e', accent: '#c4b896', detail: 'stone' },
        wind: { base: '#0a1520', top: '#060e18', stroke: '#4fc3f7', glow: '#29b6f6', accent: '#b0e0f6', detail: 'swirl' },
        nature: { base: '#081a08', top: '#041204', stroke: '#4ade80', glow: '#16a34a', accent: '#86efac', detail: 'vines' },
        light: { base: '#1a1600', top: '#121000', stroke: '#fde68a', glow: '#f59e0b', accent: '#fef3c7', detail: 'shine' },
        darkness: { base: '#0a0014', top: '#06000c', stroke: '#a855f7', glow: '#7c3aed', accent: '#c4b5fd', detail: 'void' },
      };
      const th = themes[bossEl] || themes.fire;
      for (const p of pillars) {
        ctx.save();
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,.45)'; ctx.fillRect(p.x + 4, p.y + 4, p.w, p.h);
        // Element-themed gradient fill
        const isTemp = !!p.el; // player-created temp walls keep their own color
        const baseCol = isTemp ? '#182838' : th.base;
        const topCol = isTemp ? '#0c1620' : th.top;
        const strokeCol = isTemp ? (EL[p.el]?.c || '#a3a86e') : (p._el ? th.stroke : '#2a3d50');
        const g = ctx.createLinearGradient(p.x, p.y, p.x + p.w, p.y + p.h);
        g.addColorStop(0, topCol); g.addColorStop(1, baseCol); ctx.fillStyle = g;
        // Glow
        if (p._el || isTemp) { ctx.shadowColor = isTemp ? (EL[p.el]?.c || th.glow) : th.glow; ctx.shadowBlur = p._el ? 10 : 8; }
        ctx.strokeStyle = strokeCol; ctx.lineWidth = p._el ? 1.8 : (isTemp ? 2 : 1.5);
        rr(p.x, p.y, p.w, p.h, 5); ctx.fill(); rr(p.x, p.y, p.w, p.h, 5); ctx.stroke();
        ctx.shadowBlur = 0;
        // Element detail overlay
        if (p._el && !isTemp) {
          ctx.globalAlpha = .18;
          ctx.fillStyle = th.accent;
          // Inner accent lines based on element
          if (th.detail === 'cracks') {
            ctx.beginPath(); ctx.moveTo(p.x + 4, p.y + p.h * .3); ctx.lineTo(p.x + p.w * .6, p.y + p.h * .5); ctx.lineTo(p.x + p.w - 4, p.y + p.h * .7); ctx.strokeStyle = th.accent; ctx.lineWidth = 1; ctx.stroke();
          } else if (th.detail === 'ice') {
            ctx.fillRect(p.x + 2, p.y + 2, p.w * .3, p.h * .15);
            ctx.fillRect(p.x + p.w * .5, p.y + p.h * .7, p.w * .4, p.h * .15);
          } else if (th.detail === 'vines') {
            ctx.beginPath(); ctx.arc(p.x + p.w * .2, p.y + p.h * .8, 3, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(p.x + p.w * .7, p.y + p.h * .2, 2.5, 0, Math.PI * 2); ctx.fill();
          } else if (th.detail === 'shine') {
            ctx.fillRect(p.x + p.w * .1, p.y + p.h * .1, p.w * .8, p.h * .08);
          } else if (th.detail === 'void') {
            ctx.beginPath(); ctx.arc(p.x + p.w / 2, p.y + p.h / 2, Math.min(p.w, p.h) * .25, 0, Math.PI * 2); ctx.fill();
          }
          ctx.globalAlpha = 1;
        }
        // HP bar for destructible walls
        if (isTemp && p.hp !== undefined) { ctx.fillStyle = 'rgba(0,0,0,.5)'; ctx.fillRect(p.x, p.y - 5, p.w, 3); ctx.fillStyle = EL[p.el]?.c || '#fff'; ctx.fillRect(p.x, p.y - 5, p.w * (p.hp / p.maxHp), 3); }
        ctx.restore();
      }
    }

    function rendProjs() {
      for (const p of projs) {
        ctx.save();
        if (p.isFusion) { ctx.shadowColor = p.glow || p.color; ctx.shadowBlur = 34; ctx.fillStyle = p.color; ctx.globalAlpha = .95; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = '#fff'; ctx.globalAlpha = .68; ctx.beginPath(); ctx.arc(p.x, p.y, p.r * .35, 0, Math.PI * 2); ctx.fill(); }
        else { ctx.shadowColor = p.glow || p.color; ctx.shadowBlur = 12; ctx.fillStyle = p.color; ctx.globalAlpha = .88; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill(); }
        ctx.restore();
      }
    }
    function rendParts() {
      for (const p of parts) {
        ctx.save();
        if (p._ring) {
          // expanding cast ring
          const f = 1 - (p.life / p.maxLife);
          const r = p.r + f * (p._rOuter - p.r);
          ctx.globalAlpha = (p.life / p.maxLife) * .7;
          ctx.strokeStyle = p._col; ctx.shadowColor = p._col; ctx.shadowBlur = 16; ctx.lineWidth = 3;
          ctx.beginPath(); ctx.arc(p.x, p.y, r, 0, Math.PI * 2); ctx.stroke();
        } else {
          ctx.globalAlpha = (p.life / p.maxLife) * .82; ctx.fillStyle = p.c; ctx.shadowColor = p.c; ctx.shadowBlur = 5;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill();
        }
        ctx.restore();
      }
    }

    function rendEnemy(e) {
      ctx.save(); const E = EL[e.element];
      const bd = e.bossData; const phIdx = e.type === 'boss' ? getBossPhase() : 0;

      // ‚îÄ‚îÄ Friendly taunt minion: distinct green rendering ‚îÄ‚îÄ
      if (e.friendly && e.isTaunt) {
        ctx.globalAlpha = .85;
        ctx.fillStyle = '#052010'; ctx.shadowColor = '#4ade80'; ctx.shadowBlur = 18;
        ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2); ctx.fill();
        ctx.strokeStyle = '#4ade80'; ctx.lineWidth = 2.5; ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2); ctx.stroke();
        // Pulsing shield ring
        const rp = .4 + Math.sin(Date.now() * .016) * .25;
        ctx.globalAlpha = rp; ctx.strokeStyle = '#86efac'; ctx.lineWidth = 2; ctx.shadowBlur = 12;
        ctx.beginPath(); ctx.arc(e.x, e.y, e.r + 12, 0, Math.PI * 2); ctx.stroke();
        ctx.globalAlpha = 1; ctx.shadowBlur = 0;
        ctx.font = '15px serif'; ctx.textAlign = 'center'; ctx.fillText('üå≥', e.x, e.y + 5);
        ctx.font = 'bold 7px "Share Tech Mono"'; ctx.fillStyle = '#4ade80'; ctx.fillText('TREANT', e.x, e.y - e.r - 5);
        // HP bar
        const bw = e.r * 2 + 4, bh = 4;
        ctx.fillStyle = 'rgba(0,0,0,.55)'; ctx.fillRect(e.x - bw / 2, e.y + e.r + 6, bw, bh);
        const hf = Math.max(0, e.hp / e.maxHp); ctx.fillStyle = '#4ade80'; ctx.fillRect(e.x - bw / 2, e.y + e.r + 6, bw * hf, bh);
        // Lifetime bar
        const lt = e._minionTimer / 10; ctx.fillStyle = 'rgba(0,0,0,.45)'; ctx.fillRect(e.x - bw / 2, e.y + e.r + 12, bw, 3);
        ctx.fillStyle = '#86efac'; ctx.fillRect(e.x - bw / 2, e.y + e.r + 12, bw * Math.max(0, lt), 3);
        ctx.restore(); return;
      }

      const pCol = e.type === 'boss' ? (phIdx === 0 ? (bd?.color || E.c) : phIdx === 1 ? '#c026d3' : '#ef4444') : e.type === 'minion' ? E.c : E.c;
      const pGlow = e.type === 'boss' ? (phIdx === 0 ? (bd?.glow || E.g) : phIdx === 1 ? '#a21caf' : '#dc2626') : E.g;
      if (e.stunT > 0 || e.frozenT > 0) { ctx.globalAlpha = .32 + Math.sin(Date.now() * .022) * .1; ctx.fillStyle = e.frozenT > 0 ? '#90caf9' : '#f4c542'; ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 24; ctx.beginPath(); ctx.arc(e.x, e.y, e.r + 14, 0, Math.PI * 2); ctx.fill(); }
      if ((e.blindT || 0) > 0) { ctx.globalAlpha = .26; ctx.fillStyle = '#fde68a'; ctx.beginPath(); ctx.arc(e.x, e.y, e.r + 9, 0, Math.PI * 2); ctx.fill(); }
      ctx.globalAlpha = e.hitFlash > .05 ? .9 : .55; ctx.fillStyle = e.hitFlash > .05 ? '#fff' : pCol; ctx.shadowColor = e.hitFlash > .05 ? '#fff' : pGlow; ctx.shadowBlur = e.hitFlash > .05 ? 34 : 22; ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2); ctx.fill();
      ctx.globalAlpha = 1; ctx.fillStyle = pCol; ctx.shadowColor = pGlow; ctx.shadowBlur = 14; ctx.beginPath(); ctx.arc(e.x, e.y, e.r - 5, 0, Math.PI * 2); ctx.fill();
      // Spikes
      ctx.globalAlpha = .45; ctx.strokeStyle = pCol + 'cc'; ctx.lineWidth = 2;
      ctx.save(); ctx.translate(e.x, e.y); ctx.rotate(-e.angle * 1.6);
      const spks = e.type === 'boss' ? phIdx === 2 ? 9 : 6 : e.type === 'minion' ? 3 : 4;
      for (let i = 0; i < spks; i++) { const a = (i / spks) * Math.PI * 2; ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(Math.cos(a) * (e.r - 5), Math.sin(a) * (e.r - 5)); ctx.stroke(); } ctx.restore();
      ctx.globalAlpha = .82; ctx.font = (e.type === 'minion' ? '11px' : '14px') + ' serif'; ctx.textAlign = 'center'; ctx.fillText(E.e, e.x, e.y - e.r - (e.type === 'minion' ? 4 : 8));
      if (e.charging) { ctx.globalAlpha = .22 + Math.sin(Date.now() * .04) * .1; ctx.fillStyle = '#f97316'; ctx.beginPath(); ctx.arc(e.x, e.y, e.r + 30, 0, Math.PI * 2); ctx.fill(); }
      // Reflektor affix: blue pulsing shield ring
      if (e._reflektT > 0) {
        const rp = .5 + Math.sin(Date.now() * .02) * .3;
        ctx.globalAlpha = rp; ctx.strokeStyle = '#42a5f5'; ctx.shadowColor = '#42a5f5'; ctx.shadowBlur = 20; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.arc(e.x, e.y, e.r + 22, 0, Math.PI * 2); ctx.stroke();
        ctx.globalAlpha = rp * .25; ctx.fillStyle = '#42a5f5'; ctx.beginPath(); ctx.arc(e.x, e.y, e.r + 22, 0, Math.PI * 2); ctx.fill();
        ctx.globalAlpha = 1; ctx.font = 'bold 8px "Share Tech Mono"'; ctx.fillStyle = '#42a5f5'; ctx.textAlign = 'center';
        ctx.fillText('üõ° ' + e._reflektT.toFixed(1) + 's', e.x, e.y - e.r - 30); ctx.shadowBlur = 0;
      }
      // Rasend: orange speed-lines
      if (e._rasend) {
        ctx.globalAlpha = .14; ctx.strokeStyle = '#f97316'; ctx.lineWidth = 1.5;
        for (let i = 0; i < 3; i++) { const a = e.angle * .8 + i * (Math.PI * 2 / 3); ctx.beginPath(); ctx.moveTo(e.x + Math.cos(a) * (e.r + 5), e.y + Math.sin(a) * (e.r + 5)); ctx.lineTo(e.x + Math.cos(a) * (e.r + 28), e.y + Math.sin(a) * (e.r + 28)); ctx.stroke(); }
        ctx.globalAlpha = 1;
      }
      // HP bar
      const bw = e.r * 2 + 8, bh = e.type === 'boss' ? 6 : 4; ctx.globalAlpha = 1; ctx.fillStyle = 'rgba(0,0,0,.55)'; ctx.fillRect(e.x - bw / 2, e.y + e.r + 6, bw, bh); const hf = Math.max(0, e.hp / e.maxHp); ctx.fillStyle = hf > .5 ? '#4ade80' : hf > .25 ? '#f4c542' : '#f87171'; ctx.fillRect(e.x - bw / 2, e.y + e.r + 6, bw * hf, bh);
      // Status icons (horizontal under HP bar)
      const sts_ico = []; if (e.burnT > 0) sts_ico.push('üî•'); if (e.frozenT > 0) sts_ico.push('‚ùÑ'); if (e.slowT > 0) sts_ico.push('üíß'); if (e.poisonT > 0) sts_ico.push('üåø'); if ((e.blindT || 0) > 0) sts_ico.push('üëÅ'); if (e.stunT > 0) sts_ico.push('üîí'); if (e.fearT > 0) sts_ico.push('üëª');
      ctx.font = '8px serif'; ctx.textAlign = 'center';
      sts_ico.forEach((s, i) => ctx.fillText(s, e.x - (sts_ico.length - 1) * 5 + i * 10, e.y + e.r + 18));
      // Boss: phase markers on HP bar
      if (e.type === 'boss') { [.67, .33].forEach(f => { ctx.strokeStyle = 'rgba(244,197,66,.55)'; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(e.x - bw / 2 + bw * f, e.y + e.r + 4); ctx.lineTo(e.x - bw / 2 + bw * f, e.y + e.r + 12); ctx.stroke(); }); }
      ctx.restore();
    }

    function rendPlayer(pl) {
      if (!pl.alive) return;
      const lo = loadouts[pl.id]; if (!lo) return;
      ctx.save();
      let baseAlpha = 1;
      if (pl.stealthOn) baseAlpha = .18;
      else if (pl.invul > 0) baseAlpha = .68 + Math.sin(Date.now() * .04) * .3;
      else if (pl.iframes > 0 && Math.floor(Date.now() / 80) % 2 === 0) baseAlpha = .25;
      ctx.globalAlpha = baseAlpha;

      const eA = EL[lo.elemA], eB = EL[lo.elemB], eSoul = EL[lo.soul || lo.elemA];
      const ac = lo.activeEl === 'A' ? eA : eB;

      // ‚îÄ‚îÄ Soul aura (outermost slow-rotating ring) ‚îÄ‚îÄ
      ctx.save(); ctx.globalAlpha = baseAlpha * (.18 + Math.sin(Date.now() * .0014) * .06);
      ctx.strokeStyle = eSoul.c; ctx.shadowColor = eSoul.c; ctx.shadowBlur = 18; ctx.lineWidth = 3;
      ctx.save(); ctx.translate(pl.x, pl.y); ctx.rotate(Date.now() * .0006 * (pl.id === 0 ? 1 : -1));
      ctx.setLineDash([8, 5]); ctx.beginPath(); ctx.arc(0, 0, pl.r + 20, 0, Math.PI * 2); ctx.stroke();
      ctx.setLineDash([]); ctx.restore(); ctx.restore();

      // ‚îÄ‚îÄ Elem B glow ring ‚îÄ‚îÄ
      ctx.globalAlpha = baseAlpha * .18; ctx.fillStyle = eB.c; ctx.shadowColor = eB.g; ctx.shadowBlur = 22;
      ctx.beginPath(); ctx.arc(pl.x, pl.y, pl.r + 11, 0, Math.PI * 2); ctx.fill();
      // ‚îÄ‚îÄ Elem A glow ‚îÄ‚îÄ
      ctx.globalAlpha = baseAlpha * .55; ctx.fillStyle = eA.c; ctx.shadowColor = eA.g; ctx.shadowBlur = 18;
      ctx.beginPath(); ctx.arc(pl.x, pl.y, pl.r + 4, 0, Math.PI * 2); ctx.fill();
      // ‚îÄ‚îÄ Active element core ‚îÄ‚îÄ
      ctx.globalAlpha = baseAlpha; ctx.fillStyle = ac.c; ctx.shadowColor = ac.g; ctx.shadowBlur = 16;
      ctx.beginPath(); ctx.arc(pl.x, pl.y, pl.r, 0, Math.PI * 2); ctx.fill();
      // ‚îÄ‚îÄ White centre ‚îÄ‚îÄ
      ctx.fillStyle = '#fff'; ctx.shadowBlur = 5; ctx.globalAlpha = baseAlpha * .6;
      ctx.beginPath(); ctx.arc(pl.x, pl.y, pl.r * .28, 0, Math.PI * 2); ctx.fill();

      // ‚îÄ‚îÄ Stun indicator ‚îÄ‚îÄ
      if ((pl.stunT || 0) > 0) {
        ctx.globalAlpha = .45 + Math.sin(Date.now() * .025) * .15;
        ctx.strokeStyle = '#f4c542'; ctx.shadowColor = '#f4c542'; ctx.shadowBlur = 20; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(pl.x, pl.y, pl.r + 15, 0, Math.PI * 2); ctx.stroke();
        ctx.globalAlpha = 1; ctx.font = 'bold 10px "Share Tech Mono"'; ctx.fillStyle = '#f4c542';
        ctx.textAlign = 'center'; ctx.fillText('üîí' + pl.stunT.toFixed(1), pl.x, pl.y - pl.r - 20);
      }
      // ‚îÄ‚îÄ Invul ring ‚îÄ‚îÄ
      if (pl.invul > 0) { ctx.globalAlpha = .5; ctx.strokeStyle = '#fde68a'; ctx.lineWidth = 3; ctx.shadowColor = '#fde68a'; ctx.shadowBlur = 14; ctx.setLineDash([4, 3]); ctx.beginPath(); ctx.arc(pl.x, pl.y, pl.r + 12, 0, Math.PI * 2); ctx.stroke(); ctx.setLineDash([]); }
      // ‚îÄ‚îÄ Shield ring ‚îÄ‚îÄ
      if (pl.shield > 0) { ctx.globalAlpha = .55; ctx.strokeStyle = '#42a5f5'; ctx.lineWidth = 3.5; ctx.shadowColor = '#42a5f5'; ctx.shadowBlur = 12; ctx.beginPath(); ctx.arc(pl.x, pl.y, pl.r + 7, 0, Math.PI * 2); ctx.stroke(); }
      // ‚îÄ‚îÄ Aim line (P1 only) ‚îÄ‚îÄ
      if (pl.id === 0) { const { nx, ny } = aV(0); ctx.globalAlpha = .24; ctx.strokeStyle = ac.c; ctx.lineWidth = 1.5; ctx.setLineDash([4, 5]); ctx.beginPath(); ctx.moveTo(pl.x + nx * (pl.r + 5), pl.y + ny * (pl.r + 5)); ctx.lineTo(pl.x + nx * (pl.r + 22), pl.y + ny * (pl.r + 22)); ctx.stroke(); ctx.setLineDash([]); }
      // ‚îÄ‚îÄ Charge bar ‚îÄ‚îÄ
      if (pl.chargeHeld && pl.chargeT > 0) { const cf = Math.min(1, pl.chargeT / 1.5); ctx.globalAlpha = 1; ctx.fillStyle = 'rgba(0,0,0,.65)'; ctx.fillRect(pl.x - 34, pl.y - pl.r - 14, 68, 6); ctx.fillStyle = ac.c; ctx.shadowColor = ac.c; ctx.shadowBlur = 8; ctx.fillRect(pl.x - 34, pl.y - pl.r - 14, 68 * cf, 6); }
      // ‚îÄ‚îÄ Status Emojis below player ‚îÄ‚îÄ
      const psts = []; if (pl.burnT > 0) psts.push('üî•'); if (pl.poisonT > 0) psts.push('üåø'); if (pl.stunT > 0) psts.push('üîí'); if (pl.shield > 0) psts.push('üõ°'); if (pl.stealthOn) psts.push('üëª');
      if (psts.length > 0) { ctx.globalAlpha = 1; ctx.font = '10px serif'; ctx.textAlign = 'center'; psts.forEach((s, i) => ctx.fillText(s, pl.x - (psts.length - 1) * 6 + i * 12, pl.y + pl.r + 12)); }
      // ‚îÄ‚îÄ Dash CD arc around feet ‚îÄ‚îÄ
      const dashMax = .6; // base dash CD
      const dashCur = pl.cds.dash || 0;
      if (dashCur > 0) {
        const frac = dashCur / dashMax;
        ctx.globalAlpha = .45; ctx.strokeStyle = '#4fc3f7'; ctx.lineWidth = 2.5;
        ctx.shadowColor = '#4fc3f7'; ctx.shadowBlur = 6;
        ctx.beginPath(); ctx.arc(pl.x, pl.y, pl.r + 5, -Math.PI / 2, -Math.PI / 2 + Math.PI * 2 * frac); ctx.stroke();
        ctx.shadowBlur = 0;
      }
      ctx.restore();
    }

    function rendHUD() {
      ctx.save();
      const lv = LEVELS[currentLevel];
      const lvEl = EL[lv.boss] || EL.fire;   // level element accent colour
      const acCol = lvEl.c;

      // ‚îÄ‚îÄ Darkness mod vignette ‚îÄ‚îÄ
      if (activeArenaMod?.id === 'darkmod' && gamePhase === 2) {
        const cx = players[0]?.x || GW / 2, cy = players[0]?.y || GH / 2;
        const grad = ctx.createRadialGradient(cx, cy, 90, cx, cy, GW * .62);
        grad.addColorStop(0, 'rgba(0,0,0,0)');
        grad.addColorStop(1, 'rgba(0,0,0,.88)');
        ctx.fillStyle = grad; ctx.fillRect(0, 0, GW, GH);
        // small icon
        ctx.font = 'bold 9px "Share Tech Mono"'; ctx.fillStyle = '#a855f7'; ctx.textAlign = 'right'; ctx.globalAlpha = .55;
        ctx.fillText('üåë DUNKELHEIT', GW - PAD - 4, GH - 75); ctx.globalAlpha = 1;
      }

      // ‚îÄ‚îÄ Arena mod banner (top-right small) ‚îÄ‚îÄ
      if (activeArenaMod && gamePhase >= 1) {
        const mc = activeArenaMod;
        const bx = GW - PAD - 160, by = PAD + 12;
        ctx.fillStyle = 'rgba(4,10,20,.78)'; rr(bx - 4, by - 12, 164, 16, 4); ctx.fill();
        ctx.strokeStyle = mc.col + '55'; ctx.lineWidth = 1; rr(bx - 4, by - 12, 164, 16, 4); ctx.stroke();
        ctx.font = 'bold 9px "Share Tech Mono"'; ctx.fillStyle = mc.col; ctx.textAlign = 'right'; ctx.shadowColor = mc.col; ctx.shadowBlur = 6;
        ctx.fillText(mc.emoji + ' ' + mc.name.toUpperCase(), GW - PAD - 4, by); ctx.shadowBlur = 0; ctx.globalAlpha = 1;
      }

      // ‚îÄ‚îÄ Affix banners (top-right, below arena mod) ‚îÄ‚îÄ
      activeAffixes.forEach((af, i) => {
        const by2 = PAD + 26 + i * 14;
        const bx2 = GW - PAD - 160;
        ctx.fillStyle = 'rgba(4,10,20,.72)'; rr(bx2 - 4, by2 - 12, 164, 14, 4); ctx.fill();
        ctx.font = 'bold 9px "Share Tech Mono"'; ctx.fillStyle = af.col; ctx.textAlign = 'right'; ctx.shadowColor = af.col; ctx.shadowBlur = 5;
        ctx.fillText(af.emoji + ' ' + af.name.toUpperCase(), GW - PAD - 4, by2); ctx.shadowBlur = 0; ctx.globalAlpha = 1;
      });

      // ‚îÄ‚îÄ Boss HP bar (top-center) ‚îÄ‚îÄ
      const boss = enemies.find(e => e.type === 'boss');
      if (boss && gamePhase === 2) {
        const bd = boss.bossData; const phIdx = getBossPhase();
        const BW = 420, BH = 18, BX = (GW - BW) / 2, BY = PAD + 2;
        ctx.fillStyle = 'rgba(4,10,20,.85)'; rr(BX - 2, BY - 2, BW + 4, BH + 4, 5); ctx.fill();
        ctx.strokeStyle = acCol + '44'; ctx.lineWidth = 1; rr(BX - 2, BY - 2, BW + 4, BH + 4, 5); ctx.stroke();
        const bf = Math.max(0, boss.hp / boss.maxHp);
        const bc = phIdx === 0 ? (bd?.color || acCol) : phIdx === 1 ? '#c026d3' : '#ef4444';
        ctx.fillStyle = bc; ctx.shadowColor = bc; ctx.shadowBlur = 14;
        if (bf > 0) { rr(BX, BY, BW * bf, BH, 4); ctx.fill(); } ctx.shadowBlur = 0;
        // Reflektor highlight
        if (boss._reflektT > 0) { ctx.fillStyle = 'rgba(66,165,245,.25)'; rr(BX, BY, BW, BH, 4); ctx.fill(); ctx.strokeStyle = '#42a5f5'; ctx.lineWidth = 2; ctx.shadowColor = '#42a5f5'; ctx.shadowBlur = 12; rr(BX, BY, BW, BH, 4); ctx.stroke(); ctx.shadowBlur = 0; }
        [.67, .33].forEach(f => { ctx.strokeStyle = 'rgba(244,197,66,.35)'; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(BX + BW * f, BY - 3); ctx.lineTo(BX + BW * f, BY + BH + 3); ctx.stroke(); });
        ctx.font = 'bold 10px "Share Tech Mono"'; ctx.textAlign = 'center'; ctx.fillStyle = '#d0dce8';
        ctx.fillText(bd?.emoji + ' ' + bd?.name + '  ' + Math.max(0, Math.ceil(boss.hp)) + '/' + boss.maxHp, GW / 2, BY + 12);
        const pLbl = ['P1', 'P2 ‚Äî ‚ö°AGGRO', 'P3 ‚Äî üî•ENRAGE'];
        ctx.font = 'bold 9px Rajdhani'; ctx.fillStyle = bc; ctx.fillText(pLbl[phIdx], GW / 2, BY + BH + 13);
        const sts = []; if (boss.stunT > 0) sts.push({ t: 'STUN', c: '#f4c542' }); if (boss.frozenT > 0) sts.push({ t: 'FROST', c: '#90caf9' }); if (boss.slowT > 0) sts.push({ t: 'SLOW', c: '#4fc3f7' }); if (boss.burnT > 0) sts.push({ t: 'BURN', c: '#ff6b1a' }); if (boss.poisonT > 0) sts.push({ t: 'GIFT', c: '#4ade80' }); if (boss._reflektT > 0) sts.push({ t: 'REFLECT', c: '#42a5f5' });
        sts.forEach((s, i) => { ctx.font = '7px "Share Tech Mono"'; ctx.fillStyle = s.c; ctx.textAlign = 'center'; ctx.fillText(s.t, BX + i * 55 + 28, BY + BH + 25); });
      }

      // ‚îÄ‚îÄ Guardian tracker ‚îÄ‚îÄ
      if (gamePhase < 2) {
        const gs = enemies.filter(e => e.type === 'guardian');
        ctx.font = 'bold 11px Rajdhani'; ctx.textAlign = 'center'; ctx.fillStyle = acCol; ctx.shadowColor = acCol; ctx.shadowBlur = 8;
        ctx.fillText(lv.emoji + ' ' + lv.name + ' ‚Äî W√ÑCHTER ' + gs.filter(e => e.hp <= 0).length + '/' + gs.length + (gamePhase === 1 ? ' ‚Äî BOSS IN ' + Math.ceil(phaseCD) + 's!' : ''), GW / 2, PAD + 18);
        ctx.shadowBlur = 0;
      }
      const mc2 = enemies.filter(e => e.type === 'minion' && e.hp > 0).length;
      if (mc2 > 0) { ctx.font = 'bold 9px Rajdhani'; ctx.textAlign = 'center'; ctx.fillStyle = '#ef4444'; ctx.fillText('‚ö† MINIONS: ' + mc2, GW / 2, PAD + 32); }

      // ‚îÄ‚îÄ Level tag ‚îÄ‚îÄ
      ctx.font = 'bold 8px "Share Tech Mono"'; ctx.textAlign = 'left'; ctx.fillStyle = acCol + '66';
      ctx.fillText('LV ' + (currentLevel + 1) + '/7 ' + lv.emoji + lv.name.toUpperCase(), PAD + 4, PAD + 18);

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PLAYER HUD PANELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Layout: HP panel top-left/top-right, skill icons bottom-left/bottom-right
      const SKW = 68, SKH = 58, SKG = 6;
      const HPW = 350, HPH = 10;

      players.forEach(pl => {
        if (!pl.alive) {
          ctx.save(); ctx.font = 'bold 20px Cinzel,serif'; ctx.textAlign = 'center';
          ctx.fillStyle = '#f87171'; ctx.shadowColor = '#f87171'; ctx.shadowBlur = 22;
          ctx.fillText('P' + (pl.id + 1) + ' GEFALLEN', pl.id === 0 ? 200 : GW - 200, GH / 2 - 40);
          ctx.restore(); return;
        }
        const lo = loadouts[pl.id]; if (!lo) return;
        const isLeft = pl.id === 0;
        const hpX = isLeft ? PAD : GW - PAD - HPW;
        const hpY = PAD + 38;
        const sbX = isLeft ? PAD : GW - PAD - (6 * (SKW + SKG) - SKG);
        const sbY = GH - SKH - 10;

        const eA = EL[lo.elemA], eB = EL[lo.elemB], eSoul = EL[lo.soul || lo.elemA];

        // ‚îÄ‚îÄ HP background ‚îÄ‚îÄ
        ctx.fillStyle = 'rgba(4,10,20,.82)'; rr(hpX - 2, hpY - 2, HPW + 4, HPH + 4, 4); ctx.fill();
        ctx.strokeStyle = acCol + '33'; ctx.lineWidth = 1; rr(hpX - 2, hpY - 2, HPW + 4, HPH + 4, 4); ctx.stroke();
        // ‚îÄ‚îÄ HP fill ‚îÄ‚îÄ
        const pf = Math.max(0, pl.hp / pl.maxHp);
        const pc = pf > .5 ? '#4ade80' : pf > .25 ? '#f4c542' : '#f87171';
        ctx.fillStyle = pc; ctx.shadowColor = pc; ctx.shadowBlur = 10;
        if (pf > 0) { rr(hpX, hpY, HPW * pf, HPH, 4); ctx.fill(); } ctx.shadowBlur = 0;
        // ‚îÄ‚îÄ HP text ‚îÄ‚îÄ
        ctx.font = 'bold 9px "Share Tech Mono"'; ctx.fillStyle = '#c0ccd8';
        ctx.textAlign = isLeft ? 'left' : 'right';
        ctx.fillText('P' + (pl.id + 1) + '  ‚ù§ ' + Math.max(0, Math.ceil(pl.hp)) + '/' + pl.maxHp + (pl.shield > 0 ? '  üõ°' + Math.ceil(pl.shield) : ''), isLeft ? hpX : hpX + HPW, hpY - 3);

        // ‚îÄ‚îÄ Element strip (A | B | Soul) ‚îÄ‚îÄ
        const elStripY = hpY + HPH + 8;
        const elems = [
          { e: eA, lbl: 'A', active: lo.activeEl === 'A' },
          { e: eB, lbl: 'B', active: lo.activeEl === 'B' },
          { e: eSoul, lbl: '‚ú¶', active: false, isSoul: true },
        ];
        const eW = 42, eH = 22, eGap = 4;
        const totalEW = 3 * (eW + eGap) - eGap;
        const eStartX = isLeft ? hpX : (hpX + HPW - totalEW);
        elems.forEach((el, i) => {
          const ex = eStartX + i * (eW + eGap), ey = elStripY;
          const alpha = el.active ? .88 : el.isSoul ? .55 : .28;
          ctx.globalAlpha = alpha;
          ctx.fillStyle = el.e.c + '22'; rr(ex, ey, eW, eH, 4); ctx.fill();
          ctx.strokeStyle = el.e.c + (el.active ? 'cc' : el.isSoul ? '66' : '33'); ctx.lineWidth = el.active ? 2 : 1;
          if (el.active) { ctx.shadowColor = el.e.c; ctx.shadowBlur = 8; }
          rr(ex, ey, eW, eH, 4); ctx.stroke(); ctx.shadowBlur = 0;
          ctx.globalAlpha = 1;
          ctx.font = '12px serif'; ctx.textAlign = 'center'; ctx.fillText(el.e.e, ex + eW / 2, ey + 13);
          ctx.font = 'bold 7px "Share Tech Mono"'; ctx.fillStyle = el.active ? el.e.c : el.isSoul ? el.e.c + 'aa' : '#3a5060';
          ctx.fillText(el.isSoul ? 'SOUL' : el.lbl + (el.active ? '‚óÄ' : ''), ex + eW / 2, ey + eH - 3);
        });
        ctx.globalAlpha = 1;

        // ‚îÄ‚îÄ Passive indicator (below element strip) ‚îÄ‚îÄ
        const pass = lo.passive;
        if (pass) {
          const passY = elStripY + eH + 5;
          const passX = isLeft ? hpX : (hpX + HPW);
          const passEl = EL[pass.element] || EL[lo.soul] || EL.fire;
          ctx.font = 'bold 8px "Share Tech Mono"';
          ctx.fillStyle = passEl.c; ctx.shadowColor = passEl.c; ctx.shadowBlur = 6;
          ctx.textAlign = isLeft ? 'left' : 'right';
          ctx.fillText('‚ú¶ ' + pass.name + ': ' + pass.synergy, passX, passY);
          ctx.shadowBlur = 0;
        }

        // ‚îÄ‚îÄ Stealth / status text ‚îÄ‚îÄ
        if (pl.stealthOn) {
          ctx.font = 'bold 8px "Share Tech Mono"'; ctx.fillStyle = '#a855f7'; ctx.shadowColor = '#a855f7'; ctx.shadowBlur = 8;
          ctx.textAlign = isLeft ? 'left' : 'right';
          ctx.fillText('üëª STEALTH' + (pl.stealthCrit ? ' KRIT' : ''), isLeft ? hpX : hpX + HPW, elStripY + eH + 12);
          ctx.shadowBlur = 0;
        }

        // ‚îÄ‚îÄ Active Buff indicators ‚îÄ‚îÄ
        const buffs = [];
        if (pl._rageBuff > 0) buffs.push({ e: 'üî•', lbl: 'WUT', t: pl._rageBuff, c: '#ef4444' });
        if (pl._hasteBuff > 0) buffs.push({ e: '‚ö°', lbl: 'HAST', t: pl._hasteBuff, c: '#3b82f6' });
        if (pl._focusBuff > 0) buffs.push({ e: 'üéØ', lbl: 'CDR', t: pl._focusBuff, c: '#eab308' });
        if (buffs.length > 0) {
          const buffY = hpY + HPH + 58;
          const bStartX = isLeft ? hpX : (hpX + HPW - buffs.length * 52 + 8);
          buffs.forEach((b, bi) => {
            const bx = bStartX + bi * 52;
            ctx.fillStyle = b.c + '22'; rr(bx, buffY, 48, 14, 3); ctx.fill();
            ctx.strokeStyle = b.c + '66'; ctx.lineWidth = 1; rr(bx, buffY, 48, 14, 3); ctx.stroke();
            ctx.font = 'bold 8px "Share Tech Mono"'; ctx.fillStyle = b.c; ctx.textAlign = 'center';
            ctx.fillText(b.e + ' ' + Math.ceil(b.t) + 's', bx + 24, buffY + 10);
          });
        }

        // ‚îÄ‚îÄ SKILL ICONS (bottom, no overlap with HP) ‚îÄ‚îÄ
        const ulti = getUlti(pl.id);
        const ultiSk = ulti ? { name: ulti.name, cd: ulti.cd, element: ulti.element, tags: ulti.tags, desc: ulti.desc, status: null, synergy: null, _raw: ulti._raw, _fb: ulti._fb } : null;
        const bars = [
          { sk: lo.activeEl === 'A' ? lo.lmbA : lo.lmbB, key: 'lmb', lbl: isLeft ? 'LMB' : 'U', badge: EL[curEl(pl.id)].e },
          { sk: lo.activeEl === 'A' ? lo.rmbA : lo.rmbB, key: 'rmb', lbl: isLeft ? 'RMB' : 'O', badge: EL[curEl(pl.id)].e },
          { sk: lo.qSkill, key: 'q', lbl: isLeft ? 'Q' : '1', badge: eA.e },
          { sk: lo.eSkill, key: 'e', lbl: isLeft ? 'E' : '2', badge: eB.e },
          { sk: ultiSk, key: 'r', lbl: isLeft ? 'R' : '3', badge: ulti ? EL[ulti.element]?.e || '‚ö°' : '‚ö°' },
          { sk: { name: 'Dash', cd: .6, element: lo.elemA }, key: 'dash', lbl: isLeft ? 'SPACE' : 'SHIFT', badge: 'üí®' },
        ];
        bars.forEach(({ sk, key, lbl, badge }, i) => {
          if (!sk) return;
          const bx = sbX + i * (SKW + SKG), by = sbY;
          const skEl = sk.element || lo.elemA;
          const ec = (EL[skEl] || EL.fire).c;
          const cdN = pl.cds[key] || 0, cdMax = sk.cd || 1, frac = Math.min(1, cdN / cdMax);
          // bg
          ctx.fillStyle = 'rgba(4,10,20,.88)'; rr(bx, by, SKW, SKH, 6); ctx.fill();
          // ready glow pulse
          if (frac === 0) { ctx.globalAlpha = .08 + Math.sin(Date.now() * .006) * .05; ctx.fillStyle = ec; rr(bx, by, SKW, SKH, 6); ctx.fill(); ctx.globalAlpha = 1; }
          // border ‚Äì level-element accent for R key, else skill element
          const borderCol = key === 'r' ? acCol : ec;
          ctx.strokeStyle = borderCol; ctx.lineWidth = key === 'r' ? 2 : 1.5; ctx.globalAlpha = frac > 0 ? .12 : .5;
          if (key === 'r' && frac === 0) { ctx.shadowColor = acCol; ctx.shadowBlur = 10; }
          rr(bx, by, SKW, SKH, 6); ctx.stroke(); ctx.shadowBlur = 0; ctx.globalAlpha = 1;
          // cooldown overlay
          if (frac > 0) {
            ctx.save(); ctx.beginPath(); rr(bx, by, SKW, SKH * frac, 6); ctx.clip();
            ctx.fillStyle = 'rgba(0,0,0,.72)'; ctx.fillRect(bx, by, SKW, SKH); ctx.restore();
            ctx.font = 'bold 11px "Share Tech Mono"'; ctx.fillStyle = '#4a5a6a'; ctx.textAlign = 'center'; ctx.fillText(cdN.toFixed(1), bx + SKW / 2, by + SKH / 2 + 4);
          }
          // Charge fill bar
          if (key === 'rmb' && pl.chargeHeld) { const cf = Math.min(1, pl.chargeT / 1.5); ctx.fillStyle = ec; ctx.globalAlpha = .55; ctx.fillRect(bx + 2, by + SKH - 6, Math.max(0, (SKW - 4) * cf), 4); ctx.globalAlpha = 1; }
          // icon
          ctx.font = '17px serif'; ctx.textAlign = 'center'; ctx.fillText(badge, bx + SKW / 2, by + 30);
          // key label
          ctx.font = '7px "Share Tech Mono"'; ctx.fillStyle = frac > 0 ? '#2a3a4a' : '#4a6070'; ctx.fillText(lbl, bx + SKW / 2, by + 10);
          // skill name
          const nm = (sk.name || '‚Äî').length > 9 ? (sk.name || '‚Äî').slice(0, 8) + '‚Ä¶' : sk.name || '‚Äî';
          ctx.font = 'bold 8px Rajdhani'; ctx.fillStyle = frac > 0 ? '#1a2a38' : ec;
          ctx.fillText(nm, bx + SKW / 2, by + SKH - 5);
          // ULTI label
          if (key === 'r') {
            ctx.font = 'bold 6px "Share Tech Mono"';
            ctx.fillStyle = frac > 0 ? '#1a2a38' : acCol;
            const ultiObj = getUlti(pl.id);
            ctx.fillText(ultiObj?._raw ? 'FUSION' : 'OVERDRIVE', bx + SKW / 2, by + SKH - 15);
          }
        });
      });
      ctx.restore();
    }

    // ‚îÄ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function checkTip(e) {
      if (!running || !loadouts[0]) return; const r = cv.getBoundingClientRect(); const px = e.clientX - r.left, py = e.clientY - r.top;
      const SKW = 68, SKH = 58, SKG = 6;
      for (let p = 0; p < players.length; p++) {
        if (!loadouts[p] || !players[p]?.alive) continue;
        const lo = loadouts[p]; const pl = players[p];
        const ulti = getUlti(p);
        const fsk = ulti ? { name: ulti.name, cd: ulti.cd || 18, element: ulti.element, tags: ulti.tags || ['ULTI'], desc: ulti.desc, status: null, synergy: 'Nutze wenn bereit!' } : null;
        const slots = [lo.activeEl === 'A' ? lo.lmbA : lo.lmbB, lo.activeEl === 'A' ? lo.rmbA : lo.rmbB, lo.qSkill, lo.eSkill, fsk];
        const sbX = p === 0 ? PAD : GW - PAD - (5 * (SKW + SKG) - SKG);
        const sbY = GH - SKH - 10;
        for (let i = 0; i < 5; i++) { if (px >= sbX + i * (SKW + SKG) && px <= sbX + i * (SKW + SKG) + SKW && py >= sbY && py <= sbY + SKH) { showTip(slots[i], e.clientX, e.clientY); return; } }
        // ‚îÄ‚îÄ Passive Tooltip: check element strip ‚îÄ‚îÄ
        const isLeft = p === 0;
        const eW = 42, eGap = 4, totalEW = 134, hpX = isLeft ? PAD : GW - PAD - 350, elStripY = PAD + 38 + 10 + 8;
        const eStartX = isLeft ? hpX : (hpX + 350 - totalEW);
        const sx = eStartX + 2 * (eW + eGap), sy = elStripY; // Soul icon is index 2
        if (px >= sx && px <= sx + eW && py >= sy && py <= sy + 22) { showTip(lo.passive, e.clientX, e.clientY); return; }
      }
      hideTip();
    }
    function showTip(sk, ex, ey) {
      if (!sk) return; const E = EL[sk.element] || EL.fire;
      const tags = (sk.tags || []).map(t => `<span class="tg" style="background:${E.c}18;color:${E.c};border:1px solid ${E.c}44">${t}</span>`).join('');
      const stats = `${sk.dmg > 0 ? `<div class="tv">‚öî <b>${sk.dmg}</b></div>` : ''}${sk.cd > 0 ? `<div class="tv">‚è± <b>${sk.cd}s</b></div>` : ''}`;
      document.getElementById('tip').innerHTML = `<div class="tn">${sk.name}</div><div class="tm">${E.e} ${E.n.toUpperCase()}</div><div class="tt2">${tags}</div><div class="ts2">${stats}</div><div class="tdiv"></div><div class="td">${sk.desc || ''}</div>${sk.status ? `<div class="tst">üìç ${sk.status}</div>` : ''}${sk.synergy ? `<div class="tsy">‚ö° ${sk.synergy}</div>` : ''}`;
      const tip = document.getElementById('tip'); tip.classList.add('on'); tip.style.left = Math.max(4, ex - 244) + 'px'; tip.style.top = Math.max(4, ey - tip.offsetHeight - 14) + 'px';
    }
    function hideTip() { document.getElementById('tip').classList.remove('on'); }
    window.addEventListener('load', () => showScreen('menu'));
  </script>
</body>

</html>
